//
//  ECRMoreBooksViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/8/30.
//  Copyright ¬© 2017Âπ¥ lee. All rights reserved.
//

#import "ECRMoreBooksViewController.h"
#import "ECRSortTableViewController.h"
#import "ECRMoreBooksCell.h"
#import "ECRBookListModel.h"
#import "ECRClassSortModel.h"
#import "ECRHomeSortModel.h"
#import "UIView+Extension.h"
#import "ECRBookClassSortHeader.h"
#import "ECRSearchTitleView.h"

@interface ECRMoreBooksViewController ()<
ECRSearchTitleViewDelegate,
ECRBookClassSortHeaderDelegate,
ECRSortTableViewControllerDelegate
>
@property (strong,nonatomic) UIView *filterView;
@property (strong,nonatomic) NSArray *array;
@property (strong,nonatomic) UITableView *tableView;
@property (strong,nonatomic) ECRSortTableViewController *stvc;
@property (strong,nonatomic) UIView *originalTitleView;// ÂéüÂßãtitle view

@end

@implementation ECRMoreBooksViewController

static NSString *reuserID       = @"ECRMoreBooksCell";
static NSString *rHeadID = @"ECRBookClassSortHeader";
static CGFloat filterHeight;// Á≠õÈÄâÊù°‰ª∂È´òÂ∫¶
static CGFloat filterCellH      = 40;// MARK: Á≠õÈÄâÊù°‰ª∂Ë°åÈ´ò,‰∏¥Êó∂ÂÄº40
static CGFloat listCellH        = 150;// ÂõæÁ§∫ÂàóË°®cellÈ´òÂ∫¶
static CGFloat navH             = 0;// 64 -> 0
static CGFloat sortCellH2 = 40;// MARK: ÈîÄÈáè,‰ª∑Ê†º,Â•ΩËØÑ,Ë°åÈ´ò

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    [self loadNewData];
}

- (void)loadNewData{
    // test
    NSInteger count = arc4random_uniform(20) + 10;
    NSMutableArray *arrM = [NSMutableArray arrayWithCapacity:10];
    for (NSInteger i = 0; i < count; ++i) {
        ECRBookListModel *model = [[ECRBookListModel alloc] init];
        model.coverPhoto = @"http://img3m0.ddimg.cn/15/25/25112850-1_u_8.jpg";
        model.bookName = [NSString stringWithFormat:@"ÊµãËØï%ld",i];
        model.author = @"Êµ∑ÊòéÂ®Å";
        model.synopsis = @"ÂìàÂìàÂìàÂìàÂìàÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÂìàÂìàÂìàÂìàÂìàÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñÊàñ";
        model.money = arc4random_uniform(100) + arc4random_uniform(100) * 0.01;
        
        [arrM addObject:model];
    }
    _array = arrM.copy;
    [self.tableView.mj_header endRefreshing];
    [self.tableView reloadData];
}
#pragma mark - ECRSearchTitleViewDelegate
- (void)stViewClose:(ECRSearchTitleView *)view{
    [self endSearching];
}
- (void)stView:(ECRSearchTitleView *)view content:(NSString *)content{
    // MARK: Ê†πÊçÆcontent ÂºÄÂßãÊêúÁ¥¢
    
}

#pragma mark - ECRSortTableViewControllerDelegate
- (void)stbController:(ECRSortTableViewController *)controller classModel:(ECRClassSortModel *)classModel{
    _bookListType = classModel.classType.integerValue;
    [self reloadFilterView];
}

#pragma mark - table view delegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return _array.count ? _array.count : 0;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    return [self reTable:tableView cellForRowAtIndexPath:indexPath];
}

- (UITableViewCell *)reTable:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRMoreBooksCell *cell = [tableView dequeueReusableCellWithIdentifier:reuserID];
    cell.selectionStyle = UITableViewCellSeparatorStyleNone;
    ECRBookListModel *model;
    if (_array.count) {
        model              = _array[indexPath.row];
    }
    cell.model             = model;
    return cell;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return listCellH;
}
- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    ECRBookClassSortHeader *head = [tableView dequeueReusableHeaderFooterViewWithIdentifier:rHeadID];
    head.delegate = self;
    return head;
}
- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{

    return sortCellH2;
}


#pragma mark - scroll view delegate
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    CGFloat scoY = scrollView.contentOffset.y;
    CGFloat dValue = filterHeight - scoY;// Â∑ÆÂÄº
    
    if (dValue < 0) {// ‰øÆÂ§çbug:ÂºÄÂßãÁ™ÅÁÑ∂Â§ßÂπÖÂ∫¶ÊªëÂä®‰ºöÈÄ†Êàê‰ΩçÁΩÆÈîôËØØ; ÂéüÂõ†: Á™ÅÁÑ∂ÊªëÂä®‰ΩøÂæódValue<0
        dValue = 0;
    }
    if (scoY > 0) {// ‰∏äÊãâ
        if (dValue >= 0) { // ‰∏é if (scoY < filterHeight) Á≠â‰ª∑
            // Âπ≥Áßª fiterV
            self.filterView.transform = CGAffineTransformMakeTranslation(0, -scoY);
            // Êõ¥Êñ∞Á∫¶Êùü
            [self.tableView mas_remakeConstraints:^(MASConstraintMaker *make) {
                make.top    .equalTo(self.view.mas_top).offset(dValue + navH);
                make.left   .equalTo(self.view.mas_left);
                make.right  .equalTo(self.view.mas_right);
                make.bottom .equalTo(self.view.mas_bottom);
            }];
        }
    }else{
        // ÊÅ¢Â§ç ÂàùÂßãÂåñtransform
        self.filterView.transform = CGAffineTransformIdentity;
        [_tableView mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.top    .equalTo(_filterView.mas_bottom);
            make.left   .equalTo(self.view  .mas_left);
            make.right  .equalTo(self.view  .mas_right);
            make.bottom .equalTo(self.view  .mas_bottom);
        }];
    }
}

#pragma mark - ECRBookClassSortHeaderDelegate
- (void)bcsHeader:(ECRBookClassSortHeader *)header tag:(NSInteger)tag{
    NSLog(@"--tag:%ld",tag);
    switch (tag) {
        case 0:// ÈîÄÈáè
            NSLog(@"--ÈîÄÈáè");
            break;
        case 1:// ‰ª∑Ê†º
            NSLog(@"--‰ª∑Ê†º");
            break;
        case 2:// Â•ΩËØÑ
            NSLog(@"--Â•ΩËØÑ");
            break;
    }
}

- (void)setupUI{
    self.view.backgroundColor = [UIColor whiteColor];
    [self loadFilterView];
    
    // MARK: MJRefresh
    MJRefreshNormalHeader *header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(loadNewData)];
    header.lastUpdatedTimeLabel.hidden = YES;
    self.tableView.mj_header = header;

    // MARK: ËÆæÁΩÆÂØºËà™Ê†èÂè≥ËæπÊêúÁ¥¢ÊåâÈíÆüîç
    [self setNavRighSearchItem];
}
// ËÆæÁΩÆÈ°∂ÈÉ®ÊêúÁ¥¢Ê°Ü
- (void)replaceTitleViewForSearch{
    // ËÆæÁΩÆ ÊêúÁ¥¢ title view
    CGRect stRect                   = CGRectMake(0, 0, Screen_Width, 64);
    ECRSearchTitleView *stv         = [[ECRSearchTitleView alloc] initWithFrame:stRect];
    stv.delegate                    = self;
    [UIView animateWithDuration:0.2 animations:^{
        self.navigationItem.titleView   = stv;
        self.navigationItem.rightBarButtonItem = nil;
        UIBarButtonItem *spaceBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
        spaceBarButtonItem.width = -4;
        self.navigationItem.leftBarButtonItems = @[spaceBarButtonItem];
        [self.navigationItem setHidesBackButton:YES];
    } completion:^(BOOL finished) {
        [stv lg_becomResponser];
    }];
}
// ËÆæÁΩÆÂØºËà™Ê†èÂè≥‰æßÊêúÁ¥¢ÊåâÈíÆ
- (void)setNavRighSearchItem{
    UIBarButtonItem *rItem = [[UIBarButtonItem alloc] initWithTitle:@"üîç" style:UIBarButtonItemStylePlain target:self action:@selector(bookSearch:)];
    self.navigationItem.rightBarButtonItem = rItem;
}
- (void)bookSearch:(id)sender{
    [self replaceTitleViewForSearch];
}
// ÁªìÊùüÊêúÁ¥¢Áä∂ÊÄÅ
- (void)endSearching{
    // MARK: moreCallBack.ÂÖ≥Èó≠ÊêúÁ¥¢
    [self.view endEditing:YES];
    [UIView animateWithDuration:0.2 animations:^{
        self.navigationItem.titleView = nil;
    }];
    [self createNavLeftBackItem];
    [self setNavRighSearchItem];
}

- (void)loadFilterView{
    
    ECRSortTableViewController *stvc = [[ECRSortTableViewController alloc] init];
    self.stvc                        = stvc;
    stvc.delegate                    = self;
    stvc.bookListType                = _bookListType;
    [self loadLocalPlistWithType:_bookListType
                          pBlock:^(NSArray *models, CGFloat filterH) {
        stvc.view.frame = CGRectMake(0,
                                     navH,
                                     Screen_Width,
                                     filterH);
        stvc.modelArray = models;
        _filterView     = stvc.view;
        
        _tableView      = [[UITableView alloc]
                           initWithFrame:CGRectMake(0,
                                                    filterH + navH,
                                                    Screen_Width,
                                                    Screen_Height - filterH)
                           style:UITableViewStylePlain];
        
        _tableView.dataSource      = self;
        _tableView.delegate        = self;
        [self.view addSubview:_filterView];
        [self.view addSubview:_tableView];
                              
                              // ËÆæÁΩÆÁ∫¶Êùü
                              [_filterView mas_makeConstraints:^(MASConstraintMaker *make) {
                                  make.top.equalTo(self.view.mas_top).offset(navH);
                                  make.left.equalTo(self.view.mas_left);
                                  make.right.equalTo(self.view.mas_right);
                                  make.height.equalTo(@(filterH));
                              }];
                              [_tableView mas_makeConstraints:^(MASConstraintMaker *make) {
                                  make.top.equalTo(_filterView.mas_bottom);
                                  make.left.equalTo(self.view.mas_left);
                                  make.right.equalTo(self.view.mas_right);
                                  make.bottom.equalTo(self.view.mas_bottom);
                              }];
                              self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
                              [self.tableView registerNib:[UINib nibWithNibName:reuserID bundle:nil] forCellReuseIdentifier:reuserID];
                              [self.tableView registerNib:[UINib nibWithNibName:rHeadID bundle:nil] forHeaderFooterViewReuseIdentifier:rHeadID];
        
    }];
    
}
// ÂàáÊç¢ÂàÜÁ±ªÊó∂Ë∞ÉÁî®ËØ•ÊñπÊ≥ï
- (void)reloadFilterView{
    [_filterView removeFromSuperview];
    _filterView = nil;
    [_tableView removeFromSuperview];
    _tableView  = nil;
    self.stvc   = nil;
    [self loadFilterView];
//    [self loadNewData];
}


#pragma mark - UI
- (void)loadLocalPlistWithType:(ECRMoreBookListType)type pBlock:(void(^)(NSArray *models, CGFloat filterH))pBlock{
    NSString *lpName;
    BOOL isHot = 0;
    switch (type) {
        case ECRMoreBookListTypeHotSeal:// ÁÉ≠ÈîÄ
            lpName = @"moreBooksModified";
            isHot = 1;
            break;
        case ECRMoreBookListTypeInterText:// ‰∫íÂä®ÊïôÊùê
            lpName = @"interectBooksModified";
            isHot = 0;
            break;
        case ECRMoreBookListTypeChineseReading:// Ê±âËØ≠ËØªÁâ©
            lpName = @"ChineseBooksModified";
            isHot = 0;
            break;
        case ECRMoreBookListTypeCultureReading:// ÊñáÂåñËØªÁâ©
            lpName = @"cultureBooksModified";
            isHot = 0;
            break;
        default:
            lpName = @"ChineseBooksModified";
            break;
    }
    // MARK: Ëé∑ÂèñÊú¨Âú∞plistÊï∞ÊçÆ
    // 1.Ëé∑Âèñpath
    if (lpName) {
        NSString *path = [[NSBundle mainBundle] pathForResource:lpName ofType:@"plist"];
        NSArray *array = [NSArray arrayWithContentsOfFile:path];
        NSMutableArray *arrM = [NSMutableArray array];
        // Âä†ËΩΩÂêéÈù¢ÁöÑÂá†Ë°å, Ë°åÊï∞, ‰ª•ÂèäÊØèË°åÁöÑÂÜÖÂÆπÂùáÊúâ‰∏çÂêåÁ®ãÂ∫¶ÁöÑ Â∑ÆÂà´
        [array enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            NSDictionary *dict = (NSDictionary *)obj;
            ECRHomeSortModel *model = [ECRHomeSortModel mj_objectWithKeyValues:dict];
            [arrM addObject:model];
        }];
        if (!isHot) {
            // Âä†ËΩΩ Á¨¨‰∏ÄË°å: ÂÖ®ÈÉ® ‰∫íÂä®ÊïôÊùê Ê±âËØ≠ËØªÁâ© ÊñáÂåñËØªÁâ©
            // Èô§‰∫Ü ÁÉ≠ÈîÄ‰πãÂ§ñ, ‰∏â‰∏™ÂàÜÁ±ªÁöÑÁ¨¨‰∏ÄË°åÂÜÖÂÆπÈÉΩ‰∏ÄÊ†∑
            NSString *path = [[NSBundle mainBundle] pathForResource:@"bookTotalClass" ofType:@"plist"];
            NSArray *array = [NSArray arrayWithContentsOfFile:path];
            [array enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
                NSDictionary *dict = (NSDictionary *)obj;
                ECRHomeSortModel *model = [ECRHomeSortModel mj_objectWithKeyValues:dict];
                [arrM insertObject:model atIndex:0];
            }];
        }
        // MARK: arr.count * ÊØèË°åË°åÈ´òÂèä‰∏∫ Á≠õÈÄâÊù°‰ª∂view ÊâÄÈúÄË¶ÅÁöÑÈ´òÂ∫¶
        filterHeight = arrM.count * filterCellH;
        if (pBlock) {
            pBlock(arrM.copy, filterHeight);
        }   
    }
}

- (void)settingsWithNumber:(NSInteger)number searchCallBack:(void(^)())searchCallBack moreCallBack:(void(^)())moreCallBack{
    switch (number) {
        case 1:
            if (searchCallBack) {
                searchCallBack();
            }
            break;
        case 4:
            if (moreCallBack) {
                moreCallBack();
            }
            break;
    }
}

- (void)dealloc{
    self.stvc = nil;
    
}

@end
















