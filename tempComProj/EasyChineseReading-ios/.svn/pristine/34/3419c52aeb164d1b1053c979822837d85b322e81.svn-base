//
//  ECRHomeViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/8/29.
//  Copyright © 2017年 lee. All rights reserved.
//

static NSString *bcCell = @"ECRBookClassesCollectionCell";
static NSString *brCell = @"ECRHomeBRCell";
static NSString *rmCell = @"ECRHomeRMCell";
static NSString *sbvCell = @"ECRHomeSBVCell";

static CGFloat rmRowHeight = 70;

#import "ECRHomeViewController.h"
#import "ECRHomeMainModel.h"// 主view model
#import "ECRHomeMainView.h"// 主 view
#import "ECRHomeTitleView.h"// title view
#import "ECRMoreBooksViewController.h"// 更多
#import "ECRShoppingCarViewController.h"// 购物车
#import "ECRSearchBooksViewController.h"
#import "ECRBookInfoViewController.h"
#import "ECRBookClasses.h"
#import "ECRBoomRecomment.h"
#import "ECRSeriesAera.h"
#import "ECRSeriesBooksView.h"
#import "ECRReadMonster.h"
#import "ECRBookClassesCollectionCell.h"
#import "ECRHomeBRCell.h"
#import "ECRHomeRMCell.h"
#import "ECRHomeSBVCell.h"
#import "ECRHomeClassModel.h"
#import "ECRLocationManager.h"
#import "ECRDataHandler.h"
#import "ECRHomeBook.h"
#import "ECRHeadlineView.h"
#import "ECRSeriesModel.h"
#import "ECRThemeAera.h"
#import "ECRThematicModel.h"
#import "ECRRankUser.h"
#import "ECRSubjectController.h"
#import "ECRRequestFailuredView.h"

@interface ECRHomeViewController ()<
ECRHomeTitleViewDelelgate,
ECRHomeMainViewDelegate,
UICollectionViewDataSource,
UICollectionViewDelegate,
UITableViewDataSource,
UITableViewDelegate,
ECRThemeAeraDelegate,
ECRRequestFailuredViewDelegate
>

@property (strong,nonatomic) ECRRequestFailuredView *rrfv;//
@property (strong,nonatomic) UIScrollView *scroll;// 备用

@property (strong,nonatomic) ECRHomeMainView *mainView;
@property (strong,nonatomic) NSMutableArray *hcnModels;// 分类数组(汉语读物等)
@property (strong,nonatomic) NSArray *reco;// 推荐书籍
// 系列专区数据源
@property (strong,nonatomic) NSArray *sfArr;//
@property (strong,nonatomic) NSArray *ssArr;// ssArr
@property (strong,nonatomic) NSArray *stArr;// stArr
// 阅读达人榜
@property (strong,nonatomic) NSArray *rmArr;//

@end

@implementation ECRHomeViewController

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:YES];
}
- (void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    [self.navigationController setNavigationBarHidden:NO animated:YES];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    [self loadNewData];
}

- (void)setupUI{
    self.automaticallyAdjustsScrollViewInsets = NO;
    self.view.backgroundColor = [UIColor whiteColor];
    
    ECRHomeTitleView *tView = [[ECRHomeTitleView alloc] initWithFrame:CGRectMake(0, 20, Screen_Width, 44)];
    tView.delegate = self;
    
    [self.view addSubview:tView];
    [self.view addSubview:self.mainView];
    
}

// MARK: 接口调试
- (void)loadNewData{
    [[ECRDataHandler sharedDataHandler] homeDataWithSuccess:^(ECRHomeMainModel *model) {
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            if (_rrfv != nil) {
                [_rrfv removeFromSuperview];
                _rrfv = nil;
            }
            [self.view addSubview:self.mainView];
        }];
        _mainView.model = model;
        
        // 分类
        // 从本地获取 文化读物等
        self.hcnModels = [NSMutableArray arrayWithArray:model.SeriesClassif];
        NSString *arrPath = [[NSBundle mainBundle] pathForResource:@"HomeClassNames" ofType:@"plist"];
        NSArray *array = [NSArray arrayWithContentsOfFile:arrPath];
        for (NSInteger i = 0; i < array.count; ++i) {
            if (i == (array.count - 1)) {
                ECRHomeClassModel *model = [ECRHomeClassModel mj_objectWithKeyValues:array[i]];
                [self.hcnModels addObject:model];
            }
        }
        
        // 推荐书籍
        self.reco = model.reco;
        
        // 系列专区
//        self.mainView.seriesAera.seriesModels = model.Series;
        for (NSInteger i = 0; i < model.Series.count; i++) {
            ECRSeriesModel *seriesModel = model.Series[i];
            // 0 1 2
            switch (i) {
                case 0:
                    self.sfArr = seriesModel.books;
                    break;
                case 1:
                    self.ssArr = seriesModel.books;
                    break;
                case 2:
                    self.stArr = seriesModel.books;
                    break;
            }
        }
        // 专题
        self.mainView.themeAera.models = model.thematic;
        // 阅读达人榜
        self.rmArr = model.Rank;
        
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            [self.mainView.bookClasses.collectionView reloadData];
            [self.mainView.boomRecomment.collectionView reloadData];
            [self.mainView.seriesAera.viewFirst.collectionView reloadData];
            [self.mainView.seriesAera.viewSecond.collectionView reloadData];
            [self.mainView.seriesAera.viewThird.collectionView reloadData];
            [self.mainView.readMonster.tableView reloadData];
        }];
        
    } failure:^(NSString *msg) {
//        NSLog(@"msg -- %@",msg);
        if (self.mainView != nil) {
            [self.mainView removeFromSuperview];
            self.mainView = nil;
        }
        // MARK: 添加请求错误view
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    } commenFailure:^(NSError *error) {
        if (self.mainView != nil) {
            [self.mainView removeFromSuperview];
            self.mainView = nil;
        }
        // MARK: 添加请求错误view
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    }];

}

#pragma mark - ECRRequestFailuredViewDelegate 错误请求代理
- (void)rfViewReloadData:(ECRRequestFailuredView *)view{
    [self loadNewData];
}

#pragma mark - UICollectionViewDataSource
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section{
    if ([collectionView isEqual:self.mainView.bookClasses.collectionView]) {
        return self.hcnModels.count;
    }
    if ([collectionView isEqual:self.mainView.boomRecomment.collectionView]) {
        return self.reco.count;
    }
//    if ([collectionView isEqual:self.mainView.seriesAera.viewFirst.collectionView] ||
//        [collectionView isEqual:self.mainView.seriesAera.viewThird.collectionView]) {
//        if (Screen_Width < 375) {
//            return 2;
//        }else{
//            return 3;
//        }
//    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewFirst.collectionView]) {
        return self.sfArr.count;
    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewSecond.collectionView]) {
        return self.ssArr.count;
    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewThird.collectionView]) {
        return self.stArr.count;
    }
    return 0;
}
- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath{
    if ([collectionView isEqual:self.mainView.bookClasses.collectionView]) {
        ECRBookClassesCollectionCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:bcCell forIndexPath:indexPath];
        ECRHomeClassModel *model = self.hcnModels[indexPath.item];
        cell.indexPath = indexPath;
        cell.model = model;
        return cell;
    }
    if ([collectionView isEqual:self.mainView.boomRecomment.collectionView]) {
        ECRHomeBRCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:brCell forIndexPath:indexPath];
        ECRHomeBook *recoModel = self.reco[indexPath.item];
        cell.model = recoModel;
        return cell;
    }
//    if ([collectionView isEqual:self.mainView.seriesAera.viewFirst.collectionView]  ||
//        [collectionView isEqual:self.mainView.seriesAera.viewSecond.collectionView] ||
//        [collectionView isEqual:self.mainView.seriesAera.viewThird.collectionView]) {
//        ECRHomeSBVCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:sbvCell forIndexPath:indexPath];
//
//        return cell;
//    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewFirst.collectionView]) {
        ECRHomeSBVCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:sbvCell forIndexPath:indexPath];
        ECRHomeBook *saBook = self.sfArr[indexPath.item];
        cell.model = saBook;
        return cell;
    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewSecond.collectionView]) {
        ECRHomeSBVCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:sbvCell forIndexPath:indexPath];
        ECRHomeBook *saBook = self.ssArr[indexPath.item];
        cell.model = saBook;
        return cell;

    }
    if ([collectionView isEqual:self.mainView.seriesAera.viewThird.collectionView]) {
        ECRHomeSBVCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:sbvCell forIndexPath:indexPath];
        ECRHomeBook *saBook = self.stArr[indexPath.item];
        cell.model = saBook;
        return cell;

    }
    return nil;
}
- (void)mbvcWithModel:(ECRHomeClassModel *)model{
    ECRMoreBooksViewController *mbvc = [[ECRMoreBooksViewController alloc] init];
//    mbvc.dataKey = model.mbDataKey;
    mbvc.classModel = model;
    mbvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:mbvc animated:YES];
}
#pragma mark - UICollectionViewDelegate
- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath{
    if ([collectionView isEqual:self.mainView.bookClasses.collectionView]) {
        ECRHomeClassModel *model = self.hcnModels[indexPath.item];
        [self mbvcWithModel:model];
        // 加载本地plist方式
//        [self sortTableViewTestWithType:model.classType];
    }else{
        ECRHomeBook *book;
        if ([collectionView isEqual:self.mainView.boomRecomment.collectionView]) {
            book = self.reco[indexPath.item];
        }
        if ([collectionView isEqual:self.mainView.seriesAera.viewFirst]) {
            book = self.sfArr[indexPath.item];
        }
        if ([collectionView isEqual:self.mainView.seriesAera.viewSecond]) {
            book = self.ssArr[indexPath.item];
        }
        if ([collectionView isEqual:self.mainView.seriesAera.viewThird]) {
            book = self.stArr[indexPath.item];
        }
        // test
        // 进入详情页面
//        推荐
//        系列 0 1 2
        UIStoryboard *board = [UIStoryboard storyboardWithName:@"BookInfo" bundle:nil];
        ECRBookInfoViewController *bivc = [board instantiateViewControllerWithIdentifier:@"ECRBookInfoViewController"];
        bivc.viewControllerPushWay = ECRBaseControllerPushWayPush;
        bivc.bookId = book.bookId;
        [self.navigationController pushViewController:bivc animated:YES];
    }
}

#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.rmArr.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.mainView.readMonster.tableView]) {
        ECRHomeRMCell *cell = [tableView dequeueReusableCellWithIdentifier:rmCell forIndexPath:indexPath];
        ECRRankUser *model = self.rmArr[indexPath.row];
        cell.model = model;
        return cell;
    }
    return nil;
}

#pragma mark - UITableViewDelegate
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return rmRowHeight;
}
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    // MARK: 点击阅读达人
}

#pragma mark - ECRHomeMainViewDelegate

#pragma mark - ECRThemeAeraDelegate 主题代理
- (void)taView:(ECRThemeAera *)view model:(ECRThematicModel *)model{
    // TODO: 跳转到主题
    ECRSubjectController *sbvc = [[ECRSubjectController alloc] init];
    sbvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    sbvc.model = model;
    [self.navigationController pushViewController:sbvc animated:YES];
}

#pragma mark - 自定义导航栏 代理
- (void)htViewRgLocated:(ECRHomeTitleView *)titleView cnBlock:(void (^)(NSString *))cnBlock{
    [self rg_locatedWithBlock:cnBlock];
    [self loadNewData];
}
- (void)htViewBeginSearch:(ECRHomeTitleView *)titleView{
    [self.view endEditing:YES];
    // MARK: 弹出搜索视图
    ECRSearchBooksViewController *scvc = [[ECRSearchBooksViewController alloc] init];
    scvc.classModel = nil;

    scvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:scvc animated:NO];
    
}
- (void)htView:(ECRHomeTitleView *)titlView sCarClick:(id)param{
    // MARK: 购物车
    ECRShoppingCarViewController *sc = [[ECRShoppingCarViewController alloc] init];
    sc.viewControllerPushWay = 0;
    [self.navigationController pushViewController:sc animated:YES];
}

- (void)createNavLeftBackItem{
    // 重写,不做任何操作
}

- (ECRHomeMainView *)mainView{
    if (_mainView == nil) {
        //    CGRect mvRect = CGRectMake(0, -64, Screen_Width, Screen_Height);
        _mainView = [[ECRHomeMainView alloc] initWithFrame:CGRectMake(0, 64, Screen_Width, Screen_Height - 64)];
        // MARK: 注册cell
        [_mainView.bookClasses.collectionView registerNib:[UINib nibWithNibName:bcCell bundle:nil] forCellWithReuseIdentifier:bcCell];
        [_mainView.boomRecomment.collectionView registerNib:[UINib nibWithNibName:brCell bundle:nil] forCellWithReuseIdentifier:brCell];
        [_mainView.readMonster.tableView registerNib:[UINib nibWithNibName:rmCell bundle:nil] forCellReuseIdentifier:rmCell];
        [_mainView.seriesAera.viewFirst.collectionView registerNib:[UINib nibWithNibName:sbvCell bundle:nil] forCellWithReuseIdentifier:sbvCell];
        [_mainView.seriesAera.viewSecond.collectionView registerNib:[UINib nibWithNibName:sbvCell bundle:nil] forCellWithReuseIdentifier:sbvCell];
        [_mainView.seriesAera.viewThird.collectionView registerNib:[UINib nibWithNibName:sbvCell bundle:nil] forCellWithReuseIdentifier:sbvCell];
        [_mainView.seriesAera.headLine.more addTarget:self action:@selector(seriesMoreClick:) forControlEvents:UIControlEventTouchUpInside];
        _mainView.delegate = self;
        _mainView.bookClasses.collectionView.dataSource = self;
        _mainView.bookClasses.collectionView.delegate = self;
        _mainView.boomRecomment.collectionView.dataSource = self;
        _mainView.boomRecomment.collectionView.delegate = self;
        _mainView.readMonster.tableView.dataSource = self;
        _mainView.readMonster.tableView.delegate = self;
        _mainView.seriesAera.viewFirst.collectionView.dataSource = self;
        _mainView.seriesAera.viewFirst.collectionView.delegate = self;
        _mainView.seriesAera.viewSecond.collectionView.dataSource = self;
        _mainView.seriesAera.viewSecond.collectionView.delegate = self;
        _mainView.seriesAera.viewThird.collectionView.dataSource = self;
        _mainView.seriesAera.viewThird.collectionView.delegate = self;
        _mainView.themeAera.delegate = self;
    }
    return _mainView;
}
// MARK: 进入分类页面
- (void)sortTableViewTestWithType:(ECRMoreBookListType)blType{
    NSString *vcTitle;
    switch (blType) {
        case ECRMoreBookListTypeHotSeal:
            vcTitle = @"热销图书";
            break;
        case ECRMoreBookListTypeInterText:
            vcTitle = @"互动教材";
            break;
        case ECRMoreBookListTypeChineseReading:
            vcTitle = @"汉语读物";
            break;
        case ECRMoreBookListTypeCultureReading:
            vcTitle = @"文化读物";
            break;
    }
    ECRMoreBooksViewController *mbvc = [[ECRMoreBooksViewController alloc] init];
    mbvc.title = vcTitle;
    mbvc.bookListType = blType;
    mbvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:mbvc animated:YES];
}
- (void)rg_locatedWithBlock:(void (^)(NSString *))cnBlock{
    [ECRLocationManager rg_startUpdatingLocationWithBlock:cnBlock];
}

// MARK: 点击更多系列
- (void)seriesMoreClick:(UIButton *)senser{
    NSLog(@"更多系列 -- ");
    
}

- (ECRRequestFailuredView *)rrfv{
    if (_rrfv == nil) {
        _rrfv = [[ECRRequestFailuredView alloc] initWithFrame:self.view.bounds];
        _rrfv.delegate = self;
    }
    return _rrfv;
}

@end


