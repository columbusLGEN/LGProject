//
//  ECRBookrackDataHandler.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/10/25.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRBookrackDataHandler.h"
#import "ECRBookrackModel.h"
#import "ECRDownloadStateModel.h"

@interface ECRBookrackDataHandler ()


@end

@implementation ECRBookrackDataHandler

// MARK: 管理书架

// MARK: 请求全部图书
+ (void)bookShelf:(BookrackSuccess)success failure:(BookrackFailure)failure{
    [[ECRDataHandler sharedDataHandler] bookShelfWithSuccess:^(id object) {
//        NSLog(@"bookShelf -- %@",object);
        NSArray *arr = object;
        // 全部图书
        NSMutableArray *arrm = [NSMutableArray array];
        // 已购买图书
        NSMutableArray *arrmBuyed = [NSMutableArray array];
        [arr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            ECRBookrackModel *book = [ECRBookrackModel mj_objectWithKeyValues:obj];
            book.isEditState = NO;
            
            // 下载状态模型
            ECRDownloadStateModel *dsModel = [[ECRDownloadStateModel alloc] init];// download state
            dsModel.modelState = ECRDownloadStateModelStateNormal;
            book.dsModel = dsModel;
            dsModel.bookName = book.bookName;
            
            if (book.groupId != 0) {// 该模型为文件夹
                [book.books enumerateObjectsUsingBlock:^(ECRBookrackModel * _Nonnull book_group,
                                                         NSUInteger idx_group, BOOL * _Nonnull stop_group) {
                    book_group.isEditState = NO;
                    ECRDownloadStateModel *dsModel_group = [[ECRDownloadStateModel alloc] init];// download state
                    dsModel_group.modelState = ECRDownloadStateModelStateNormal;
                    book_group.dsModel = dsModel_group;
                    dsModel_group.bookName = book_group.bookName;
                }];
                
            }
            
            [arrm addObject:book];
            if (book.owendType == 1) {
                [arrmBuyed addObject:book];
            }
        }];
        NSLog(@"全部 -- %@",arrm);
        NSLog(@"已购买 -- %@",arrmBuyed);
        if (success) {
            success(arrm,arrmBuyed);
        }
        
    } failure:^(NSString *msg) {
        if (failure) {
            failure(nil,msg);
        }
    } commenFailure:^(NSError *error) {
        if (failure) {
            failure(error,nil);
        }
    }];
}


@end
