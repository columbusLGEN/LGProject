//
//  USetLanguageVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/1.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserSetLanguageVC.h"
#import "AppDelegate.h"

@interface UserSetLanguageVC ()

@property (weak, nonatomic) IBOutlet UIImageView *imgChinese;
@property (weak, nonatomic) IBOutlet UIImageView *imgEnglish;

@property (weak, nonatomic) IBOutlet UILabel *lblChinese;
@property (weak, nonatomic) IBOutlet UILabel *lblEnglish;

@property (strong, nonatomic) NSString *language;

@end

@implementation UserSetLanguageVC

- (void)viewDidLoad {
    [super viewDidLoad];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

#pragma mark - 自定义导航栏返回按钮

- (void)createNavLeftBackItem{
    // TODO: 设置导航栏返回按钮
    UIBarButtonItem *bkBatButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_icon_back"] style:UIBarButtonItemStyleDone target:self action:@selector(back)];
    // 调整返回按钮左右位置
    UIBarButtonItem *spaceBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
    spaceBarButtonItem.width = -4;
    self.navigationItem.leftBarButtonItems = @[spaceBarButtonItem,bkBatButtonItem];
    self.navigationController.interactivePopGestureRecognizer.delegate = (id)self;// 解决自定义导航栏按钮导致系统的左滑pop 失效
}

- (void)back {
    [self.navigationController popViewControllerAnimated:YES];
}

#pragma mark - 判断是中英文

- (void)updateSystemLanguage
{
    _language = [[NSUserDefaults standardUserDefaults] objectForKey:@"appLanguage"];
    
    _imgChinese.image = [_language isEqualToString:@"zh-Hans"] ? [UIImage imageNamed:@"selected"] : [UIImage imageNamed:@"unSelected"];
    _imgEnglish.image = [_language isEqualToString:@"zh-Hans"] ? [UIImage imageNamed:@"unSelected"] : [UIImage imageNamed:@"selected"];
    
    self.title = LOCALIZATION(@"语言");

    _lblChinese.text = LOCALIZATION(@"中文");
    _lblEnglish.text = LOCALIZATION(@"英文");
}

#pragma mark -
#pragma mark UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    //修改本地获取的语言文件-交替
    
    if (0 == indexPath.row && [_language isEqualToString:@"en"]) {
        [[NSUserDefaults standardUserDefaults] setObject:@"zh-Hans" forKey:@"appLanguage"];
        [self updateUserLanguageWithLanguage:ENUM_LanguageTypeChinese];
    }
    else if (1 == indexPath.row && [_language isEqualToString:@"zh-Hans"]) {
        [[NSUserDefaults standardUserDefaults] setObject:@"en" forKey:@"appLanguage"];
        [self updateUserLanguageWithLanguage:ENUM_LanguageTypeEnglish];
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self fk_postNotification:kNotificationLanguageChanged];
}

- (void)tableView:(UITableView *)tableView willDisplayCell:(UITableViewCell *)cell forRowAtIndexPath:(NSIndexPath *)indexPath
{
    UIView *line = [[UIView alloc] initWithFrame:CGRectMake(0, cell.height - 0.5, Screen_Width, .5)];
    line.backgroundColor = [UIColor cm_lineColor_D9D7D7_1];
    [cell addSubview:line];
}

- (void)updateUserLanguageWithLanguage:(ENUM_LanguageType)language
{
    [[UserRequest sharedInstance] updateUserInfoWithName:[UserRequest sharedInstance].user.name
                                                 address:[UserRequest sharedInstance].user.address
                                                     sex:[NSString stringWithFormat:@"%ld", [UserRequest sharedInstance].user.sex]
                                                language:[NSString stringWithFormat:@"%ld",language]
                                                 country:[NSString stringWithFormat:@"%ld",[UserRequest sharedInstance].user.country]
                                               learnyear:[NSString stringWithFormat:@"%ld", [UserRequest sharedInstance].user.learnyear]
                                                interest:[UserRequest sharedInstance].user.interest
                                                birthday:[UserRequest sharedInstance].user.birthday
                                                 iconUrl:[UserRequest sharedInstance].user.iconUrl
                                                  school:[UserRequest sharedInstance].user.school
                                              completion:^(id object, ErrorModel *error) {
                                                  if (error) {
                                                      [self presentFailureTips:error.message];
                                                  }
                                                  else {
                                                      [UserRequest sharedInstance].user = [UserRequest sharedInstance].user;
                                                      [[UserRequest sharedInstance] saveCache];
                                                      [self presentSuccessTips:LOCALIZATION(@"保存成功")];
                                                      [self.navigationController popViewControllerAnimated:YES];
                                                  }
                                              }];
}

@end
