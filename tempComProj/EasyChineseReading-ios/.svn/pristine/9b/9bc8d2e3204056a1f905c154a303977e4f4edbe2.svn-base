//
//  UTaskReadingVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/9/11.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UTaskReadingVC.h"

#import "UTaskRecommendTableViewCell.h"
#import "UTaskImpowerTableViewCell.h"

#import "UCRecommendDetailVC.h"

@interface UTaskReadingVC ()<UITableViewDelegate, UITableViewDataSource>

@property (strong, nonatomic) UITableView *tableView;
/* 数据 */
@property (strong, nonatomic) NSMutableArray *arrTasks;

@property (assign, nonatomic) NSInteger currentPage; // 当前页

@end

@implementation UTaskReadingVC

- (void)viewDidLoad {
    [super viewDidLoad];
    [self configMJRefresh];
    [self getFirstPageReadingTask];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)updateSystemLanguage
{
    [_tableView reloadData];
}

- (void)configMJRefresh
{
    self.tableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        [self getFirstPageReadingTask];
    }];
    
    self.tableView.mj_footer = [MJRefreshBackFooter footerWithRefreshingBlock:^{
        [self getReadingTaskDataWithPage:_currentPage];
    }];
}

#pragma mark - 获取数据

- (void)getFirstPageReadingTask
{
    _currentPage = 0;
    [[TaskRequest sharedInstance] getReadTaskWithPage:[NSString stringWithFormat:@"%ld", _currentPage]
                                           completion:^(id object, ErrorModel *error) {
                                               [_tableView.mj_header endRefreshing];
                                               if (error) {
                                                   [self presentFailureTips:error.message];
                                               }
                                               else {
                                                   self.arrTasks = [ReadTaskModel mj_objectArrayWithKeyValuesArray:object];
                                                   if (_arrTasks.count > 0) {
                                                       _currentPage += 1;
                                                   }
                                                   [self.tableView reloadData];
                                               }
                                           }];
}

- (void)getReadingTaskDataWithPage:(NSInteger)page
{
    [[TaskRequest sharedInstance] getReadTaskWithPage:[NSString stringWithFormat:@"%ld", page]
                                           completion:^(id object, ErrorModel *error) {
                                               [_tableView.mj_footer endRefreshing];
                                               if (error) {
                                                   [self presentFailureTips:error.message];
                                               }
                                               else {
                                                   
                                                   NSArray *array = [ReadTaskModel mj_objectArrayWithKeyValuesArray:object];
                                                   if (array.count > 0) {
                                                       _currentPage += 1;
                                                       [self.arrTasks addObjectsFromArray:array];
                                                   }
                                                   [self.tableView reloadData];
                                               }
                                           }];
}

#pragma mark -
#pragma mark UITableViewDataSource

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return _arrTasks.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    ReadTaskModel *readTask = _arrTasks[indexPath.row];
    
    if (readTask.type == ENUM_RecommendTypeRecommend) {
        UTaskRecommendTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:NSStringFromClass([UTaskRecommendTableViewCell class])];
        cell.data = _arrTasks[indexPath.row];
        return cell;
    }
    else {
        UTaskImpowerTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:NSStringFromClass([UTaskImpowerTableViewCell class])];
        cell.data = _arrTasks[indexPath.row];
        return cell;
    }
}

#pragma mark -
#pragma mark UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    ReadTaskModel *readTask = _arrTasks[indexPath.row];
    
    UCRecommendDetailVC *detailVC = [[UCRecommendDetailVC alloc] init];
    
    detailVC.recommendType = readTask.type;
    detailVC.userType = [UserRequest sharedInstance].user.userType;

    detailVC.shareBatchId = readTask.recommendId;
    detailVC.grantBatchId = readTask.grantbatchId;
    
    [self.navigationController pushViewController:detailVC animated:YES];
}

#pragma mark - 属性

- (UITableView *)tableView
{
    if (_tableView == nil) {
        _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, self.view.width, self.view.height) style:UITableViewStylePlain];
        _tableView.delegate = self;
        _tableView.dataSource = self;
        
        _tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        
        _tableView.rowHeight = UITableViewAutomaticDimension;
        _tableView.estimatedRowHeight = 100;
        
        [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([UTaskRecommendTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([UTaskRecommendTableViewCell class])];
        [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([UTaskImpowerTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([UTaskImpowerTableViewCell class])];
        [self.view addSubview:_tableView];
    }
    return _tableView;
}

- (NSMutableArray *)arrTasks
{
    if (_arrTasks == nil) {
        _arrTasks = [NSMutableArray array];
    }
    return _arrTasks;
}

@end
