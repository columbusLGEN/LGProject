//
//  ECRBookRackController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/5.
//  Copyright Â© 2017å¹´ lee. All rights reserved.
//

#define ECRBookrackcell @"ECRBookrackCollectionViewCell"

#import "ECRBookRackController.h"
#import "ECRBookrackView.h"
#import "ECRBookrackModel.h"
#import "ECRBookrackCollectionViewCell.h"
#import "ECRBookrackFlowLayout.h"
#import "ECRBookrackModel.h"
#import "ECRFloderView.h"
#import "ECRBookFloderLayout.h"

@interface ECRBookRackController ()<
ECRBookrackViewDelegate,
UICollectionViewDelegate,
UICollectionViewDataSource,
ECRBookrackFlowLayoutSwitchStateDelegate,
LXReorderableCollectionViewDataSource,
LXReorderableCollectionViewDelegateFlowLayout,
ECRFloderViewDelegate
>

@property (strong,nonatomic) ECRBookrackView *mainView;
@property (copy,nonatomic) void(^editDoneBlock)();
@property (strong,nonatomic) NSArray<ECRBookrackModel *> *allBookModels;
@property (strong,nonatomic) NSMutableArray<ECRBookrackModel *> *bookrackModels;// å·²è´­ä¹°æ¨¡å‹æ•°ç»„
//@property (strong,nonatomic) ECRBookrackFlowLayout *brLayout;
@property (strong,nonatomic) ECRFloderView *floderView;

@end

@implementation ECRBookRackController

#pragma mark - ECRFloderViewDelegate
- (void)floderViewClose:(ECRFloderView *)floderView{
    [self.navigationController setNavigationBarHidden:NO animated:NO];
    if (self.floderView != nil) {
        [self.floderView removeFromSuperview];
        self.floderView = nil;
    }
}
// æ–‡ä»¶å¤¹ä¸­ç‚¹å‡»å®Œæˆ, é€€å‡ºç¼–è¾‘çŠ¶æ€
- (void)floderViewEndEdit:(ECRFloderView *)floderView{
    [self editDone];
}

#pragma mark - ECRBookrackViewDelegate ç‚¹å‡»ä¹¦æœ¬æˆ–è€…æ–‡ä»¶å¤¹
- (void)brView:(ECRBookrackView *)brViiew didSelectBookrack:(UICollectionView *)collectionView indexPath:(NSIndexPath *)indexPath{
    // å…¨éƒ¨å›¾ä¹¦åˆ—è¡¨,è¿›å…¥è¯¦æƒ…é¡µé¢
    if ([collectionView isEqual:_mainView.allOfBooks]) {
        // TODO: è¿›å…¥è¯¦æƒ…é¡µé¢
        NSLog(@"å›¾ä¹¦è¯¦æƒ…");
    }else{
        // å·²è´­ä¹°åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
        ECRBookrackModel *model = self.bookrackModels[indexPath.item];
        if (model.groupId == 0) {
            // è¯»ä¹¦
            
            
        }else{
            // éšè—å¯¼èˆªæ 
            [self.navigationController setNavigationBarHidden:YES animated:NO];
            // æ‰“å¼€æ–‡ä»¶å¤¹
            ECRBookFloderLayout *brLayout = [[ECRBookFloderLayout alloc] init];
            brLayout.flssDelegate = self;
            _floderView = [[ECRFloderView alloc] initWithFrame:CGRectZero flowLayout:brLayout];
            _floderView.delegate = self;
            [self.view addSubview:_floderView];
            _floderView.fileName = model.name;
            _floderView.bookModels = model.books;
            _floderView.collectionView.dataSource = self;
            _floderView.collectionView.delegate = self;
            
            [_floderView mas_makeConstraints:^(MASConstraintMaker *make) {
                make.edges.equalTo(self.view);
            }];
        }
    }
}

#pragma mark - ECRBookrackFlowLayoutSwitchStateDelegate
- (void)brflayout:(ECRBookrackFlowLayout *)flowLayout beginEditWithModel:(ECRBookrackModel *)model doneBlock:(void (^)())doneBlock {
    
    [self setNavRightItemsWithState:NO];
    self.editDoneBlock = doneBlock;
    if (model.groupId == 0) {// å•æœ¬ä¹¦
        // å°†è¯¥æ¨¡å‹ åˆ‡æ¢ä¸ºé€‰ä¸­çŠ¶æ€
        
        // æ›´æ¢å¯¼èˆªæ å³è¾¹ item
    }else{// æ–‡ä»¶å¤¹
        // ä¸æ“ä½œ
    }
}

#pragma mark LXReorderableCollectionViewDataSource
- (void)collectionView:(UICollectionView *)collectionView itemAtIndexPath:(NSIndexPath *)fromIndexPath didMoveToIndexPath:(NSIndexPath *)toIndexPath{
    // å®Œæˆç§»åŠ¨æ—¶æ‰§è¡Œ
    
}

- (void)collectionView:(UICollectionView *)collectionView itemAtIndexPath:(NSIndexPath *)fromIndexPath willMoveToIndexPath:(NSIndexPath *)toIndexPath{
    if ([collectionView isEqual:_mainView.bookrack]) {
        
        ECRBookrackModel *fromModel = _bookrackModels[fromIndexPath.item];
        [_bookrackModels removeObjectAtIndex:fromIndexPath.item];
        [_bookrackModels insertObject:fromModel atIndex:toIndexPath.item];
    }else{
        ECRBookrackModel *fromModel = _floderView.bookModels[fromIndexPath.item];
        [_floderView.bookModels removeObjectAtIndex:fromIndexPath.item];
        [_floderView.bookModels insertObject:fromModel atIndex:toIndexPath.item];
    }
    
}
// lee
- (void)collectionView:(UICollectionView *)collectionView deleteItemAndModelAtIndexPath:(NSIndexPath *)fromIndexPath insertModel:(ECRBookrackModel *)model toIndexPath:(NSIndexPath *)toIndexPath{
    
    if (model == nil) {// å¦‚æœmodelä¸ºnil, é‚£ä¹ˆtoIndexçš„æ¨¡å‹ä¸ºæ–‡ä»¶å¤¹ç±»å‹
        [_bookrackModels removeObjectAtIndex:fromIndexPath.item];
    }else{
        if (fromIndexPath.item < toIndexPath.item) {// ä»å‰å¾€åæ·»åŠ 
                [_bookrackModels removeObjectAtIndex:fromIndexPath.item];
                [_bookrackModels removeObjectAtIndex:(toIndexPath.item - 1)];
                [_bookrackModels insertObject:model atIndex:(toIndexPath.item - 1)];
        }else{// ä»åå¾€å‰æ·»åŠ 

            [_bookrackModels removeObjectAtIndex:fromIndexPath.item];
            [_bookrackModels removeObjectAtIndex:toIndexPath.item];
            [_bookrackModels insertObject:model atIndex:toIndexPath.item];
//            NSLog(@"æ–‡ä»¶å¤¹index%ld",toIndexPath.item);
        }
    }
    
}

- (BOOL)collectionView:(UICollectionView *)collectionView itemAtIndexPath:(NSIndexPath *)fromIndexPath canMoveToIndexPath:(NSIndexPath *)toIndexPath{
    return YES;
}

- (BOOL)collectionView:(UICollectionView *)collectionView canMoveItemAtIndexPath:(NSIndexPath *)indexPath{
    return YES;
}

//// ç‚¹å‡»cell
//- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath{
//    ECRBookrackModel *model = self.bookrackModels[indexPath.item];
//    if (model.groupId == 0) {
//        // è¯»ä¹¦
//        ECRBookReaderController *rvc = [[ECRBookReaderController alloc] init];
//        rvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
//        [self.navigationController pushViewController:rvc animated:YES];
//        
//    }else{
//        // éšè—å¯¼èˆªæ 
//        [self.navigationController setNavigationBarHidden:YES animated:NO];
//        // æ‰“å¼€æ–‡ä»¶å¤¹
//        ECRBookFloderLayout *brLayout = [[ECRBookFloderLayout alloc] init];
//        brLayout.flssDelegate = self;
//        _floderView = [[ECRFloderView alloc] initWithFrame:CGRectZero flowLayout:brLayout];
//        _floderView.delegate = self;
//        [self.view addSubview:_floderView];
//        _floderView.fileName = model.name;
//        _floderView.bookModels = model.books;
//        _floderView.collectionView.dataSource = self;
//        _floderView.collectionView.delegate = self;
//        
//        [_floderView mas_makeConstraints:^(MASConstraintMaker *make) {
//            make.edges.equalTo(self.view);
//        }];
//    }
//}

#pragma mark - UICollectionViewDataSource
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section{
    if ([collectionView isEqual:_mainView.bookrack]) {
        return _bookrackModels.count;
    }
    if ([collectionView isEqual:_floderView.collectionView]) {
        return _floderView.bookModels.count;
    }
    if ([collectionView isEqual:_mainView.allOfBooks]) {
        return _allBookModels.count;
    }
    return 0;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath{
    // å¾…ä¼˜åŒ–
    if ([collectionView isEqual:_mainView.bookrack]) {
        ECRBookrackModel *model;
        ECRBookrackCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:ECRBookrackcell forIndexPath:indexPath];
        cell.inx  = indexPath;
        if (self.bookrackModels.count == 0) {
        }else{
            model = self.bookrackModels[indexPath.item];
            cell.model = model;
        }
        return cell;
    }
    if ([collectionView isEqual:_floderView.collectionView]) {
        ECRBookrackModel *model;
        ECRBookrackCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:ECRBookrackcell forIndexPath:indexPath];
        cell.inx  = indexPath;
        if (self.floderView.bookModels.count == 0) {
        }else{
            model = self.floderView.bookModels[indexPath.item];
            cell.model = model;
        }
        return cell;
    }
    if ([collectionView isEqual:_mainView.allOfBooks]) {
        ECRBookrackModel *model;
        ECRBookrackCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:ECRBookrackcell forIndexPath:indexPath];
        cell.inx  = indexPath;
        if (self.bookrackModels.count == 0) {
        }else{
            model = self.allBookModels[indexPath.item];
            cell.model = model;
        }
        return cell;
    }
    return nil;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    [self loadNewData];
    
}

- (void)loadNewData{
    // TEST - CODE FOR DATA
    NSString *testURL0 = @"https://images-cn.ssl-images-amazon.com/images/I/51VNBGrPxVL._SX353_BO1,204,203,200_.jpg";
    NSString *testURL1 = @"http://pic13.photophoto.cn/20091109/0005018327183438_b.jpg";
    NSInteger count = 19;//arc4random_uniform(10) + 6;
    NSMutableArray *arrM = [NSMutableArray arrayWithCapacity:10];
    for (NSInteger i = 0; i < count; ++i) {
        ECRBookrackModel *model = [[ECRBookrackModel alloc] init];
        model.name = [NSString stringWithFormat:@"è¥é”€_%ld",i];
        model.groupId = 0;
        model.bookPic = testURL0;
        if (i == 0 || i == 5) {
            NSMutableArray *arr2 = [NSMutableArray arrayWithCapacity:10];
            for (NSInteger i = 0; i < 9; ++i) {
                ECRBookrackModel *modelBook = [[ECRBookrackModel alloc] init];
                modelBook.bookPic = testURL1;
                modelBook.name = @"Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ";
                [arr2 addObject:modelBook];
            }
            model.books = arr2;
            model.groupId = 1;
            model.name = [NSString stringWithFormat:@"æ–‡ä»¶å¤¹%ld",i];
        }
        [arrM addObject:model];
    }
    
    self.allBookModels = arrM.copy;// å…¨éƒ¨å›¾ä¹¦
    [self.mainView.allOfBooks reloadData];
    self.bookrackModels = arrM;// å·²è´­ä¹°
    [self.mainView.bookrack reloadData];
    
}



- (void)setupUI{
    ECRBookrackFlowLayout *brLayout = [[ECRBookrackFlowLayout alloc] init];
    brLayout.flssDelegate =  self;
    _mainView          = [[ECRBookrackView alloc]
                          initWithFrame:self.view.bounds flowLayout:brLayout];
    _mainView.delegate = self;
    _mainView.bookrack.dataSource = self;
    _mainView.allOfBooks.dataSource = self;
//    _mainView.allOfBooks.delegate = self;
//    _mainView.bookrack.delegate = self;
    self.view          = _mainView;
    
    // è®¾ç½®å¯¼èˆªæ å³ç®­å¤´
    [self setNavRightItemsWithState:YES];
}
- (void)setNavRightItemsWithState:(BOOL)normal{
    if (normal) {
        UIBarButtonItem *menuItem = [[UIBarButtonItem alloc] initWithTitle:@"ğŸ˜¯" style:UIBarButtonItemStylePlain target:self action:@selector(menuDropDown)];
        UIBarButtonItem *test = [[UIBarButtonItem alloc] initWithTitle:@"ğŸ˜ˆ" style:UIBarButtonItemStylePlain target:self action:@selector(test)];
        
        self.navigationItem.rightBarButtonItems = @[menuItem,test];
    }else{
        if (self.navigationItem.rightBarButtonItems.count == 2) {
            self.navigationItem.rightBarButtonItems = nil;
        UIBarButtonItem *doneItem = [[UIBarButtonItem alloc] initWithTitle:@"\ue018" style:UIBarButtonItemStylePlain target:self action:@selector(editDone)];
        self.navigationItem.rightBarButtonItem = doneItem;
        }
    }
}
- (void)menuDropDown{// å±•å¼€ä¸‹æ‹‰èœå•

}
- (void)test{
    // å¾…å®š
}
- (void)editDone{
    [self setNavRightItemsWithState:YES];
    // å›è°ƒ,å‘Šè¯‰flow layout ç»“æŸ ç¼–è¾‘
    if (self.editDoneBlock) {
        self.editDoneBlock();
    }
}


- (void)createNavLeftBackItem{
    
}


@end
