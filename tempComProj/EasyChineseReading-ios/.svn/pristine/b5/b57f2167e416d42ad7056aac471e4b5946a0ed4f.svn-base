
//  UCMessageVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/2.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UClassMessageVC.h"
#import "UserClassVC.h"

static NSInteger const kMaxMessageLength = 200;

@interface UClassMessageVC ()<UITextViewDelegate>

@property (nonatomic, strong) UITextView *txtDescribe;
@property (nonatomic, strong) UILabel *lblPlaceHolder;  // 用 label 仿制 placeHolder

@end

@implementation UClassMessageVC

- (void)viewDidLoad {
    [super viewDidLoad];
    [self configMessageView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark -

- (void)updateSystemLanguage
{
    self.title = LOCALIZATION(@"站内信");
    
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithTitle:LOCALIZATION(@"发送") style:UIBarButtonItemStyleDone target:self action:@selector(submitMessage)];
}

- (void)configMessageView
{
    _txtDescribe = [[UITextView alloc] initWithFrame:CGRectMake(20, 20, Screen_Width - 20 * 2, 200)];
    _txtDescribe.textColor = [UIColor cm_blackColor_333333_1];
    _txtDescribe.font = [UIFont systemFontOfSize:14.f];
    _txtDescribe.delegate = self;
    
    _txtDescribe.layer.borderColor = [UIColor cm_blackColor_333333_1].CGColor;
    _txtDescribe.layer.borderWidth = .5f;
    
    _lblPlaceHolder = [[UILabel alloc] initWithFrame:CGRectMake(26, 26, 100, 20)];
    _lblPlaceHolder.textColor = [UIColor cm_lineColor_D9D7D7_1];
    _lblPlaceHolder.font = [UIFont systemFontOfSize:14.f];
    _lblPlaceHolder.text = LOCALIZATION(@"请输入信息内容");
    
    [self.view addSubview:_txtDescribe];
    [self.view addSubview:_lblPlaceHolder];
}

#pragma mark - UITextViewDelegate

- (void)textViewDidChange:(UITextView *)textView
{
    _lblPlaceHolder.hidden = textView.text.length > 0;
}

- (BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range replacementText:(NSString *)text
{
    if ([text isEqualToString:@""]) {
        return YES;
    }
    if (range.length + range.location > textView.text.charLength) {
        return NO;
    }
    NSUInteger newLength = [textView.text charLength] + [text length] - range.length;
    
    return newLength <= kMaxMessageLength;
}

- (void)submitMessage
{
    if ([[_txtDescribe.text trim] empty]) {
        [self presentFailureTips:LOCALIZATION(@"请输入信息内容")];
        return;
    }
    NSString *userIds = [NSString string];
    for (NSInteger i = 0; i < _arrUsers.count; i ++) {
        UserModel *user = _arrUsers[i];
        userIds = [userIds stringByAppendingString:[NSString stringWithFormat:@"%ld,", user.userId]];
    }
    userIds = [userIds substringToIndex:userIds.length - 1];
    [[ClassRequest sharedInstance] sendMessageWithType:@"" name:[UserRequest sharedInstance].user.name message:_txtDescribe.text studentId:userIds completion:^(id object, ErrorModel *error) {
        if (error) {
            [self presentFailureTips:error.message];
        }
        else {
            [self presentSuccessTips:LOCALIZATION(@"发送成功")];
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                [self popToViewControllerWithController:[UserClassVC class] completionBlock:^{
                    
                }];
            });
        }
    }];
}


@end
