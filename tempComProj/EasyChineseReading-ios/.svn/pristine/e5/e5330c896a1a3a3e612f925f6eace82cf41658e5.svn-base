//
//  UserViewController.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/8/29.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserViewController.h"

#import "UserCollectionHeaderView.h"
#import "UserCollectionViewCell.h"

#import "LoginVC.h"                 // 登录
#import "UserInfoVC.h"              // 用户信息
#import "UserMessageVC.h"           // 消息
#import "UserSetVC.h"               // 设置
#import "UserIntegralVC.h"          // 积分
#import "UserVirtualCurrencyVC.h"   // 虚拟币

#import "UserOrderVC.h"             // 我的订阅
#import "UserRechargeVC.h"          // 我的钱包
#import "UserFavouriteVC.h"         // 我的收藏
#import "UserFriendVC.h"            // 我的好友
#import "UserClassVC.h"             // 班级管理
#import "UserTaskVC.h"              // 我的任务
#import "USecurityCenterVC.h"       // 安全中心
#import "UserHelpVC.h"              // 使用帮助

@interface UserViewController () <
UICollectionViewDelegate,
UICollectionViewDataSource,
UICollectionViewDelegateFlowLayout,
UserCollectionHeaderViewDelegate>

@property (strong, nonatomic) UICollectionViewFlowLayout *layout;
@property (strong, nonatomic) UICollectionView *collectionView;

// collection view
@property (strong, nonatomic) UserCollectionViewCell *cell;
@property (strong, nonatomic) UserCollectionHeaderView *headerView;

// collection数据 跳转界面的数组
@property (strong, nonatomic) NSArray *arrControllers;

// 用户信息
@property (nonatomic, strong) UserRequest *userRequest;

@end

static CGFloat const kCellPlace = 10.f; // 间隔

@implementation UserViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.view.backgroundColor = [UIColor whiteColor];
    
    _userRequest = [UserRequest sharedInstance];

    [self configNavigationBar];
    [self registerCollection];
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    [self.collectionView reloadData];
}

#pragma mark - 配置界面

- (void)configNavigationBar
{
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"person17"]
                                                                              style:UIBarButtonItemStylePlain
                                                                             target:self
                                                                             action:@selector(setting)];
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"person18"]
                                                                             style:UIBarButtonItemStylePlain
                                                                            target:self
                                                                            action:@selector(viewMessage)];
    self.navigationController.navigationBar.tintColor = [UIColor cm_blackColor_333333_1];
}

- (void)registerCollection
{
    [self.collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UserCollectionViewCell class])
                                                    bundle:nil]
          forCellWithReuseIdentifier:NSStringFromClass([UserCollectionViewCell class])];
    [self.collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UserCollectionHeaderView class])
                                                    bundle:nil]
          forSupplementaryViewOfKind:UICollectionElementKindSectionHeader
                 withReuseIdentifier:NSStringFromClass([UserCollectionHeaderView class])];
}

- (void)createNavLeftBackItem
{
    // 重写父类方法 取消左侧返回按钮button
}

#pragma mark - 获取数据

//- (void)getUserInfo
//{
//    _userRequest = [UserRequest sharedInstance];
//    [_userRequest getUserInfoWithUserId:[NSString stringWithFormat:@"%ld", (long)_userRequest.user.userId]
//                             completion:^(id object, ErrorModel *error) {
//                                 if (error) {
//                                     [self presentFailureTips:error.message];
//                                 }
//                                 else {
//                                     _userRequest.user = object;
//                                     [_collectionView reloadData];
//                                 }
//                             }];
//}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - UICollectionViewDataSource

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    return self.arrControllers.count;
}

- (__kindof UICollectionViewCell *)collectionView:(UICollectionView *)collectionView
                           cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    self.cell = [collectionView dequeueReusableCellWithReuseIdentifier:@"UserCollectionViewCell"
                                                          forIndexPath:indexPath];
    _cell.data = self.arrControllers[indexPath.row];
    return _cell;
}

#pragma mark - UICollectionViewDelegate

- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView
           viewForSupplementaryElementOfKind:(NSString *)kind
                                 atIndexPath:(NSIndexPath *)indexPath {
    self.headerView = (UserCollectionHeaderView *)[collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionHeader
                                                                                     withReuseIdentifier:NSStringFromClass([UserCollectionHeaderView class])
                                                                                            forIndexPath:indexPath];
    _headerView.delegate = self;
    _headerView.data = _userRequest.user;
    return _headerView;
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    if (0 == indexPath.row) {
        UserOrderVC *order = [UserOrderVC new];
        [self.navigationController pushViewController:order animated:YES];
    }
    else if (4 == indexPath.row) {
        [self pushToViewControllerWithStoryBoard:@"UserClass"
                                withStoryBoardId:NSStringFromClass([UserClassVC class])];
    }
    else
        [self pushToViewControllerWithIndex:indexPath.row];
}

#pragma mark - UserCollectionHeaderViewDelegate
/** 更换头像 */
- (void)tapAvatar
{
    // TODO: 登录 未登录 操作 未明确
    if ([_userRequest online]) {
        [self pushVCWithStoryBoardId:NSStringFromClass([UserInfoVC class])];
    }
    else {
        [self pushToViewControllerWithClassName:NSStringFromClass([LoginVC class])];
    }
}
/** 登录或修改个人信息 */
- (void)tapLoginOrUserInfo
{
    if ([_userRequest online]) {
        [self pushVCWithStoryBoardId:NSStringFromClass([UserInfoVC class])];
    }
    else {
        [self pushToViewControllerWithClassName:NSStringFromClass([LoginVC class])];
    }
}
/** 积分 */
- (void)tapIntegral
{
    if ([_userRequest online]) {
        UserIntegralVC *intergral = [UserIntegralVC loadFromStoryBoard:NSStringFromClass([UserIntegralVC class])];
        intergral.userId = _userRequest.user.userId;
        [self.navigationController pushViewController:intergral animated:YES];
    }
}
/** 虚拟币 */
- (void)tapVirtualCurrency
{
    if ([_userRequest online]) {
        [self pushVCWithStoryBoardId:NSStringFromClass([UserVirtualCurrencyVC class])];
    }
}
/** 晒一晒 */
- (void)shareMyReadingInfomation
{
    if ([_userRequest online]) {
        // TODO: 晒一晒接口
    }
    else {
        [self pushToViewControllerWithClassName:NSStringFromClass([LoginVC class])];
    }
}

#pragma mark - 界面跳转

- (void)setting
{
    [self pushVCWithStoryBoardId:NSStringFromClass([UserSetVC class])];
}

- (void)viewMessage
{
    [self pushVCWithStoryBoardId:NSStringFromClass([UserMessageVC class])];
}

- (void)pushToViewControllerWithIndex:(NSInteger)index
{
    NSDictionary *dic = [_arrControllers objectAtIndex:index];
    NSString *className = [dic objectForKey:@"class"];
    [self pushToViewControllerWithStoryBoard:@"User" withStoryBoardId:className];
}

- (void)pushVCWithStoryBoardId:(NSString *)VCId
{
    [self pushToViewControllerWithStoryBoard:@"User" withStoryBoardId:VCId];
}

#pragma mark - 属性

- (UICollectionViewFlowLayout *)layout
{
    if (!_layout) {
        _layout = [[UICollectionViewFlowLayout alloc] init];
        _layout.minimumLineSpacing = kCellPlace;
        _layout.minimumInteritemSpacing = kCellPlace;
        _layout.sectionInset = UIEdgeInsetsMake(kCellPlace, kCellPlace, kCellPlace, kCellPlace);
        _layout.headerReferenceSize = CGSizeMake(Screen_Width, 320);
        
        CGFloat itemWidth = (Screen_Width - kCellPlace * 5) / 4;
        CGFloat itemHeight = itemWidth;
        // 如果屏幕尺寸小于等于4寸（5s） collectionCell 的高度增高
        if ([IPhoneVersion deviceSize] <= iPhone4inch) {
            itemHeight = itemHeight + 30;
        }
        _layout.itemSize = CGSizeMake(itemWidth, itemHeight);
    }
    return _layout;
}

- (UICollectionView *)collectionView
{
    if (!_collectionView) {
        _collectionView = [[UICollectionView alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, self.view.height - cHeaderHeight_64)
                                             collectionViewLayout:self.layout];
        _collectionView.delegate = self;
        _collectionView.dataSource = self;
        _collectionView.backgroundColor = [UIColor whiteColor];
        [self.view addSubview:_collectionView];
    }
    return _collectionView;
}

- (NSArray *)arrControllers
{
    if (!_arrControllers) {
        _arrControllers = @[@{@"class": NSStringFromClass([UserOrderVC class]),@"title": @"我的订阅", @"image": @"person2"},
                            @{@"class": NSStringFromClass([UserFavouriteVC class]),@"title": @"我的收藏", @"image": @"person3"},
                            @{@"class": NSStringFromClass([UserRechargeVC class]),@"title": @"我的钱包", @"image": @"person4"},
                            @{@"class": NSStringFromClass([UserFriendVC class]),@"title": @"我的好友", @"image": @"person5"},
                            @{@"class": NSStringFromClass([UserClassVC class]),@"title": @"我的班级", @"image": @"person6"},
                            @{@"class": NSStringFromClass([UserTaskVC class]),@"title": @"我的任务", @"image": @"person7"},
                            @{@"class": NSStringFromClass([USecurityCenterVC class]),@"title": @"安全中心", @"image": @"person8"},
                            @{@"class": NSStringFromClass([UserHelpVC class]),@"title": @"使用帮助", @"image": @"person9"},
                            ];
        if (_userRequest.user.userType == ENUM_UserTypeTeacher) {
            NSMutableArray *array = [NSMutableArray arrayWithArray:_arrControllers];
            [array removeObjectAtIndex:4];
            _arrControllers = [NSArray arrayWithArray:array];
        }
    }
    return _arrControllers;
}

@end
