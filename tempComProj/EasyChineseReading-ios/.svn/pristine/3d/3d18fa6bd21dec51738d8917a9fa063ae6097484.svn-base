//
//  UserLeaseTicketsTableViewCell.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/11/22.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "UserLeaseTicketsTableViewCell.h"
#import "ULeaseBookCollectionViewCell.h"

static CGFloat const kCellPlace = 10;
static CGFloat const kCollectionHeight_pad   = 200;
static CGFloat const kCollectionHeight_phone = 140;

@interface UserLeaseTicketsTableViewCell () <UICollectionViewDelegate, UICollectionViewDataSource, UICollectionViewDelegateFlowLayout>

@property (weak, nonatomic) IBOutlet UILabel *lblLeaseEndTime;  // 截止时间
@property (weak, nonatomic) IBOutlet UICollectionView *collectionView;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *collectionHeightConstraint;

@property (nonatomic, strong) UICollectionViewFlowLayout *layout; // collection layout

@property (nonatomic, strong) NSArray *arrBooks;

@property (strong, nonatomic) TicketBookModel *ticket;

@end

@implementation UserLeaseTicketsTableViewCell

- (void)awakeFromNib {
    [super awakeFromNib];
    // Initialization code
    [self configLeaseTableCell];
    [self configCollectionView];
}

- (void)setSelected:(BOOL)selected animated:(BOOL)animated {
    [super setSelected:selected animated:animated];
    
    // Configure the view for the selected state
}

#pragma mark - 配置界面

- (void)configLeaseTableCell
{
    _lblLeaseEndTime.textColor  = [UIColor cm_blackColor_666666_1];
    _lblLeaseEndTime.font  = [UIFont systemFontOfSize:cFontSize_14];
    
    _collectionView.layer.borderColor = [UIColor cm_lineColor_D9D7D7_1].CGColor;
    _collectionView.layer.borderWidth = .5f;
}

- (void)configCollectionView
{
    //    if () {
    _collectionHeightConstraint.constant = kCollectionHeight_pad; //ipad
    //    }
    //    else {
    //        _collectionHeightConstraint.constant = 140; //iphone
    //    }
    _collectionView.scrollEnabled = NO;
    _collectionView.collectionViewLayout = self.layout;
    
    [_collectionView registerClass:[ULeaseBookCollectionViewCell  class] forCellWithReuseIdentifier:NSStringFromClass([ULeaseBookCollectionViewCell  class])];
}

#pragma mark - 更新数据

- (void)dataDidChange
{
    _ticket = [TicketBookModel mj_objectWithKeyValues:self.data];
    _lblLeaseEndTime.text = [NSString stringWithFormat:@"%@: %@", LOCALIZATION(@"到期时间"), _ticket.endTime];
    [_collectionView reloadData];
}

#pragma mark - UICollectionViewDataSource

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    NSInteger max = 5;
    return _ticket.books.count > max ? max : _ticket.books.count;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath
{
    ULeaseBookCollectionViewCell *bookCell = [collectionView dequeueReusableCellWithReuseIdentifier:NSStringFromClass([ULeaseBookCollectionViewCell class]) forIndexPath:indexPath];
    bookCell.data = _ticket.books.count > 0 ? _ticket.books[indexPath.row] : nil;
    return bookCell;
}

#pragma mark - UICollectionViewDelegate

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    self.toTicketsBooksListView();
}

#pragma mark - UICollectionViewDelegateFlowLayout

- (UICollectionViewFlowLayout *)layout
{
    if (!_layout) {
        _layout = [[UICollectionViewFlowLayout alloc] init];
        
        CGFloat itemWidth = (Screen_Width - 12*2 - kCellPlace*6 - 2)/5;
        CGFloat itemHeight = kCollectionHeight_pad - kCellPlace*2;
        
        _layout.minimumLineSpacing =  kCellPlace;
        _layout.minimumInteritemSpacing = kCellPlace;
        _layout.sectionInset = UIEdgeInsetsMake(kCellPlace, kCellPlace, kCellPlace, kCellPlace);
        _layout.itemSize = CGSizeMake(itemWidth, itemHeight);
    }
    return _layout;
}

@end
