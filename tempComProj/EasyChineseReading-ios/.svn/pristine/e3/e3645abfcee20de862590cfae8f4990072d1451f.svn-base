//
//  UserViewController.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/8/29.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserViewController.h"

#import "UserRequest.h"

#import "UserCollectionHeaderView.h"
#import "UserCollectionViewCell.h"

#import "UserClassVC.h"
#import "UserFavouriteVC.h"
#import "UserFriendVC.h"
#import "UserInfoVC.h"
#import "UserMessageVC.h"
#import "UserOrderVC.h"
#import "UserScoreVC.h"
#import "USecurityCenterVC.h"
#import "UserSetVC.h"
#import "UserTaskVC.h"
#import "UserLeaseVC.h"
#import "UserIntegralVC.h"
#import "UserVirtualCurrencyVC.h"
#import "UserHelpVC.h"
#import "UserRechargeVC.h"
#import "LoginVC.h"

@interface UserViewController ()
<UICollectionViewDelegate, UICollectionViewDataSource, UICollectionViewDelegateFlowLayout, UserCollectionHeaderViewDelegate>

@property (strong, nonatomic) UICollectionViewFlowLayout *layout;
@property (strong, nonatomic) UICollectionView *collectionView;
@property (strong, nonatomic) UserCollectionViewCell *cell;
@property (strong, nonatomic) UserCollectionHeaderView *headerView;
@property (strong, nonatomic) NSArray *arrControllers;

@property (nonatomic, strong) UserModel *user; // 用户信息

@end

static CGFloat const kCellPlace = 10.f; // 间隔

@implementation UserViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.view.backgroundColor = [UIColor whiteColor];
    [self configNavigationBar];
    [self registerCollection];
    [self getUserInfo];
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
}

#pragma mark - 配置界面

- (void)configNavigationBar
{
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"2"] style:UIBarButtonItemStylePlain target:self action:@selector(setting)];
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"2"] style:UIBarButtonItemStylePlain target:self action:@selector(viewMessage)];
    self.navigationController.navigationBar.tintColor = [UIColor cm_blackColor_333333_1];
}

- (void)registerCollection
{
    [self.collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UserCollectionViewCell class]) bundle:nil] forCellWithReuseIdentifier:NSStringFromClass([UserCollectionViewCell class])];
    [self.collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UserCollectionHeaderView class]) bundle:nil] forSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UserCollectionHeaderView class])];
}

#pragma mark - 获取数据

- (void)getUserInfo
{
    [[UserRequest sharedInstance] getUserInfoWithID:@"1" completion:^(id object, ErrorModel *error) {
        _user = object;
    }];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - UICollectionViewDataSource

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    return self.arrControllers.count;
}

- (__kindof UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    self.cell = [collectionView dequeueReusableCellWithReuseIdentifier:@"UserCollectionViewCell" forIndexPath:indexPath];
    _cell.data = self.arrControllers[indexPath.row];
    return _cell;
}

#pragma mark - UICollectionViewDelegate

- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath {
    self.headerView = (UserCollectionHeaderView *)[collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UserCollectionHeaderView class]) forIndexPath:indexPath];
    _headerView.delegate = self;
    return _headerView;
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    if (0 == indexPath.row) {
        UserOrderVC *order = [UserOrderVC new];
        [self.navigationController pushViewController:order animated:YES];
    }
    else if (4 == indexPath.row) {
        [self pushToViewControllerWithStoryBoard:@"UserClass" withStoryBoardId:NSStringFromClass([UserClassVC class])];
    }
    else
        [self pushToViewControllerWithIndex:indexPath.row];
}

#pragma mark - UserCollectionHeaderViewDelegate

- (void)tapAvatar
{
    [self pushVCWithId:NSStringFromClass([UserInfoVC class])];
}

- (void)tapLoginOrUserInfo
{
    [self pushToViewControllerWithClassName:NSStringFromClass([LoginVC class])];
}
// 积分
- (void)tapIntegral
{
    [self pushVCWithId:NSStringFromClass([UserIntegralVC class])];
}
// 虚拟币
- (void)tapVirtualCurrency
{
    [self pushVCWithId:NSStringFromClass([UserVirtualCurrencyVC class])];
}

#pragma mark - 界面跳转


- (void)setting
{
    [self pushVCWithId:NSStringFromClass([UserSetVC class])];
}

- (void)viewMessage
{
    [self pushVCWithId:NSStringFromClass([UserMessageVC class])];
}

- (void)pushToViewControllerWithIndex:(NSInteger)index
{
    NSDictionary *dic = [_arrControllers objectAtIndex:index];
    NSString *className = [dic objectForKey:@"class"];
    [self pushToViewControllerWithStoryBoard:@"User" withStoryBoardId:className];
}

- (void)pushVCWithId:(NSString *)VCId
{
    [self pushToViewControllerWithStoryBoard:@"User" withStoryBoardId:VCId];
}

#pragma mark - 属性

- (UICollectionViewFlowLayout *)layout
{
    if (!_layout) {
        _layout = [[UICollectionViewFlowLayout alloc] init];
        _layout.minimumLineSpacing = kCellPlace;
        _layout.minimumInteritemSpacing = kCellPlace;
        CGFloat itemWidth = (Screen_Width - kCellPlace * 5) / 4;
        _layout.itemSize = CGSizeMake(itemWidth, itemWidth);
        _layout.sectionInset = UIEdgeInsetsMake(kCellPlace, kCellPlace, kCellPlace, kCellPlace);
        _layout.headerReferenceSize = CGSizeMake(Screen_Width, 320);
    }
    return _layout;
}

- (UICollectionView *)collectionView
{
    if (!_collectionView) {
        _collectionView = [[UICollectionView alloc] initWithFrame:self.view.frame collectionViewLayout:self.layout];
        _collectionView.delegate = self;
        _collectionView.dataSource = self;
        _collectionView.backgroundColor = [UIColor whiteColor];
        [self.view addSubview:_collectionView];
    }
    return _collectionView;
}

- (NSArray *)arrControllers
{
    if (!_arrControllers) {
        _arrControllers = @[@{@"class": NSStringFromClass([UserOrderVC class]),@"title": @"我的订阅", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserFavouriteVC class]),@"title": @"我的收藏", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserRechargeVC class]),@"title": @"我的充值", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserFriendVC class]),@"title": @"我的好友", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserClassVC class]),@"title": @"我的班级", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserTaskVC class]),@"title": @"我的任务", @"image": @"2"},
                            @{@"class": NSStringFromClass([USecurityCenterVC class]),@"title": @"安全中心", @"image": @"2"},
                            @{@"class": NSStringFromClass([UserHelpVC class]),@"title": @"使用帮助", @"image": @"2"},
                            ];
        if (/* DISABLES CODE */ (0)) {
            NSMutableArray *array = [NSMutableArray arrayWithArray:_arrControllers];
            [array removeObjectAtIndex:4];
            _arrControllers = [NSArray arrayWithArray:array];
        }
    }
    return _arrControllers;
}

@end
