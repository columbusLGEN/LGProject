//
//  UFriendListViewController.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/10/12.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "UFriendListViewController.h"

#import "UFriendListTableViewCell.h"

#import "UFriendAddVC.h"
#import "UFriendInfoVC.h"

#import "ECRBookInfoViewController.h"

@interface UFriendListViewController ()<UITableViewDelegate, UITableViewDataSource>

@property (strong, nonatomic) UITableView *tableView;

@property (strong, nonatomic) NSMutableArray *arrDataSource;
@property (strong, nonatomic) NSMutableArray *arrFriendIds; // 好友 id 列表

@property (strong, nonatomic) EmptyView *emptyView;

@end

@implementation UFriendListViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self configHeaderView];
    [self configTableView];
    [self addEmptyView];
    [self getFriendsData];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - 获取数据

- (void)getFriendsData
{
    [[FriendRequest sharedInstance] getFriendListWithUserName:@"" completion:^(id object, ErrorModel *error) {
        
        if (error) {
            [self presentFailureTips:error.message];
        }
        else {
            _arrDataSource = [FriendModel mj_objectArrayWithKeyValuesArray:object];
            dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
                _arrFriendIds = [NSMutableArray array];
                [_arrDataSource enumerateObjectsUsingBlock:^(FriendModel *obj, NSUInteger idx, BOOL * _Nonnull stop) {
                    [_arrFriendIds addObject:@(obj.userId)];
                }];
                
                dispatch_async(dispatch_get_main_queue(), ^{
                    _emptyView.hidden = _arrDataSource.count > 0;
                    [[CacheDataSource sharedInstance] setCache:_arrDataSource withCacheKey:CacheKey_FriendsList];
                    [[CacheDataSource sharedInstance] setCache:_arrFriendIds withCacheKey:CacheKey_FriendIdsList];
                    [_tableView reloadData];
                });
            });
        }
    }];
}

#pragma mark - 配置界面

- (void)configHeaderView
{
    UIView *headerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, cHeaderHeight_44)];
    headerView.backgroundColor = [UIColor whiteColor];
    
    UIButton *btnAddFriend = [[UIButton alloc] initWithFrame:CGRectMake(Screen_Width - 120, 5, 120, cHeaderHeight_44 - 5*2)];
    btnAddFriend.titleLabel.font = [UIFont systemFontOfSize:14.f];
    [btnAddFriend setImage:[UIImage imageNamed:@"friend2"] forState:UIControlStateNormal];
    [btnAddFriend setTitle:@"添加好友" forState:UIControlStateNormal];
    [btnAddFriend setTitleColor:[UIColor cm_blackColor_333333_1] forState:UIControlStateNormal];
    [btnAddFriend addTarget:self action:@selector(addFriendHandle) forControlEvents:UIControlEventTouchUpInside];
    
    [headerView addSubview:btnAddFriend];
    [self.view addSubview:headerView];
}

- (void)configTableView
{
    _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, cHeaderHeight_44, Screen_Width, Screen_Height - 2*cHeaderHeight_44 - cHeaderHeight_64) style:UITableViewStylePlain];
    _tableView.delegate = self;
    _tableView.dataSource = self;
    
    _tableView.backgroundColor = [UIColor whiteColor];
    
    // tableView 自适应高度
    self.tableView.rowHeight = UITableViewAutomaticDimension;
    self.tableView.estimatedRowHeight = 100;
    
    [self.view addSubview:_tableView];
    
    [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([UFriendListTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([UFriendListTableViewCell class])];
}

- (void)addEmptyView
{
    _emptyView = [EmptyView loadFromNibWithFrame:CGRectMake(0, cHeaderHeight_44, self.view.width, self.view.height - cHeaderHeight_44)];
    [_emptyView updateEmptyViewWithType:ENUM_EmptyResultTypeFriend Image:nil desc:nil subDesc:nil];
    [self.view addSubview:_emptyView];
}

- (void)addFriendHandle
{
    UFriendAddVC *friendInfo = [UFriendAddVC loadFromStoryBoard:@"User"];
    friendInfo.addFriendSuccess = ^(FriendModel *user) {
        [_arrDataSource addObject:user];
        [_arrFriendIds addObject:@(user.userId)];
        [[CacheDataSource sharedInstance] setCache:_arrDataSource withCacheKey:CacheKey_FriendsList];
        [[CacheDataSource sharedInstance] setCache:_arrFriendIds withCacheKey:CacheKey_FriendIdsList];
        [_tableView reloadData];
    };
    [self.navigationController pushViewController:friendInfo animated:YES];
}

#pragma mark - UITableViewDataSource

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return self.arrDataSource.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UFriendListTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:NSStringFromClass([UFriendListTableViewCell class])];
    cell.data = _arrDataSource[indexPath.row];
    return cell;
}

#pragma mark - UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    FriendModel *friend = _arrDataSource[indexPath.row];
    UFriendInfoVC *frinendInfo = [UFriendInfoVC loadFromStoryBoard:@"User"];
    frinendInfo.friendInfo = friend;
    [self.navigationController pushViewController:frinendInfo animated:YES];
}

- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section
{
    UIView *footerView = [UIView new];
    footerView.backgroundColor = [UIColor whiteColor];
    return footerView;
}

- (NSMutableArray *)arrDataSource
{
    if (_arrDataSource == nil) {
        _arrDataSource = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:CacheKey_FriendsList];
    }
    return _arrDataSource;
}

@end
