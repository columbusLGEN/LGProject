//
//  ECRHypermediaManager.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/11/13.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRHypermediaManager.h"
#import "DBPlayer.h"
#import "ReaderViewController.h"
#import "ECRMentionBoy.h"

#if TARGET_IPHONE_SIMULATOR
// MARK: 模拟器1
@interface ECRHypermediaManager ()<
ReaderViewControllerDelegate
>

#else
// MARK: 真机1
@interface ECRHypermediaManager ()<
DBPlayerDelegate,
ReaderViewControllerDelegate
>

#endif

@property (strong,nonatomic) ReaderViewController *pdfReader;//
/** DB当前书籍总页数 */
@property (assign,nonatomic) NSInteger totalPages;//

@end

@implementation ECRHypermediaManager

#if TARGET_IPHONE_SIMULATOR
// MARK: 模拟器1


#else
// MARK: 真机1
+ (void)openHypermidiaWithURL:(NSString *)hyperURL vc:(UIViewController *)vc{
    [[self sharedInstance] openHypermidiaWithURL:hyperURL vc:vc];
}

- (void)openHypermidiaWithURL:(NSString *)hyperURL vc:(UIViewController *)vc{
    [vc presentViewController:self.dbPlayer animated:YES completion:^{
        [ECRMentionBoy mentionUser];
        [self.dbPlayer openABook:hyperURL contentUrl:@""];
        self.totalPages = [self.dbPlayer getTotalNumberOfPages];
        NSLog(@"openHypermidiaWithURL total -- %ld",self.totalPages);
    }];
}

#pragma mark - DBPlayerDelegate
- (void)dbPlayerDidClosed{
    self.totalPages = [self.dbPlayer getTotalNumberOfPages];
    NSLog(@"dbPlayerDidClosed total -- %ld",self.totalPages);
    // 当前页数
    NSInteger currentPage = [self.dbPlayer getCurrentPageIndex];
    // 计算进度
    CGFloat progress = currentPage / self.totalPages;

    NSLog(@"curre -- %ld",currentPage);
    NSLog(@"progress -- %f",progress);
    
    [self.dbPlayer dismissViewControllerAnimated:YES completion:^{
        self.totalPages = [self.dbPlayer getTotalNumberOfPages];
        NSLog(@"dismissViewControllerAnimated total -- %ld",self.totalPages);
        // 显示状态栏
        self.dbPlayer = nil;// 一定要释放前一个 player，否则会造成屏幕错位
        [ECRMentionBoy cancelMention];
    }];
}

- (DBPlayer *)dbPlayer{
    if (_dbPlayer == nil) {
        _dbPlayer = [[DBPlayer alloc]init];
        _dbPlayer.delegate = self;
        _dbPlayer.modalTransitionStyle = UIModalTransitionStyleFlipHorizontal;
    }
    return _dbPlayer;
}

#endif

+ (instancetype)sharedInstance{
    static id instance;
    static dispatch_once_t once;
    dispatch_once(&once, ^{
        instance = [self new];
    });
    return instance;
}

// 返回 pdf 阅读器
+ (ReaderViewController *)openPDFWithURL:(NSString *)URLString book:(BookModel *)book{
    return [[self sharedInstance] openPDFWithURL:URLString book:book];
}
- (ReaderViewController *)openPDFWithURL:(NSString *)URLString book:(BookModel *)book{
    ReaderDocument *doc = [[ReaderDocument alloc] initWithFilePath:URLString password:nil];
    [doc setValue:book.bookName forKey:@"fileName"];
    self.pdfReader = [[ReaderViewController alloc] initWithReaderDocument:doc];
    self.pdfReader.delegate = self;
    [ECRMentionBoy mentionUser];
    return self.pdfReader;
}

#pragma mark - 退出PDF阅读时 ReaderViewControllerDelegate
- (void)dismissReaderViewController:(ReaderViewController *)viewController{
    [self.pdfReader dismissViewControllerAnimated:YES completion:^{
        // 退出pdf阅读器的回调
        NSLog(@"退出PDF -- ");
        [ECRMentionBoy cancelMention];
    }];
}


@end
