//
//  ShareBookView.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/10/20.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ShareBookView.h"

static id instance = nil;

@interface ShareBookView ()

//  蒙版及分享 view

@property (weak, nonatomic) IBOutlet UIView *viewShareBook;         // 分享
@property (weak, nonatomic) IBOutlet UIView *viewShareBookLine;     // 分享底部的线
@property (weak, nonatomic) IBOutlet UIView *viewShareBookScore;    // 评星

@property (weak, nonatomic) IBOutlet UILabel *lblShareBookName;     // 书名
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookAuthor;   // 作者
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookPrice;    // 价格
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookCancel;   // 取消
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookSend;     // 发送

@property (weak, nonatomic) IBOutlet UIImageView *imgShareBook;     // 封面
@property (weak, nonatomic) IBOutlet UITextView  *txtvShareBookContent; // 分享的说明

@property (assign, nonatomic) NSInteger shareType; // 分享的类型 (0好友 1动态)

@property (strong, nonatomic) BookModel *book;

@end

@implementation ShareBookView

/**
 *  开放实体单例
 */
+ (instancetype)sharedInstance
{
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        instance = [ShareBookView loadFromNibWithFrame:CGRectMake(0, 0, Screen_Width, Screen_Height)];
    });
    return instance;
}

- (void)awakeFromNib
{
    [super awakeFromNib];
    [self configShareBookView];
}

#pragma mark - 配置界面

- (void)configShareBookView
{
    self.backgroundColor                = [UIColor cm_blackColor_000000_3F];
    _viewShareBook.backgroundColor      = [UIColor whiteColor];
    _lblShareBookSend.backgroundColor   = [UIColor cm_purpleColor_82056B_1];
    _lblShareBookCancel.backgroundColor = [UIColor whiteColor];
    
    _lblShareBookName.textColor   = [UIColor cm_blackColor_333333_1];
    _lblShareBookAuthor.textColor = [UIColor cm_blackColor_666666_1];
    _lblShareBookPrice.textColor  = [UIColor cm_orangeColor_FF6000_1];
    _lblShareBookCancel.textColor = [UIColor cm_purpleColor_82056B_1];
    _lblShareBookSend.textColor   = [UIColor whiteColor];
    
    _lblShareBookName.font   = [UIFont systemFontOfSize:cFontSize_16];
    _lblShareBookAuthor.font = [UIFont systemFontOfSize:cFontSize_16 - 2];
    _lblShareBookPrice.font  = [UIFont systemFontOfSize:cFontSize_16 - 2];
    _lblShareBookCancel.font = [UIFont systemFontOfSize:cFontSize_16];
    _lblShareBookSend.font   = [UIFont systemFontOfSize:cFontSize_16];
    
    _txtvShareBookContent.textColor = [UIColor cm_blackColor_333333_1];
    _txtvShareBookContent.font      = [UIFont systemFontOfSize:cFontSize_16];
    
    _txtvShareBookContent.layer.borderColor = [UIColor cm_lineColor_E3E3E3_1].CGColor;
    _txtvShareBookContent.layer.borderWidth = 1.f;
    
    _lblShareBookSend.userInteractionEnabled   = YES;
    _lblShareBookCancel.userInteractionEnabled = YES;
    
    UITapGestureRecognizer *tapCancel   = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(cancelShareBook)];
    UITapGestureRecognizer *tapSend     = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(sendShareBook)];

    [_lblShareBookCancel addGestureRecognizer:tapCancel];
    [_lblShareBookSend   addGestureRecognizer:tapSend];
    
    [self fk_observeNotifcation:kNotificationShareBookToDynamic usingBlock:^(NSNotification *note) {
        [self hidden];
    }];
    
    [self fk_observeNotifcation:kNotificationShareBookToFriend usingBlock:^(NSNotification *note) {
        [self hidden];
    }];
    [_txtvShareBookContent becomeFirstResponder];
}

#pragma mark - 获取界面

- (void)dataDidChange
{
    _book = self.data;
    
    [_imgShareBook sd_setImageWithURL:[NSURL URLWithString:_book.iconUrl] placeholderImage:[UIImage imageNamed:@"ban4"]];
    _lblShareBookName.text = _book.bookName;
    _lblShareBookAuthor.text = [NSString stringWithFormat:@"作者: %@", _book.author];
    _lblShareBookPrice.text = [NSString stringWithFormat:@"%@%.2f", @"¥", _book.price];
    
    ZStarView *star = [[ZStarView alloc] initWithFrame:CGRectMake(0, 0, _viewShareBookScore.height*5, _viewShareBookScore.height) numberOfStar:5];
    star.canChange = NO;
    [_viewShareBookScore addSubview:star];
    
    [star setScore:_book.score withAnimation:NO completion:^(BOOL finished) {
        // 设置
    }];
}

#pragma mark - 操作

- (void)cancelShareBook
{
    [self hidden];
}

- (void)sendShareBook
{
    [self.delegate shareBookWithBook:_book content:_txtvShareBookContent.text type:_type];
    [self hidden];
}

- (void)show
{
    UIWindow *window = [UIApplication sharedApplication].keyWindow;
    [window addSubview:self];

    self.alpha = 0;
    [UIView animateWithDuration:cAnimationTime delay:0 options:UIViewAnimationOptionCurveEaseIn animations:^{
        self.alpha = 1;
    } completion:^(BOOL finished) {

    }];
}

- (void)hidden
{
    //    UIWindow *window = [AppDelegate sharedInstance].window;
    [UIView animateWithDuration:cAnimationTime delay:0 options:UIViewAnimationOptionCurveEaseOut animations:^{
        self.alpha = 0;
    } completion:^(BOOL finished){
        if (finished) {
        [self removeFromSuperview];
//            window.rootViewController.view.userInteractionEnabled = YES;
        }
    }];
}

@end
