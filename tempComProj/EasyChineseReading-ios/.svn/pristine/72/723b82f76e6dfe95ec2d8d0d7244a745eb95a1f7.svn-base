//
//  UCMAddVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/2.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UClassManagerAddVC.h"

@interface UClassManagerAddVC () <
UITextFieldDelegate,
ZPickViewDelegate
>

@property (weak, nonatomic) IBOutlet UILabel *lblDescClassName;
@property (weak, nonatomic) IBOutlet UILabel *lblDescClassNumber;
@property (weak, nonatomic) IBOutlet UILabel *lblDescClassDescribe;
@property (weak, nonatomic) IBOutlet UILabel *lblDescTeacher;
@property (weak, nonatomic) IBOutlet UILabel *lblTeacher;

@property (weak, nonatomic) IBOutlet UITextField *txtfClassName;
@property (weak, nonatomic) IBOutlet UITextField *txtClassNumber;
@property (weak, nonatomic) IBOutlet UITextField *txtClassDescribe;

@property (weak, nonatomic) IBOutlet UITableViewCell *cellSelectedTeacher;
@property (weak, nonatomic) IBOutlet UIImageView *imgRightArrow;

@property (strong, nonatomic) ZPickView *pickView; // 选择教师
@property (strong, nonatomic) NSArray *arrTeacher; // 教师数组

@property (strong, nonatomic) UserModel *teacher; // 教师

@property (strong, nonatomic) NSMutableArray *arrClass; // 班级

@end

@implementation UClassManagerAddVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self configAddView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)updateSystemLanguage
{
    self.title = LOCALIZATION(@"班级信息");
    
    _lblDescClassName.text     = [NSString stringWithFormat:@"%@: ", LOCALIZATION(@"班级名称")];
    _lblDescClassNumber.text   = [NSString stringWithFormat:@"%@: ", LOCALIZATION(@"班级人数")];
    _lblDescClassDescribe.text = [NSString stringWithFormat:@"%@: ", LOCALIZATION(@"班级概况")];
    _lblDescTeacher.text       = [NSString stringWithFormat:@"%@: ", LOCALIZATION(@"班主任")];
    
    _txtfClassName.placeholder    = LOCALIZATION(@"");
    _txtClassNumber.placeholder   = LOCALIZATION(@"");
    _txtClassDescribe.placeholder = LOCALIZATION(@"");
}

- (void)configAddView
{
    _lblDescClassName.textColor     = [UIColor cm_blackColor_333333_1];
    _lblDescClassNumber.textColor   = [UIColor cm_blackColor_333333_1];
    _lblDescClassDescribe.textColor = [UIColor cm_blackColor_333333_1];
    _lblDescTeacher.textColor       = [UIColor cm_blackColor_333333_1];
    _lblTeacher.textColor           = [UIColor cm_blackColor_333333_1];
    
    UIColor *color = _classType == ENUM_UpdateTypeNo ? [UIColor cm_grayColor__807F7F_1] : [UIColor cm_blackColor_333333_1];
    _imgRightArrow.hidden = _classType == ENUM_UpdateTypeNo;

    _lblTeacher.textColor        = color;
    _txtfClassName.textColor     = color;
    _txtClassNumber.textColor    = color;
    _txtClassDescribe.textColor  = color;
    
    if (_classType > 0) {
        [self configNavigationItem];
    }
    
    if ([self.classInfo.teacherName notEmpty]) {
        _lblTeacher.text = _classInfo.teacherName;
    }
    else {
        NSArray *arrTeacher = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:CacheKey_TeacherList];
        [arrTeacher enumerateObjectsUsingBlock:^(UserModel *teacher, NSUInteger idx, BOOL * _Nonnull stop) {
            if (_classInfo.teacherId == teacher.userId) {
                _lblTeacher.text = teacher.name;
                *stop = YES;
            }
        }];
    }
    
    _txtfClassName.text = _classInfo.className;
    _txtClassNumber.text = _classInfo.studentNum > 0 ? [NSString stringWithFormat:@"%ld", _classInfo.studentNum] : @"";
    _txtClassDescribe.text = _classInfo.synopsis;
    
    _cellSelectedTeacher.selectionStyle = _classType == ENUM_UpdateTypeNo ? UITableViewCellSelectionStyleNone : UITableViewCellSelectionStyleDefault;
}

- (void)configNavigationItem
{
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithTitle:LOCALIZATION(@"保存") style:UIBarButtonItemStylePlain target:self action:@selector(save)];
}

- (void)save
{
    if (_classInfo.teacherId == 0) {
        [self presentFailureTips:LOCALIZATION(@"请选择班主任")];
        return;
    }
    if ([_txtfClassName.text empty]) {
        [self presentFailureTips:LOCALIZATION(@"请输入班级名")];
        return;
    }
    if (![_txtClassNumber.text isNumber]) {
        [self presentFailureTips:LOCALIZATION(@"学生人数请输入数字")];
        return;
    }
    
    [[ClassRequest sharedInstance] updateClassInfoWithType:_classType
                                                   classId:_classType == ENUM_UpdateTypeAdd ? 0 : _classInfo.classId
                                                 teacherId:_classInfo.teacherId
                                                studentNum:[_txtClassNumber.text integerValue]
                                                 className:_txtfClassName.text
                                                 synopsis:_txtClassDescribe.text
                                                completion:^(id object, ErrorModel *error) {
                                                    if (error) {
                                                        [self presentFailureTips:error.message];
                                                    }
                                                    else {
                                                        if (_classType == ENUM_UpdateTypeAdd) {
                                                            self.arrClass = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:CacheKey_ClassesList];
                                                            
                                                            ClassModel *classInfo = [ClassModel new];
                                                            NSArray *classIds     = [NSDictionary mj_objectArrayWithKeyValuesArray:object];
                                                            classInfo.classId     = [[classIds firstObject][@"classId"] integerValue];
                                                            classInfo.teacherId   = _classInfo.teacherId;
                                                            classInfo.teacherName = _classInfo.teacherName;
                                                            classInfo.studentNum  = _txtClassNumber.text.integerValue;
                                                            classInfo.className   = _txtfClassName.text;
                                                            classInfo.synopsis    = _txtClassDescribe.text;
                                                            classInfo.teacherName = _lblTeacher.text;
                                                            
                                                            [_arrClass addObject:classInfo];
                                                            [[CacheDataSource sharedInstance] setCache:_arrClass withCacheKey:CacheKey_ClassesList];
                                                            [[NSNotificationCenter defaultCenter] fk_postNotification:kNotificationUpdateClasses];
                                                        }
                                                        else {
                                                            ClassModel *newClassInfo = [_classInfo copy];
                                                            
                                                            newClassInfo.teacherId   = _classInfo.teacherId;
                                                            newClassInfo.teacherName = _classInfo.teacherName;
                                                            newClassInfo.teacherName = _lblTeacher.text;
                                                            newClassInfo.studentNum  = _txtClassNumber.text.integerValue;
                                                            newClassInfo.className   = _txtfClassName.text;
                                                            newClassInfo.synopsis    = _txtClassDescribe.text;
                                                            
                                                            self.updateClassSuccess(newClassInfo);
                                                        }
                                                        [self.navigationController popViewControllerAnimated:YES];
                                                    }
                                                }];
}

/**
 教师选择
 */
- (void)configPickView
{
    if (_pickView == nil) {
        _pickView = [[ZPickView alloc] initWithFrame:self.view.bounds dataSource:self.arrTeacher selected:0];
        _pickView.delegates = self;
        [self.view addSubview:_pickView];
    }
    [self resignAllFirstResponder];
    [_pickView show];
}

- (void)resignAllFirstResponder
{
    [_txtfClassName    resignFirstResponder];
    [_txtClassNumber   resignFirstResponder];
    [_txtClassDescribe resignFirstResponder];
}

#pragma mark - UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (0 == indexPath.row && _classType != ENUM_UpdateTypeNo) {
        [tableView deselectRowAtIndexPath:indexPath animated:YES];
        [self configPickView];
    }
}

#pragma mark - UITextFieldDelegate

- (BOOL)textFieldShouldBeginEditing:(UITextField *)textField
{
    if (_pickView.showing == YES) {
        [_pickView hidden];
    }
    
//    if ([textField isEqual:_txtfClassName]) {
//        return _classType > 0;
//    }
//    else if ([textField isEqual:_txtClassNumber]) {
//        return _classType > 0;
//    }
//    else {
        return _classType > 0;
//    }
}

#pragma mark - ZPickViewDelegate

- (void)ZPickerViewCancel:(ZPickView *)picker
{
    [_pickView hidden];
}

- (void)ZPickerView:(ZPickView *)picker makeSureIndex:(NSInteger)index
{
    _teacher = _arrTeacher[index];
    _lblTeacher.text       = _teacher.name;
    _classInfo.teacherName = _teacher.name;
    _classInfo.teacherId   = _teacher.userId;
    [_pickView hidden];
}

#pragma mark - 属性

- (NSArray *)arrTeacher
{
    if (_arrTeacher == nil) {
        _arrTeacher = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:CacheKey_TeacherList];
    }
    return _arrTeacher;
}

- (ClassModel *)classInfo
{
    if (_classInfo == nil) {
        _classInfo = [ClassModel new];
    }
    return _classInfo;
}

@end
