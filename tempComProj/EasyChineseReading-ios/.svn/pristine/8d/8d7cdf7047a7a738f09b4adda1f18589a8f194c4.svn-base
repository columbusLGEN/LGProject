//
//  UInfoAddressViewController.m
//  EasyChineseReading-ios
//
//  Created by èµµæ˜¥é˜³ on 17/9/5.
//  Copyright Â© 2017å¹´ lee. All rights reserved.
//

#import "UserInfoAddressVC.h"

#import "ECRSearchTitleView.h"

@interface UserInfoAddressVC ()<UITableViewDelegate, UITableViewDataSource, ECRSearchTitleViewDelegate>

@property (strong, nonatomic) UITableView *tableView;

@property (strong, nonatomic) NSMutableArray *arrCountry;         // å›½å®¶æ•°ç»„
@property (strong, nonatomic) NSMutableArray *arrSearchs;         // å›½å®¶æœç´¢ç»“æœ
@property (strong, nonatomic) NSMutableArray *arrIndexTitles;     // å­—æ¯ç´¢å¼•
@property (strong, nonatomic) NSMutableArray *arrIndexCharacter;  // æ•°æ®å­—å…¸ï¼Œå¯¹åº”ç´¢å¼•

@property (strong, nonatomic) NSMutableDictionary *dicCountry;    // æ•°æ®æºå­—å…¸

@property (assign, nonatomic) BOOL isSearch; // æœç´¢ç»“æœ

@end

@implementation UserInfoAddressVC

- (void)viewDidLoad {
    [super viewDidLoad];
    [self configView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)configView
{
    [self getCountryData];
    [self setNavRighSearchItem];
}

#pragma mark - è·å–å›½å®¶

- (void)getCountryData
{
    __block NSArray *countrys = [NSArray array];
    [[UserRequest sharedInstance] getCountrysComplention:^(id object, ErrorModel *error) {
        if (error) {
            [self presentFailureTips:@"è·å–å›½å®¶åˆ—è¡¨å¤±è´¥"];
        }
        else {
            countrys = [CountryModel mj_objectArrayWithKeyValuesArray:object];
            _arrCountry = [NSMutableArray arrayWithArray:countrys];
            [self handleArrayWithArray:_arrCountry];

            [[CacheDataSource sharedInstance] setCache:_arrCountry withCacheKey:CacheKey_CountryList];
            _arrIndexCharacter = [_arrIndexCharacter sortedArrayUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) {
                return [obj1 compare:obj2]; //å‡åº
            }];
            
            _isSearch = NO;
            [self configAddressView];
        }
    }];
}

- (void)configAddressView
{
    UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, 44)];
    view.backgroundColor = [UIColor whiteColor];
    
    UILabel *currentCountry = [[UILabel alloc] initWithFrame:CGRectMake(10, 10, 200, 24)];
    currentCountry.backgroundColor = [UIColor whiteColor];
    [_arrCountry enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        CountryModel *country = [CountryModel mj_objectWithKeyValues:obj];
        if (country.id == [UserRequest sharedInstance].user.country) {
            currentCountry.text = [NSString stringWithFormat:@"å½“å‰å›½å®¶ï¼š%@", _language == 0 ? country.zh_name : country.en_name];
            *stop = YES;
        }
    }];
    
    [view addSubview:currentCountry];
    [self.view addSubview:view];
    
    _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, view.height + view.y, Screen_Width, self.view.height - view.height - view.y) style:UITableViewStylePlain];
    
    _tableView.sectionIndexBackgroundColor = [UIColor whiteColor];
    _tableView.sectionIndexColor = [UIColor cm_greenColor_21C0AE_1];
    _tableView.sectionIndexMinimumDisplayRowCount = 1;
    
    _tableView.delegate = self;
    _tableView.dataSource = self;
    
    // ç´¢å¼•èƒŒæ™¯é€æ˜

    [_tableView registerClass:[UITableViewCell class] forCellReuseIdentifier:@"cell"];
    
    [self.view addSubview:_tableView];
    
    [_tableView reloadData];
}

#pragma mark -
#pragma mark UITableViewDataSource

// åˆ†æ®µæ•°
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return _isSearch ? 1 : _arrIndexCharacter.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    NSInteger rowNumber = 0;
    if (_isSearch) {
        rowNumber = _arrSearchs.count;
    }
    else {
        if (self.arrIndexCharacter.count > section) {
            NSMutableArray *arrayTemp = (NSMutableArray *)[self.dicCountry objectForKey:[self.arrIndexCharacter objectAtIndex:section]];
            rowNumber = arrayTemp.count;
        }
    }
    return rowNumber;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"cell"];
    
    if (_isSearch) {
        CountryModel *country = [_arrSearchs objectAtIndex:indexPath.row];
        cell.textLabel.text = _language == ENUM_LanguageTypeChinese ? country.zh_name : country.en_name;
    }
    else {
        if (self.arrIndexCharacter.count > indexPath.section) {
            NSMutableArray *arrayTemp = (NSMutableArray *)[self.dicCountry objectForKey:[self.arrIndexCharacter objectAtIndex:indexPath.section]];
            if (arrayTemp.count > indexPath.row) {
                CountryModel *country = [arrayTemp objectAtIndex:indexPath.row];
                cell.textLabel.text = _language == ENUM_LanguageTypeChinese ? country.zh_name : country.en_name;
            }
        }
    }
    return cell;
}

#pragma mark -
#pragma mark UITableViewDelegate


- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 44.f;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (_isSearch) {
        self.selectedCountryBlock(_arrSearchs[indexPath.row]);
    }
    else {
        NSMutableArray *arrayTemp = (NSMutableArray *)[self.dicCountry objectForKey:[self.arrIndexCharacter objectAtIndex:indexPath.section]];
        if (arrayTemp.count > indexPath.row) {
            CountryModel *country = [arrayTemp objectAtIndex:indexPath.row];
            self.selectedCountryBlock(country);
        }
    }
    [self.navigationController popViewControllerAnimated:YES];
}

#pragma mark ---------- ç´¢å¼•ç›¸å…³ ----------

// å¤„ç†æ•°ç»„ï¼ŒæŒ‰å­—æ¯æ’åº
- (void)handleArrayWithArray:(NSArray *)array
{
    if (array) {
        // å½“åˆä¸ºä»€ä¹ˆè¦ç”¨åµŒå¥—éå†æœ‰ç‚¹å¿˜, å…ˆæ³¨é‡Šäº†
//        [array enumerateObjectsUsingBlock:^(CountryModel *obj, NSUInteger idx, BOOL *stop) {
//
//            // å·²ç»éå†è¿‡ï¼Œä¸éœ€è¦åœ¨éå†, è®©æ’åºåªæ‰§è¡Œä¸€æ¬¡
//            if ((![NSString isEmpty:obj.zh_name] && _language == ENUM_LanguageTypeChinese) || (![NSString isEmpty:obj.en_name] && _language == ENUM_LanguageTypeEnglish)) {
//                *stop = YES;
//            }
        
            // åˆå§‹åŒ–æ•°æ®æºå­—å…¸
            if (_dicCountry) {
                [self.dicCountry removeAllObjects];
                self.dicCountry = nil;
            }
            self.dicCountry = [NSMutableDictionary dictionary];
            
            if (_arrIndexCharacter) {
                [self.arrIndexCharacter removeAllObjects];
                self.arrIndexCharacter = nil;
            }
            self.arrIndexCharacter = [NSMutableArray array];
            
            // éå†æºæ•°ç»„ è¿›è¡Œæ’åº
            [_arrCountry enumerateObjectsUsingBlock:^(CountryModel *country, NSUInteger idx, BOOL *stop) {
                // é¦–å­—æ¯
                NSString *firstLetter = [NSString firstLetter:_language == ENUM_LanguageTypeChinese ? country.zh_name : country.en_name];
                if ([self.dicCountry.allKeys containsObject:firstLetter]) {
                    NSMutableArray *arrayTemp = (NSMutableArray *)[self.dicCountry objectForKey:firstLetter];
                    if (arrayTemp) {
                        [arrayTemp addObject:country];
                    }
                }
                else {
                    NSMutableArray *arrayTemp = [NSMutableArray arrayWithObjects:country, nil];
                    [self.dicCountry setObject:arrayTemp forKey:firstLetter];
                    [self.arrIndexCharacter addObject:firstLetter];
                }
            }];
//        }];
    }
}

// ç´¢å¼•æ•°ç»„
- (NSArray *)sectionIndexTitlesForTableView:(UITableView *)tableView
{
    return _isSearch ? nil : _arrIndexCharacter;
}

// æ»‘åŠ¨è§¦å‘ç´¢å¼•äº‹ä»¶
- (NSInteger)tableView:(UITableView *)tableView sectionForSectionIndexTitle:(NSString *)title atIndex:(NSInteger)index
{
    NSInteger count = 0;
    if (!_isSearch) {
        for (NSString *character in _arrIndexCharacter) {
            if([character isEqualToString:title]) {
                return count;
            }
            count ++;
        }
    }
    return 0;
}

// åˆ†æ®µæ ‡é¢˜
- (NSString *)tableView:(UITableView *)tableView titleForHeaderInSection:(NSInteger)section
{
    NSString *title;
    if (_isSearch)
        title = nil;
    else
        title = [NSString stringWithFormat:@"%@", [_arrIndexCharacter objectAtIndex:section]];
    
    return title;
}

#pragma mark - æœç´¢

// è®¾ç½®å¯¼èˆªæ å³ä¾§æœç´¢æŒ‰é’®
- (void)setNavRighSearchItem {
    
    self.title = @"æ‰€åœ¨å›½å®¶";
    UIBarButtonItem *rItem = [[UIBarButtonItem alloc] initWithTitle:@"ğŸ”" style:UIBarButtonItemStylePlain target:self action:@selector(countrySearch:)];
    self.navigationItem.rightBarButtonItem = rItem;
}

- (void)countrySearch:(id)sender {
    _isSearch = YES;
    [self replaceTitleViewForSearch];
}

// è®¾ç½®é¡¶éƒ¨æœç´¢æ¡†
- (void)replaceTitleViewForSearch {
    // è®¾ç½® æœç´¢ title view
    CGRect stRect                   = CGRectMake(0, 0, Screen_Width, 64);
    ECRSearchTitleView *stv         = [[ECRSearchTitleView alloc] initWithFrame:stRect];
    stv.delegate                    = self;
    [UIView animateWithDuration:0.2 animations:^{
        self.navigationItem.titleView   = stv;
        self.navigationItem.rightBarButtonItem = nil;
        UIBarButtonItem *spaceBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
        spaceBarButtonItem.width = -4;
        self.navigationItem.leftBarButtonItems = @[spaceBarButtonItem];
        [self.navigationItem setHidesBackButton:YES];
    } completion:^(BOOL finished) {
        [stv lg_becomResponser];
    }];
}

#pragma mark - ECRSearchTitleViewDelegate

// å…³é—­
- (void)stViewClose:(ECRSearchTitleView *)view
{
    _isSearch = NO;
    [self endSearching];
    [_tableView reloadData];
}

- (void)bookSearch:(id)sender{
    [self replaceTitleViewForSearch];
}

// ç»“æŸæœç´¢çŠ¶æ€
- (void)endSearching{
    // MARK: moreCallBack.å…³é—­æœç´¢
    [self.view endEditing:YES];
    [UIView animateWithDuration:0.2 animations:^{
        self.navigationItem.titleView = nil;
    }];
    [self createNavLeftBackItem];
    [self setNavRighSearchItem];
}

#pragma mark - æœç´¢äº‹ä»¶

// æœç´¢
- (void)stView:(ECRSearchTitleView *)view content:(NSString *)content
{
    _isSearch = YES;
    [self searchContryWithText:content];
    [_tableView reloadData];
}

// æ ¹æ®è¾“å…¥çš„å†…å®¹ æœç´¢å›½å®¶
- (void)searchContryWithText:(NSString *)searchText
{
    // åˆå§‹åŒ–æœç´¢æ•°ç»„
    if (self.arrSearchs && self.arrSearchs.count > 0) {
        [self.arrSearchs removeAllObjects];
    }
    self.arrSearchs = [NSMutableArray array];
    
    //åŠ ä¸ªå¤šçº¿ç¨‹ï¼Œé˜²æ­¢æ•°é‡é‡å¤§çš„æ—¶å€™ï¼Œæœ‰æ˜æ˜¾çš„å¡é¡¿ç°è±¡
    dispatch_queue_t globalQueue = dispatch_get_global_queue(0, 0);
    dispatch_async(globalQueue, ^{
        // å¦‚æœè¾“å…¥çš„æ–‡æœ¬æœ‰å†…å®¹
        if (searchText != nil && searchText.length>0) {
            //éå†éœ€è¦æœç´¢çš„æ‰€æœ‰å†…å®¹
            for (CountryModel *country in self.arrCountry) {
                // æ ¹æ®é€‰æ‹©çš„è¯­è¨€æœç´¢å›½å®¶å
                NSMutableString *countryName = [NSMutableString stringWithFormat:@"%@", _language == ENUM_LanguageTypeChinese ? country.zh_name : country.en_name];
                // ä¸­æ–‡
                if (_language == ENUM_LanguageTypeChinese) {
                    NSString *pinyin = [self transformToPinyin:countryName];
                    
                    if ([pinyin rangeOfString:searchText options:NSCaseInsensitiveSearch].length >0 ) {
                        //æŠŠæœç´¢ç»“æœå­˜æ”¾ arrSearchs æ•°ç»„
                        [self.arrSearchs addObject:country];
                    }
                }
                else { // è‹±æ–‡
                    // å›½å®¶åæ˜¯å¦åŒ…æ‹¬ æœç´¢çš„æ–‡å­—
                    if ([countryName containsString:searchText] || [[countryName lowercaseString] containsString:[searchText lowercaseString]]) {
                        [self.arrSearchs addObject:country];
                    }
                }
            }
        }
        
        //å›åˆ°ä¸»çº¿ç¨‹
        dispatch_async(dispatch_get_main_queue(), ^{
            [_tableView reloadData];
        });
    });
}

// æŠŠæ‰€æœ‰çš„æœç´¢ç»“æœè½¬æˆæˆæ‹¼éŸ³
- (NSString *)transformToPinyin:(NSString *)aString
{
    //è½¬æˆäº†å¯å˜å­—ç¬¦ä¸²
    NSMutableString *str = [NSMutableString stringWithString:aString];
    CFStringTransform((CFMutableStringRef)str,NULL, kCFStringTransformMandarinLatin,NO);
    //å†è½¬æ¢ä¸ºä¸å¸¦å£°è°ƒçš„æ‹¼éŸ³
    CFStringTransform((CFMutableStringRef)str,NULL, kCFStringTransformStripDiacritics,NO);
    NSArray *pinyinArray = [str componentsSeparatedByString:@" "];
    NSMutableString *allString = [NSMutableString new];
    
    int count = 0;
    for (int  i = 0; i < pinyinArray.count; i++) {
        for(int i = 0; i < pinyinArray.count; i++) {
            if (i == count) {
                [allString appendString:@"#"];//åŒºåˆ†ç¬¬å‡ ä¸ªå­—æ¯
            }
            [allString appendFormat:@"%@",pinyinArray[i]];
        }
        [allString appendString:@","];
        count ++;
    }
    NSMutableString *initialStr = [NSMutableString new];//æ‹¼éŸ³é¦–å­—æ¯
    for (NSString *s in pinyinArray) {
        if (s.length > 0) {
            [initialStr appendString:[s substringToIndex:1]];
        }
    }
    
    [allString appendFormat:@"#%@",initialStr];
    [allString appendFormat:@",#%@",aString];
    
    return allString;
}

#pragma mark - å±æ€§

- (NSMutableArray *)arrIndexCharacter
{
    if (_arrIndexCharacter == nil) {
        _arrIndexCharacter = [NSMutableArray array];
    }
    return _arrIndexCharacter;
}

- (NSMutableArray *)arrIndexTitles
{
    if (_arrIndexTitles == nil) {
        _arrIndexTitles = [NSMutableArray arrayWithArray:[NSString indexLetters]];
    }
    return _arrIndexTitles;
}

@end
