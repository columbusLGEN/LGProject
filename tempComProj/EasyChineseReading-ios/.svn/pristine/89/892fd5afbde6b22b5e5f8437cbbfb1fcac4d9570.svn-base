//
//  ShareVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/10/31.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ShareVC.h"

@interface ShareVC ()

//  蒙版及分享 view

@property (weak, nonatomic) IBOutlet UIView *viewShareBook;         // 分享
@property (weak, nonatomic) IBOutlet UIView *viewShareBookLine;     // 分享底部的线
@property (weak, nonatomic) IBOutlet UIView *viewShareBookScore;    // 评星

@property (weak, nonatomic) IBOutlet UILabel *lblShareBookName;     // 书名
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookAuthor;   // 作者
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookPrice;    // 价格
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookCancel;   // 取消
@property (weak, nonatomic) IBOutlet UILabel *lblShareBookSend;     // 发送

@property (weak, nonatomic) IBOutlet UIImageView *imgShareBook;     // 封面
@property (weak, nonatomic) IBOutlet UITextView  *txtvShareBookContent; // 分享的说明

// 底部 view

@property (weak, nonatomic) IBOutlet UIView *viewBottom;            // 分享底部按键

@property (weak, nonatomic) IBOutlet UIView *viewBottomLine;        // 分享底部的线
@property (weak, nonatomic) IBOutlet UIView *viewBottomLeft;        // 左边的 view(当做按钮)
@property (weak, nonatomic) IBOutlet UIView *viewBottomRight;       // 右边的 view

@property (weak, nonatomic) IBOutlet UIImageView *imgBottomLeft;    // 左边的图片
@property (weak, nonatomic) IBOutlet UIImageView *imgBottomRight;   // 右边的图片

@property (weak, nonatomic) IBOutlet UILabel *lblBottomLeft;        // 左边文字描述
@property (weak, nonatomic) IBOutlet UILabel *lblBottomRight;       // 右边文字描述

@end

@implementation ShareVC

- (void)viewDidLoad {
    [super viewDidLoad];
    [self configShareBookView];
    //    [self configBottomView];
    [self configData];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - 配置界面

- (void)updateSystemLanguage
{
    _lblBottomLeft.text      = LOCALIZATION(@"分享给好友");
    _lblBottomRight.text     = LOCALIZATION(@"分享到好友动态");
    _lblShareBookCancel.text = LOCALIZATION(@"取消");
    _lblShareBookSend.text   = LOCALIZATION(@"发送");
}

- (void)configShareBookView
{
    self.view.backgroundColor           = [UIColor cm_blackColor_000000_3F];
    _viewShareBook.backgroundColor      = [UIColor whiteColor];
    _lblShareBookSend.backgroundColor   = [UIColor cm_mainColor];
    _lblShareBookCancel.backgroundColor = [UIColor whiteColor];

    _lblShareBookName.textColor   = [UIColor cm_blackColor_333333_1];
    _lblShareBookAuthor.textColor = [UIColor cm_blackColor_666666_1];
    _lblShareBookPrice.textColor  = [UIColor cm_orangeColor_FF5910_1];
    _lblShareBookCancel.textColor = [UIColor cm_mainColor];
    _lblShareBookSend.textColor   = [UIColor whiteColor];

    _lblShareBookName.font   = [UIFont systemFontOfSize:cFontSize_16];
    _lblShareBookAuthor.font = [UIFont systemFontOfSize:cFontSize_14];
    _lblShareBookPrice.font  = [UIFont systemFontOfSize:cFontSize_12];
    _lblShareBookCancel.font = [UIFont systemFontOfSize:cFontSize_16];
    _lblShareBookSend.font   = [UIFont systemFontOfSize:cFontSize_16];

    _txtvShareBookContent.textColor = [UIColor cm_blackColor_333333_1];
    _txtvShareBookContent.font      = [UIFont systemFontOfSize:cFontSize_16];

    _txtvShareBookContent.layer.borderColor = [UIColor cm_lineColor_D9D7D7_1].CGColor;
    _txtvShareBookContent.layer.borderWidth = 1.f;

    _lblShareBookSend.userInteractionEnabled   = YES;
    _lblShareBookCancel.userInteractionEnabled = YES;

    UITapGestureRecognizer *tapCancel   = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(cancelShareBook)];
    UITapGestureRecognizer *tapSend     = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(sendShareBook)];

    [_lblShareBookCancel addGestureRecognizer:tapCancel];
    [_lblShareBookSend   addGestureRecognizer:tapSend];
    _viewBottom.hidden = YES;
}

- (void)configBottomView
{
    _viewBottom.backgroundColor     = [UIColor whiteColor];
    _viewBottomLine.backgroundColor = [UIColor cm_lineColor_D9D7D7_1];
    
    _viewBottomLeft.backgroundColor  = [UIColor whiteColor];
    _viewBottomRight.backgroundColor = [UIColor whiteColor];
    
    _lblBottomLeft.textColor  = [UIColor cm_blackColor_333333_1];
    _lblBottomRight.textColor = [UIColor cm_blackColor_333333_1];
    
    _lblBottomLeft.font  = [UIFont systemFontOfSize:cFontSize_16];
    _lblBottomRight.font = [UIFont systemFontOfSize:cFontSize_16];
    
    _viewBottomLeft.userInteractionEnabled  = YES;
    _viewBottomRight.userInteractionEnabled = YES;
    
    UITapGestureRecognizer *tapLView = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(shareToFriend)];
    UITapGestureRecognizer *tapRView = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(shareToDynamic)];
    
    [_viewBottomLeft  addGestureRecognizer:tapLView];
    [_viewBottomRight addGestureRecognizer:tapRView];
    _viewShareBook.hidden = _shareType = ENUM_ShareTypeDynamic;
}

#pragma mark - 配置数据

- (void)configData
{
    [_imgShareBook sd_setImageWithURL:[NSURL URLWithString:_book.iconUrl] placeholderImage:[UIImage imageNamed:@"img_book_placeholder"]];
    _lblShareBookName.text   = [UserRequest sharedInstance].language == ENUM_LanguageTypeChinese ? _book.bookName : _book.en_bookName;
    _lblShareBookAuthor.text = [NSString stringWithFormat:@"%@: %@", LOCALIZATION(@"作者"), [UserRequest sharedInstance].language == ENUM_LanguageTypeChinese ? _book.author : _book.en_author];
    
    NSString *price = [NSString stringWithFormat:@"%@%.2f", LOCALIZATION(@"¥"), _book.price];
    NSMutableAttributedString *money = [[NSMutableAttributedString alloc] initWithString:price];
    NSRange upRang = NSMakeRange(1, price.length - 1);
    [money addAttribute:NSFontAttributeName value:[UIFont systemFontOfSize:_lblShareBookName.font.pointSize] range:upRang];
    _lblShareBookPrice.attributedText = money;

    ZStarView *star = [[ZStarView alloc] initWithFrame:CGRectMake(0, 0, _viewShareBookScore.height*5, _viewShareBookScore.height) numberOfStar:5];
    star.canChange = NO;
    [_viewShareBookScore addSubview:star];

    [star setScore:_book.score withAnimation:NO completion:^(BOOL finished) {
        // 设置
    }];
}

#pragma mark - 操作
// 取消分享
- (void)cancelShareBook
{
    [self hidden];
}
// 分享图书
- (void)sendShareBook
{
    [[FriendRequest sharedInstance] shareBookWithBookId:_book.bookId shareTitle:_txtvShareBookContent.text completion:^(id object, ErrorModel *error) {
        if (error) {
            [self presentFailureTips:error.message];
        }
        else {
            [self fk_postNotification:kNotificationShareBookToDynamicSuccess];
            [self hidden];
            [self presentSuccessTips:LOCALIZATION(@"分享成功")];
        }
    }];
}

/**
 分享给好友
 */
- (void)shareToFriend
{
    _shareType = ENUM_ShareTypeDynamic;
    _viewShareBook.hidden = NO;
    _viewBottom.hidden = YES;
}

/**
 分享到动态
 */
- (void)shareToDynamic
{
    [self dismissViewControllerAnimated:YES completion:^{
        self.shareToFriendWithBook(_book);
    }];
}

/**
 点击空白
 */
- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    UITouch *touch = [touches anyObject];
    UIView *view = touch.view;

    if (view == self.view) {
        [self hidden];
    }
}

- (void)hidden
{
    [self dismissViewControllerAnimated:YES completion:nil];
}

@end
