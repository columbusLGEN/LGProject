//
//  UserInfo.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/6.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserInfo.h"

@implementation UserInfo

CM_SINGLETON_IMPLEMENTION(UserInfo)

- (id)init
{
    if ( self = [super init] )
    {
        [self loadCache];
    }
    return self;
}

- (void)saveCache
{
    [[CacheDataSource sharedInstance] setCache:self.user withCacheKey:@"user"];
    [[CacheDataSource sharedInstance] setCache:self.token withCacheKey:@"userToken"];
    [[CacheDataSource sharedInstance] setCache:self.deviceToken withCacheKey:@"deviceToken"];

    if (self.user)
    {
        self.userCellPhone = self.user.cellPhone;
        self.userNickName = self.user.name;
    }
    [[CacheDataSource sharedInstance] setCache:self.userCellPhone withCacheKey:@"userCellPhone"];
    [[CacheDataSource sharedInstance] setCache:self.userNickName withCacheKey:@"userName"];
}

- (void)loadCache
{
    self.user = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"user"];
    self.token = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userToken"];
    self.deviceToken = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"deviceToken"];
    self.userCellPhone = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userCellPhone"];
    self.userNickName = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userName"];
}

- (void)clearCache
{
    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"user"];
    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"userToken"];
    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"loginUserDyList"];
    self.token = @"";
    self.user = nil;
}

#pragma mark -

+ (BOOL)online
{
    return [[UserInfo sharedInstance] online];
}

- (BOOL)online
{
    if ( ![NSString isEmpty:self.token] && self.user)
    {
        return YES;
    }
    return NO;
}

- (void)signout
{
    if ( self.online )
    {
        
        [self clearCache];
        [self fk_postNotification:kNotificationThemeChanged];
    }
}

- (void)kickout
{
    if ( self.online )
    {
        static UIAlertView *alertView;
        if (alertView == nil) {
            NSDate * date = [NSDate dateWithTimeIntervalSinceNow:-120];
            NSDateFormatter * dateFormatter = [[NSDateFormatter alloc] init];
            [dateFormatter setDateFormat:@"HH:ss"];
            NSString * resultStr = [dateFormatter stringFromDate:date];
            NSString * str = [NSString stringWithFormat:@"当前帐号于%@在iPhone设备上登录。若非本人的操作，你的密码可能已经泄漏，请及时更改你的密码。",resultStr];
            alertView = [[UIAlertView alloc] initWithTitle:str message:nil delegate:self cancelButtonTitle:@"确定" otherButtonTitles:nil,nil];
//            WeakSelf(weakSelf)
//            alertView.whenDidSelectCancelButton = ^{
//                [weakSelf signout];
//                alertView = nil;
//            };
            [alertView show];
        }
    }
}

#pragma mark—— 数据 接口
///**
// * 登录
// */
//- (void)signinWithMobile:(NSString *)mobile
//                password:(NSString *)password
//              completion:(CompleteErrorBlock)completion
//{
//    
//    [UserNetwork signinWithMobile:mobile password:password completion:^(id object, UCError *error) {
//        if ( error )
//        {
//            completion(error);
//        }
//        else
//        {
//            UCUser *model = [UCUser objectWithKeyValues:object];
//            if (object[@"live_city"])
//            {
//                model.live_city = [object[@"live_city"] JSONObject];
//            }
//            if (object[@"professional"])
//            {
//                model.professional = [object[@"professional"] JSONObject];
//            }
//            [UCUserModel sharedInstance].user = model;
//            [UCUserModel sharedInstance].token = model.token;
//            [UCUserModel sharedInstance].user.deviceToken = [UCUserModel sharedInstance].deviceToken;
//            [[UCUserModel sharedInstance] saveCache];
//            
//            //连接websokect
//            [[WebSocketService sharedInstance] connect];
//            
//            [[ChatDataSource source] loadUser:[UCUserModel sharedInstance].user];
//            // 登录成功 通知
//            [self fk_postNotification:UCHAT_USER_LOGIN_NOTIFICATION];
//            completion(nil);
//        }
//    }];
//}
//
///**
// * 获取验证码
// */
//- (void)getVerifyCodeWithMobile:(NSString *)mobile
//                           type:(UCVerifyCodeType)type
//                     completion:(CompleteErrorBlock)completion
//{
//    [UserNetwork getVerifyCodeWithMobile:mobile type:type completion:^(id object, UCError *error) {
//        completion(error);
//    }];
//}
//
///**
// * 验证码 验证
// */
//- (void)verifyWithMobile:(NSString *)mobile
//                    code:(NSString *)code
//                    type:(UCVerifyCodeType)type
//              completion:(CompleteBlock)completion
//{
//    [UserNetwork verifyWithMobile:mobile code:code type:type completion:^(NSString *token, UCError *e) {
//        completion(token,e);
//    }];
//}
//
///**
// * 注册
// */
//- (void)signupWithMobile:(NSString *)mobile
//                password:(NSString *)password
//                    salt:(NSString *)salt
//                nickname:(NSString *)nickname
//              completion:(CompleteErrorBlock)completion
//{
//    [UCUserModel sharedInstance].salt = salt;
//    [UserNetwork signupWithMobile:mobile password:password salt:salt nickname:nickname completion:^(id object, UCError *error) {
//        
//        completion(error);
//    }];
//}
//
///**
// * 重置密码
// */
//- (void)resetPasswordWithMobile:(NSString *)mobile
//                       password:(NSString *)password
//                           salt:(NSString *)salt
//                           code:(NSString *)code
//                     completion:(CompleteErrorBlock)completion
//{
//    [UserNetwork resetPasswordWithMobile:mobile password:password salt:salt code:code completion:^(id object, UCError *error) {
//        completion(error);
//    }];
//}
//
///**
// * 验证此手机号 是否已注册
// */
//-(void)verifyPhoneIsRegisterWithPhone:(NSString *)mobile completion:(CompleteBlock)completion
//{
//    [UserNetwork verifyPhoneIsRegisterWithPhone:mobile completion:^(id object, UCError *error) {
//        if (object) {
//            NSDictionary  *dic = object;
//            if ([dic.allKeys containsObject:@"status"]) {
//                BOOL isHavedReg = [dic[@"status"] boolValue];
//                completion(@(isHavedReg),nil);
//            }else{
//                completion(nil,error);
//            }
//        }else{
//            completion(nil,error);
//        }
//    }];
//}
//
//
///**
// * 获取用户信息
// */
//- (void)getUserInfoWithID:(NSInteger)user_id completion:(CompleteErrorBlock)completion
//{
//    [UserNetwork getUserInfoWithID:user_id completion:^(id object, UCError *error) {
//        if ( error ) {
//            completion(error);
//        }
//        else {
//            self.user = [UCUser objectWithKeyValues:[object valueForKey:@"user"]];
//            if ( [UCUserModel sharedInstance].user.id == user_id ) {
//                [UCUserModel sharedInstance].user = self.user;
//                [[UCUserModel sharedInstance] saveCache];
//            }
//            completion(nil);
//        }
//    }];
//}
//
///**
// *  验证密码是否正确
// *
// *  @param password   密码
// *  @param completion 回调
// */
//- (void)verifyPasswordWithPassword:(NSString *)password
//                        completion:(CompleteErrorBlock)completion
//{
//    
//}



/**
 *  修改密码
 *
 *  @param type         修改密码类型
 *  @param password     旧密码
 *  @param passwordNew  新密码
 *  @param completion   回调
 */
- (void)updatePasswordWityType:(NSString *)type
                      password:(NSString *)password
                   passwordNew:(NSString *)passwordNew
                    completion:(CompleteBlock)completion
{
    NSDictionary *dic = @{@"params":
                              @{@"type"       : type,
                                @"password"   : password,
                                @"passwordNew": passwordNew},
                          @"md5": @"654c01acaf40e0ce6d841a552fd3b96c"};
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost strUrl:@"modifyPassword" parameters:dic completeBlock:^(id responseObject, ErrorModel *error) {
        if (error) {
            completion(nil, error);
        }
        else {
            completion(responseObject, error);
        }
    }];
}

@end
