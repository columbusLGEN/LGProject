//
//  ECRBookInfoViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/11.
//  Copyright © 2017年 lee. All rights reserved.
//

static NSString *pjCell = @"ECRDetailPJTableViewCell";
static NSString *pjCellPad = @"ECRDetailPJTableViewPadCell";

#import "ECRBookInfoViewController.h"
#import "ECRSwichView.h"
#import "ECRBookInfoModel.h"
#import "ECRBookInfoTableViewCell.h"
#import "ECRBiCommentModel.h"
#import "ECRDetailPJTableViewCell.h"
#import "ZStarView.h"
#import "ECRRentSeriousViewController.h"
#import "ECRShoppingCarViewController.h"
#import "ECRShoppingCarManager.h"
#import "ECRShoppingCarModel.h"
#import "ECRDataHandler.h"
#import "ECRScoreUserModel.h"
#import "ECRRowObject.h"
#import "ECRRequestFailuredView.h"
#import "ECRDetailPJTableViewPadCell.h"
#import "ECRRecoBook.h"
#import "ECRDownloadManager.h"
#import "ShareVC.h"
#import "ECRBookrackDataHandler.h"
#import "ECRBookReaderManager.h"
#import "ECRLocalFileManager.h"
#import "ECRBiCustomButton.h"
#import "UVirtualCurrencyRechargeVC.h"

@interface ECRBookInfoViewController ()<
UITableViewDelegate,
UITableViewDataSource,
ECRSwichViewDelegate,
ECRRequestFailuredViewDelegate,
ECRBookInfoTableViewCellDelegate
>{
    CGFloat ssvH;// switchscrollview 的 height
}
@property (strong,nonatomic) ECRBookInfoModel *model;
@property (strong, nonatomic) IBOutlet UIScrollView *baseScrollView;
@property (strong, nonatomic) IBOutlet UIView *topInfoView;
@property (strong, nonatomic) IBOutlet UIScrollView *swithcScrollView;
@property (strong, nonatomic) IBOutlet UIView *buttonView;/// MARK: 默认状态 buttonview
@property (strong, nonatomic) IBOutlet ECRSwichView *diSwitchView;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *ssvHeight;// switchscrollview 高度约束
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *bitbHeight;// infotableview 高度约束
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *pjtbHeight;// pjtableview 高度约束
@property (weak, nonatomic) IBOutlet UIImageView *biCover;
@property (weak, nonatomic) IBOutlet UILabel *biName;
@property (weak, nonatomic) IBOutlet UILabel *biAuthor;
@property (weak, nonatomic) IBOutlet ZStarView *biStar;
@property (weak, nonatomic) IBOutlet UILabel *biPrice;
@property (weak, nonatomic) IBOutlet UILabel *biPriceSymbles;
@property (weak, nonatomic) IBOutlet UIView *biRectView;
@property (weak, nonatomic) IBOutlet UIView *biLine;
@property (weak, nonatomic) IBOutlet UIView *biLine2;
@property (weak, nonatomic) IBOutlet UIButton *buyButton;// 购买纸质书
@property (weak, nonatomic) IBOutlet UITableView *infoTableView;
@property (weak, nonatomic) IBOutlet UITableView *pjTableView;

@property (assign,nonatomic) CGFloat rHeight1;
@property (assign,nonatomic) CGFloat rHeight2;
@property (assign,nonatomic) CGFloat rHeight3;
@property (assign,nonatomic) CGFloat rHeight4;
@property (assign,nonatomic) CGFloat pjHeight;
@property (strong,nonatomic) NSArray *comments;// 品论数据源
@property (strong,nonatomic) ECRRequestFailuredView *rrfv;// 请求失败 view
@property (strong,nonatomic) UIButton *like;//
@property (strong,nonatomic) MBProgressHUD *dlProgressHUD;/// download
@property (weak, nonatomic) IBOutlet ECRBiCustomButton *addCart;/// 加入购物车
@property (weak, nonatomic) IBOutlet ECRBiCustomButton *tryRead;/// 试读
@property (weak, nonatomic) IBOutlet ECRBiCustomButton *seriesBao;/// 系列包月
@property (weak, nonatomic) IBOutlet UIButton *buyNow;/// 购买

@end

@implementation ECRBookInfoViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    
}
- (void)setBookId:(NSInteger)bookId{
    _bookId = bookId;
    [self loadNewDataWithBookId:bookId];
}
- (void)loadNewDataWithBookId:(NSInteger)bookId{
    [[ECRDataHandler sharedDataHandler] biDataWithBookId:bookId success:^(id object) {
        ECRBookInfoModel *model = (ECRBookInfoModel *)object;
        self.like.selected = model.collectionType;
        self.model = model;
        self.comments = model.scores;
        
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            if (_rrfv != nil) {
                [_rrfv removeFromSuperview];
                _rrfv = nil;
            }
            // 基本信息
            [self.biCover sd_setImageWithURL:[NSURL URLWithString:model.iconUrl] placeholderImage:LGPlaceHolderImg];
            if ([LGPChangeLanguage currentLanguageIsEnglish]) {
                self.biName.text = model.en_bookName;
                self.biAuthor.text = model.en_author;
            }else{
                self.biName.text = model.bookName;
                self.biAuthor.text = model.author;
            }
            
//            NSLog(@"xiangqingpingfeninteger -- %ld",(NSInteger)model.score);
            [self.biStar setScore:(NSInteger)model.score withAnimation:NO];
//            NSLog(@"xiangqingpingfen -- %f",model.score);
            self.biPrice.text = [NSString stringWithFormat:@"%.2f",model.price];
            [self.infoTableView reloadData];
            [self.pjTableView reloadData];
            
        }];
        
    } failure:^(NSString *msg) {
//        NSLog(@"msg -- %@",msg);
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    } commenFailure:^(NSError *error) {
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    }];
}
// MARK: 点击立即购买
- (IBAction)buyEbookClick:(UIButton *)sender {
    UVirtualCurrencyRechargeVC *vrrvc = [UVirtualCurrencyRechargeVC loadFromStoryBoard:@"User"];
    if ([ECRMultiObject userYue] >= self.model.price) {
        /// 余额充足,直接支付
        vrrvc.payPurpose = ENUM_PayPurposeBuy;
    }else{
        /// 余额不足,先充值,再支付
        vrrvc.payPurpose = ENUM_PayPurposeRecharge;
    }
    OrderModel *order = [OrderModel new];
    order.orderId = @"0";
    order.books = @[self.model];/// 所有要买的书籍
    order.totalmoney = self.model.price;/// 商品总价(未减之前)
    [self.navigationController pushViewController:vrrvc animated:YES];
}
// MARK: 试读
- (IBAction)experClick:(UIButton *)sender {
//    if (0){
    if (self.model.academicProbationUrl == nil || [self.model.academicProbationUrl isEqualToString:@""]) {
        // 提示用户没有试读资源
        [self presentSuccessTips:LOCALIZATION(@"没有试读资源")];
    }else{
//        self.model.eBookFormat = 3;
//         NSString *URLString = @"http://123.59.197.176/group1/M00/00/01/CgoKBFoKft2Ad_aGAE31tVJfh_w438.pdf";// pdf 测试链接
//        NSString *URLString = @"http://192.168.10.68:8080/BLCUPManageSystem/book/epub/9787561944882.epub";// epub 测试链接
//        NSString *URLString = @"http://123.59.197.176/group1/M00/00/01/CgoKBFoEGTmAN5SaAv7FFFfh4_U313.dbz";// dbz 测试链接 超媒体压缩包
        
        // 1 获取下载链接
        NSString *URLString = self.model.academicProbationUrl;
//        // 2 创建本地存储链接 -- 将拼接链接的操作封装到 ECRDownloadManager 内部
        NSString *localFilePath = self.model.localURL;
        
        // 3 判断本地存储链接是否存在,若存在直接打开,否则进行下载
        BOOL filePathIsExist = [ECRDownloadManager fileIsExist:localFilePath];
        if (filePathIsExist) {
            // 3.1 直接打开本地路径
            [ECRBookReaderManager readBookWithType:self.model.eBookFormat localURL:localFilePath vc:self bookModel:self.model ymeBook:self.model.ymeBook readFailure:^(id info) {
                NSLog(@"readfailure -- %@",info);
            }];
        }else{
            // 3.2.1 添加下载进度条
            self.dlProgressHUD = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
            [self.view addSubview:self.dlProgressHUD];
            self.dlProgressHUD.mode = MBProgressHUDModeAnnularDeterminate;
            self.dlProgressHUD.progress = 0.0;
            
            // 3.2.2 开始下载
            [ECRDownloadManager downloadWithURLString:URLString fileName:localFilePath progress:^(CGFloat progress, CGFloat total, CGFloat current) {
                //        NSLog(@"下载中 grogress -- %f",progress / 100);
                [[NSOperationQueue mainQueue] addOperationWithBlock:^{
                    // 3.2.2.1 更新下载进度
                    self.dlProgressHUD.progress = progress / 100;
                }];
            } success:^(NSString *localURL) {
                NSLog(@"localURL -- %@",localURL);
                // 3.2.2.2.1 隐藏下载进度条
                [self.dlProgressHUD hideAnimated:YES];
                
                // 3.2.2.2.2 打开本地路径
                [ECRBookReaderManager readBookWithType:self.model.eBookFormat localURL:localURL vc:self bookModel:self.model ymeBook:self.model.ymeBook readFailure:^(id info) {
                    NSLog(@"readfailure -- %@",info);
                }];
                
                // MARK: 调用接口, 将该书加入书架,
                [ECRBookrackDataHandler bookShelfAddBookToBookrackWithBookId:self.model.bookId success:^(id objc) {
                    NSLog(@"加入书架成功 -- %@",objc);
                } failure:^(NSError *error, NSString *msg) {
                    NSLog(@"加入书架失败 error: %@ --msg %@",error,msg);
                }];
                
            } failure:^(NSError *error) {
                // 3.2.2.3 下载失败回调
                [ECRLocalFileManager deleteLocalFileWithPath:localFilePath];
                [self.dlProgressHUD hideAnimated:YES];
                [self presentSuccessTips:LOCALIZATION(@"下载失败,请稍后重试")];
                NSLog(@"下载失败 -- %@",error);
            }];
        }
    }
    
}

// MARK: 系列包月
- (IBAction)setBaoClick:(UIButton *)sender {
    ECRRentSeriousViewController *rsvc = [[ECRRentSeriousViewController alloc] init];
    rsvc.model = self.model;
    rsvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:rsvc animated:YES];
    
}
- (IBAction)bookBuy:(UIButton *)sender {
    // MARK: 购买纸质书
    
}
#pragma mark - ECRRequestFailuredViewDelegate 错误请求代理
- (void)rfViewReloadData:(ECRRequestFailuredView *)view{
    [self loadNewDataWithBookId:self.bookId];
}

#pragma mark - ECRBookInfoTableViewCellDelegate
// MARK: 跳转至推荐书籍
- (void)bitbrecoBookClick:(ECRBookInfoTableViewCell *)cell model:(ECRRecoBook *)model{
    UIStoryboard *board = [UIStoryboard storyboardWithName:@"BookInfo" bundle:nil];
    ECRBookInfoViewController *bivc = [board instantiateViewControllerWithIdentifier:@"ECRBookInfoViewController"];
    bivc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    bivc.bookId = model.bookId;
    [self.navigationController pushViewController:bivc animated:YES];
}
- (void)bitbnrcaFold:(ECRBookInfoTableViewCell *)cell{
    [self.infoTableView reloadData];
}

#pragma mark - delegate
- (void)ecrSwichView:(ECRSwichView *)view didClick:(NSInteger)click{
    switch (click) {
        case 0:
            [self.swithcScrollView setContentOffset:CGPointZero animated:YES];
            break;
        case 1:
            [self.swithcScrollView setContentOffset:CGPointMake(Screen_Width, 0) animated:YES];
//            [self scrollToOringinalPlace];
            break;
    }
}
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if ([scrollView isEqual:self.swithcScrollView]) {
        if (scrollView.contentOffset.x == 0) {
            // MARK: ssv height
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
//            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            [self.diSwitchView switchSelectedItem:0];
        }
        if (scrollView.contentOffset.x >= Screen_Width) {
            self.ssvHeight.constant = self.pjHeight;
            [self.diSwitchView switchSelectedItem:1];
        }
    }
}
//- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView{
//    if ([scrollView isEqual:self.swithcScrollView]) {
//        if (scrollView.contentOffset.x >= Screen_Width) {
//            [self scrollToOringinalPlace];
//        }
//    }
//}
//- (void)scrollToOringinalPlace{
//    if (self.comments.count == 0) {
//        [self.swithcScrollView setContentOffset:CGPointZero animated:NO];
//        [self.diSwitchView switchSelectedItem:0];
//        [self presentFailureTips:@"暂无评价"];
//    }
//}
#pragma mark - data source
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if ([tableView isEqual:self.infoTableView]) {
        return 4;
    }
    return _comments.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
//        NSLog(@"%@",indexPath);
        cell.model = self.model;
        cell.delegate = self;
        return cell;
    }
    ECRDetailPJTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCell];
    ECRScoreUserModel *model = _comments[indexPath.row];
    cell.model = model;
    return cell;
//    if (![ECRMultiObject userInterfaceIdiomIsPad]) {
//    }else{
//        ECRDetailPJTableViewPadCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCellPad];
//        ECRRowObject *rowModel = _comments[indexPath.row];
//        cell.rowModel = rowModel;
//        return cell;
//
//    }
    
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        // MARK: ssv height
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
        cell.model = self.model;
        
        if (indexPath.row == 0) {
            _rHeight1 = cell.rHeight1;
        }
        if (indexPath.row == 1) {
            _rHeight2 = cell.rHeight2;
        }
        if (indexPath.row == 2) {
            _rHeight3 = cell.rHeight3;
        }
        if (indexPath.row == 3) {// 如何获取总高度?
            _rHeight4 = cell.rHeight4;
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
        }
        return cell.rHeight;
    }
    CGFloat pjRowHeight;
    ECRDetailPJTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCell];
    pjRowHeight = cell.cellHeight;
    if (indexPath.row == (_comments.count - 1)) {
        _pjHeight = pjRowHeight * (_comments.count);
        self.pjtbHeight.constant = _pjHeight;
        NSLog(@"pjtbHeight -- %f",self.pjtbHeight.constant);
    }
//    NSLog(@"swithcScrollView.contentSize -- heightForrow %@",NSStringFromCGSize(self.swithcScrollView.contentSize));
    return pjRowHeight;
}

- (void)textDependsLauguage{
    NSString *bookInfo = [LGPChangeLanguage localizedStringForKey:@"图书详情"];
    NSString *bookReview = [LGPChangeLanguage localizedStringForKey:@"评价"];
    self.title = bookInfo;
    _diSwitchView.buttonNames = @[bookInfo,bookReview];
    [self setBtnLocaText:self.buyButton titleKey:@"购买纸书"];
    [self setBtnLocaText:self.buyNow titleKey:@"立即购买"];

}
- (void)setBtnLocaText:(UIButton *)button titleKey:(NSString *)titleKey{
    [button setTitle:[LGPChangeLanguage localizedStringForKey:titleKey] forState:UIControlStateNormal];
}

#pragma mark - UI
- (void)setupUI{
    [self textDependsLauguage];
    [self setNavRightCustemView];
    [self.swithcScrollView setContentSize:CGSizeMake(Screen_Width, 0)];
    self.swithcScrollView.pagingEnabled = YES;
    self.infoTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.swithcScrollView.directionalLockEnabled = NO;
    _diSwitchView.delegate = self;
    
    self.pjTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.pjTableView registerNib:[UINib nibWithNibName:pjCell bundle:nil] forCellReuseIdentifier:pjCell];
    
    // MARK: 新按钮
    NSString *textPurple = @"82056B";
    NSString *bgWhite = @"ffffff";
    [self setNewBottomButtonWith:_addCart imgName:@"icon_shop_car" text:@"加入购物车" textColor:textPurple action:@selector(addToscClick:) bgColorStr:bgWhite];
    [self setNewBottomButtonWith:_tryRead imgName:@"icon_book_read" text:@"试读" textColor:textPurple action:@selector(experClick:) bgColorStr:bgWhite];
    [self setNewBottomButtonWith:_seriesBao imgName:@"icon_book_lease" text:@"系列" textColor:textPurple action:@selector(setBaoClick:) bgColorStr:bgWhite];
    
    [_buyNow setImageEdgeInsets:UIEdgeInsetsMake(0, 0, 0, 10)];
}

- (void)setNewBottomButtonWith:(ECRBiCustomButton *)bicus imgName:(NSString *)imgName text:(NSString *)text textColor:(NSString *)textColor action:(SEL)action bgColorStr:(NSString *)bgColorStr{
    [bicus setupWithImgName:imgName labelText:text labelTextColor:textColor];
    [bicus addTarget:self action:action forControlEvents:UIControlEventTouchUpInside];
    bicus.layer.borderColor = [UIColor cm_whiteColor_E7E7E7_1].CGColor;
    bicus.layer.borderWidth = 1;
    bicus.bgColorStr = bgColorStr;
}
// MARK: 加入购物车
- (IBAction)addToscClick:(UIButton *)sender {
    //    self.model.bookId;
    //    self.model.price;
    NSDictionary *dict = [NSDictionary dictionaryWithObjectsAndKeys:
                          [NSString stringWithFormat:@"%ld",self.model.bookId],@"bookId",
                          [NSString stringWithFormat:@"%f",self.model.price],@"price",
                          @"1",@"type",
                          nil];
    [[ECRShoppingCarManager sharedInstance] manageShopCarWithDict:dict success:^(NSMutableArray *totalArray, NSMutableArray *tickedArray, CGFloat priceT) {
        // 加入购物车成功
        // 已经加入购物车
        [self presentSuccessTips:LOCALIZATION(@"加入成功")];
    } failure:^(NSString *msg) {
        [self presentSuccessTips:LOCALIZATION(msg)];
    } commenFailure:^(NSError *error) {
        [self presentSuccessTips:LOCALIZATION(@"失败")];
    }];
}

#pragma mark - target
- (void)navLike:(UIButton *)sender{// 收藏/取消收藏
    NSInteger typeCollect;
    NSString *showString;
    if (sender.selected) {
        // 取消收藏成功
        showString = LOCALIZATION(@"取消");
        typeCollect = 0;
    }else{
        // 收藏成功
        showString = LOCALIZATION(@"收藏成功");
        typeCollect = 1;
    }
    /// type 1.添加收藏,2.移除收藏
    [[ECRDataHandler sharedDataHandler] bookCollectWithBookId:self.model.bookId type:typeCollect success:^(id object) {
//        NSLog(@"collection接口成功回调 -- %@",object);
        if (typeCollect == 1) {
            sender.selected = YES;
        }else{
            sender.selected = NO;
        }
        [self presentSuccessTips:showString];
    } failure:^(NSString *msg) {
        [self presentFailureTips:msg];
    } commenFailure:^(NSError *error) {
        [self presentFailureTips:@"网络连接错误"];
    }];
    
}
- (void)navShare:(UIButton *)sender{
    // MARK: 分享(站内信)
    ShareVC *share = [ShareVC loadFromNib];
    share.book = self.model;
    share.modalTransitionStyle = UIModalTransitionStyleCrossDissolve;
    share.modalPresentationStyle = UIModalPresentationOverCurrentContext;
    [self presentViewController:share animated:YES completion:nil];
    
}
- (void)navCar:(UIButton *)sender{
    // 关闭正在飞的下载请求
    [ECRDownloadManager cancelDownloadTask];
    // MARK: 跳转购物车
    ECRShoppingCarViewController *spvc = [[ECRShoppingCarViewController alloc] init];
    spvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:spvc animated:YES];
}

- (void)setNavRightCustemView{
    // 导航栏按钮s
    CGFloat bItemW = 28;
    CGFloat bItemY = -3;
    UIButton *like = [UIButton buttonWithType:UIButtonTypeCustom];
    [like setImage:[UIImage imageNamed:@"icon_unFavourite_white"] forState:UIControlStateNormal];
    [like setImage:[UIImage imageNamed:@"icon_favourite_white" ] forState:UIControlStateSelected];
    [like setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    self.like = like;
    UIBarButtonItem *navLike = [[UIBarButtonItem alloc] initWithCustomView:like];
    [like addTarget:self action:@selector(navLike:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *share = [UIButton buttonWithType:UIButtonTypeCustom];
    [share setImage:[UIImage imageNamed:@"icon_share_white"] forState:UIControlStateNormal];
    [share setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navShare = [[UIBarButtonItem alloc] initWithCustomView:share];
    [share addTarget:self action:@selector(navShare:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *car = [UIButton buttonWithType:UIButtonTypeCustom];
    [car setImage:[UIImage imageNamed:@"icon_shop_car_white"] forState:UIControlStateNormal];
    [car setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navCar = [[UIBarButtonItem alloc] initWithCustomView:car];
    [car addTarget:self action:@selector(navCar:) forControlEvents:UIControlEventTouchUpInside];
    
    self.navigationItem.rightBarButtonItems = @[navCar,navShare,navLike];
    
}


#pragma mark - lazy load
- (ECRRequestFailuredView *)rrfv{
    if (_rrfv == nil) {
        _rrfv = [[ECRRequestFailuredView alloc] initWithFrame:self.view.bounds];
        _rrfv.delegate = self;
    }
    return _rrfv;
}
- (CGFloat)pjHeight{
    if (_pjHeight == 0) {
        if ([ECRMultiObject userInterfaceIdiomIsPad]) {
            _pjHeight = 600; // TODO: 修改
        }else{
            _pjHeight = 200;
        }
    }
    return _pjHeight;
}

- (void)dealloc{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}
- (void)baseViewControllerDismiss{
    [super baseViewControllerDismiss];
    // 关闭正在飞的下载请求
    [ECRDownloadManager cancelDownloadTask];
}



@end
