//
//  RegisterDetailVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/9/8.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "RegisterDetailVC.h"

#import "LTextFieldTableViewCell.h"
#import "LVerifyTableViewCell.h"
#import "RButtonTableViewCell.h"

#import "UserInfoAddressVC.h"
#import "RegisterSuccessVC.h"

@interface RegisterDetailVC ()<UITableViewDelegate, UITableViewDataSource, LTextFieldTableViewCellDelegate, RButtonTableViewCellDelegate>

@property (strong, nonatomic) UITableView *tableView;
@property (strong, nonatomic) NSArray *arrViewConfiguration;   // 界面配置

/* 键盘高度 */
@property (assign, nonatomic) CGFloat keyBoardHeight;
/* table 偏移量 */
@property (assign, nonatomic) CGFloat tableOffset;
/* 选中的cell */
@property (strong, nonatomic) NSIndexPath *selectedIndexPath;

@end

@implementation RegisterDetailVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self configRegisterView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark -
#pragma mark 配置登录界面

- (void)configRegisterView
{
    [self configTableView];
    [self addNotification];
}

- (void)addNotification
{
    // 监听 textField 开始编辑
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(textWillChanged:)
                                                 name:UITextFieldTextDidBeginEditingNotification
                                               object:nil];
    // 监听 textField 结束编辑
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(textChanged:)
                                                 name:UITextFieldTextDidEndEditingNotification
                                               object:nil];
    // 监听 键盘出现或改变
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(keyboardWillShow:)
                                                 name:UIKeyboardWillShowNotification
                                               object:nil];
    // 监听 键盘退出
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(keyboardWillHide:)
                                                 name:UIKeyboardWillHideNotification
                                               object:nil];
}

- (void)configTableView
{
    _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, self.view.height) style:UITableViewStylePlain];
    _tableView.delegate = self;
    _tableView.dataSource = self;
    _tableView.rowHeight = UITableViewAutomaticDimension;
    _tableView.estimatedRowHeight = 100;
    _tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    
    [self.view addSubview:_tableView];
    
    [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([LTextFieldTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([LTextFieldTableViewCell class])];
    [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([LVerifyTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([LVerifyTableViewCell class])];
    [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([RButtonTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([RButtonTableViewCell class])];
}

#pragma mark -
#pragma mark UITableViewDataSource

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return self.arrViewConfiguration.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:_arrViewConfiguration[indexPath.row][@"identify"]];
    cell.data = _arrViewConfiguration[indexPath.row];
    if ([cell isKindOfClass:[LTextFieldTableViewCell class]]) {
        LTextFieldTableViewCell *txtfCell = (LTextFieldTableViewCell *)cell;
        txtfCell.delegate = self;
    }
    else if ([cell isKindOfClass:[RButtonTableViewCell class]]) {
        RButtonTableViewCell *btnCell = (RButtonTableViewCell *)cell;
        btnCell.delegate = self;
    }
    return cell;
}

#pragma mark -
#pragma mark UITableViewDelegate

// 空白高度
- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    UIView *header = [UIView new];
    return header;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    return 20;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (_arrViewConfiguration[indexPath.row][@"showSelected"]) {
        [self selectedCountry];
    }
}

#pragma mark -
#pragma mark UIScrollViewDelegate

- (void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    UITableViewCell *cell = [_tableView cellForRowAtIndexPath:_selectedIndexPath];
    [cell resignAllFirstResponder];
}

#pragma mark -
#pragma mark LTextFieldTableViewCellDelegate

- (void)selectedCountry
{
    UserInfoAddressVC *addressVC = [[UserInfoAddressVC alloc] init];
    [self.navigationController pushViewController:addressVC animated:YES];
}

#pragma mark -
#pragma mark action

// 键盘出现或改变
- (void)keyboardWillShow:(NSNotification *)notification
{
    //获取键盘的高度
    NSDictionary *userInfo = [notification userInfo];
    NSValue *aValue = [userInfo objectForKey:UIKeyboardFrameEndUserInfoKey];
    CGRect keyboardRect = [aValue CGRectValue];
    _keyBoardHeight = keyboardRect.size.height;
    
    UITableViewCell *cell = [_tableView cellForRowAtIndexPath:_selectedIndexPath];
    if (cell.y + cell.height > self.view.height - _keyBoardHeight) {
        _tableOffset = (cell.y + cell.height) - self.view.height + _keyBoardHeight;
        NSLog(@"offset %f", _tableOffset);
//        [_tableView setOffset:CGPointMake(-_tableView.width, -_tableOffset)];
        _tableView.frame = CGRectMake(0, -_tableOffset, Screen_Width, self.view.height);
    }
}

// 键盘退出
- (void)keyboardWillHide:(NSNotification *)notification
{
    _tableView.frame = CGRectMake(0, 0, Screen_Width, self.view.height);
}

// textField 开始编辑
- (void)textWillChanged:(NSNotification *)notification
{
    UITextField *textField = notification.object;
    
    if (textField) {
        CGPoint point = [textField.superview convertPoint:textField.frame.origin toView:_tableView];
        _selectedIndexPath = [_tableView indexPathForRowAtPoint:point];
    }
}

// textField 结束编辑
- (void)textChanged:(NSNotification *)notification
{
//    UITextField *textField = notification.object;
//    if (textField) {
//        CGPoint point = [textField.superview convertPoint:textField.frame.origin toView:_tableView];
//        NSIndexPath *indexPath = [_tableView indexPathForRowAtPoint:point];
//        NSLog(@" row %ld", (long)indexPath.row);
//    }
}

#pragma mark -
#pragma mark RButtonTableViewCellDelegate

- (void)registerNow
{
    RegisterSuccessVC *rSuccessVC = [RegisterSuccessVC new];
    [self.navigationController pushViewController:rSuccessVC animated:YES];
}

#pragma mark -
#pragma mark 属性
#pragma mark 界面配置

- (NSArray *)arrViewConfiguration
{
    if (_arrViewConfiguration == nil) {
        if (_loginType == 0) {
            _arrViewConfiguration = @[@{@"index": @(0), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入邮箱/手机号", @"icon": @"2"},
                                      @{@"index": @(1), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入密码", @"icon": @"2"},
                                      @{@"index": @(2), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请确认密码", @"icon": @"2"},
                                      @{@"index": @(3), @"identify": NSStringFromClass([LVerifyTableViewCell class]), @"placeHolder": @"请输入验证码", @"icon": @"2"},
                                      @{@"index": @(4), @"identify": NSStringFromClass([RButtonTableViewCell class]), @"rember": @(1)},];
        }
        else {
            _arrViewConfiguration = @[@{@"index": @(0), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入手机号", @"icon": @"2"},
                                      @{@"index": @(1), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入学校/机构名称", @"icon": @"2"},
                                      @{@"index": @(2), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请选择所在国家", @"icon": @"2", @"showSelected": @(1)},
                                      @{@"index": @(3), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入申请人姓名", @"icon": @"2"},
                                      @{@"index": @(4), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入联系邮箱", @"icon": @"2"},
                                      @{@"index": @(5), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请输入密码", @"icon": @"2"},
                                      @{@"index": @(6), @"identify": NSStringFromClass([LTextFieldTableViewCell class]), @"placeHolder": @"请确认密码", @"icon": @"2"},
                                      @{@"index": @(7), @"identify": NSStringFromClass([LVerifyTableViewCell class]), @"placeHolder": @"请输入验证码", @"icon": @"2"},
                                      @{@"index": @(8), @"identify": NSStringFromClass([RButtonTableViewCell class]), @"rember": @(1)},];
        }
    }
    return _arrViewConfiguration;
}

@end
