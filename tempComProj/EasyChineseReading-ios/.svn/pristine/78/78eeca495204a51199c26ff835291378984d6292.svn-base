//
//  ECRBookInfoViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/11.
//  Copyright © 2017年 lee. All rights reserved.
//

static CGFloat pjRowHeight = 70;
static NSString *pjCell = @"ECRDetailPJTableViewCell";

#import "ECRBookInfoViewController.h"
#import "ECRSwichView.h"
#import "ECRBookInfoModel.h"
#import "ECRBookInfoTableViewCell.h"
#import "ECRBiCommentModel.h"
#import "ECRDetailPJTableViewCell.h"
#import "ZStarView.h"
#import "ECRSettleAccountsController.h"
#import "ECRRentSeriousViewController.h"
#import "ECRShoppingCarViewController.h"
#import "ECRShoppingCarManager.h"
#import "ECRShoppingCarModel.h"
#import "ECRDataHandler.h"
#import "ECRScoreUserModel.h"
#import "ECRRequestFailuredView.h"

@interface ECRBookInfoViewController ()<
UITableViewDelegate,
UITableViewDataSource,
ECRSwichViewDelegate,
ECRRequestFailuredViewDelegate
>{
    CGFloat ssvH;// switchscrollview 的 height
}

@property (strong, nonatomic) IBOutlet UIScrollView *baseScrollView;
@property (strong, nonatomic) IBOutlet UIView *topInfoView;
@property (strong, nonatomic) IBOutlet UIScrollView *swithcScrollView;
@property (strong, nonatomic) IBOutlet UIView *buttonView;

@property (strong, nonatomic) IBOutlet ECRSwichView *diSwitchView;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *ssvHeight;

@property (weak, nonatomic) IBOutlet UIImageView *biCover;
@property (weak, nonatomic) IBOutlet UILabel *biName;
@property (weak, nonatomic) IBOutlet UILabel *biAuthor;
@property (weak, nonatomic) IBOutlet ZStarView *biStar;
@property (weak, nonatomic) IBOutlet UILabel *biPrice;
@property (weak, nonatomic) IBOutlet UILabel *biPriceSymbles;

@property (weak, nonatomic) IBOutlet UIView *biRectView;
@property (weak, nonatomic) IBOutlet UIView *biLine;
@property (weak, nonatomic) IBOutlet UIView *biLine2;
@property (weak, nonatomic) IBOutlet UIButton *buyButton;// 购买纸质书

@property (weak, nonatomic) IBOutlet UITableView *infoTableView;
@property (weak, nonatomic) IBOutlet UITableView *pjTableView;

@property (strong,nonatomic) ECRBookInfoModel *model;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *bitbHeight;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *pjtbHeight;


@property (assign,nonatomic) CGFloat rHeight1;
@property (assign,nonatomic) CGFloat rHeight2;
@property (assign,nonatomic) CGFloat rHeight3;
@property (assign,nonatomic) CGFloat rHeight4;

@property (assign,nonatomic) CGFloat pjHeight;

@property (weak, nonatomic) IBOutlet UIButton *addTosc;// 加入购物车
@property (weak, nonatomic) IBOutlet UIButton *buyEbook;// 购买
@property (weak, nonatomic) IBOutlet UIButton *exper;// 试读
@property (weak, nonatomic) IBOutlet UIButton *setBao;// 系列包月
@property (strong,nonatomic) NSArray *comments;// 品论数据源

@property (strong,nonatomic) ECRRequestFailuredView *rrfv;// 请求失败 view

@end

@implementation ECRBookInfoViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    
}
- (void)setBookId:(NSInteger)bookId{
    _bookId = bookId;
    [self loadNewDataWithBookId:bookId];
}
- (void)loadNewDataWithBookId:(NSInteger)bookId{
    // MARK: 接口调试
    [[ECRDataHandler sharedDataHandler] biDataWithBookId:bookId success:^(id object) {
        ECRBookInfoModel *model = (ECRBookInfoModel *)object;
        self.model = model;
        self.comments = model.scores;
        
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            if (_rrfv != nil) {
                [_rrfv removeFromSuperview];
                _rrfv = nil;
            }
            // 基本信息
            [self.biCover sd_setImageWithURL:[NSURL URLWithString:model.iconUrl] placeholderImage:LGPlaceHolderImg];
            self.biName.text = model.bookName;
            self.biAuthor.text = model.author;
            
            [self.biStar setScore:model.score withAnimation:YES completion:nil];
            self.biPrice.text = [NSString stringWithFormat:@"%.2f",model.price];
            [self.infoTableView reloadData];
            [self.pjTableView reloadData];
            
        }];
        
    } failure:^(NSString *msg) {
//        NSLog(@"msg -- %@",msg);
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    } commenFailure:^(NSError *error) {
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    }];
}

- (IBAction)addToscClick:(UIButton *)sender {
    // MARK: 加入购物车
//    self.model.bookId;
//    self.model.price;
    NSDictionary *dict = [NSDictionary dictionaryWithObjectsAndKeys:
                          [NSString stringWithFormat:@"%ld",self.model.bookId],@"bookId",
                          [NSString stringWithFormat:@"%f",self.model.price],@"price",
                          @"1",@"type",
                          nil];
    [[ECRShoppingCarManager sharedInstance] manageShopCarWithDict:dict success:^(NSMutableArray *totalArray, NSMutableArray *tickedArray, CGFloat priceT) {
        
    }];
}
- (IBAction)buyEbookClick:(UIButton *)sender {
    // MARK: 购买电子书
    ECRSettleAccountsController *savc = [[ECRSettleAccountsController alloc] init];
    savc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:savc animated:YES];
}
- (IBAction)experClick:(UIButton *)sender {
    // MARK: 试读
    
}
- (IBAction)setBaoClick:(UIButton *)sender {
    // MARK: 先跳转至租约系列列表页面，点击租约时再跳转至租约结算
    ECRRentSeriousViewController *rsvc = [[ECRRentSeriousViewController alloc] init];
    rsvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:rsvc animated:YES];
    
}
- (IBAction)bookBuy:(UIButton *)sender {
    // MARK: 购买纸质书
    
}
#pragma mark - ECRRequestFailuredViewDelegate 错误请求代理
- (void)rfViewReloadData:(ECRRequestFailuredView *)view{
    [self loadNewDataWithBookId:self.bookId];
}

#pragma mark - delegate
- (void)ecrSwichView:(ECRSwichView *)view didClick:(NSInteger)click{
    switch (click) {
        case 0:
            [self.swithcScrollView setContentOffset:CGPointZero animated:YES];
            break;
        case 1:
            [self.swithcScrollView setContentOffset:CGPointMake(Screen_Width, 0) animated:YES];
            break;
    }
}
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if ([scrollView isEqual:self.swithcScrollView]) {
        // TODO:
        if (scrollView.contentOffset.x == 0) {
            // MARK: ssv height
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            [self.diSwitchView switchSelectedItem:0];
        }
        if (scrollView.contentOffset.x >= Screen_Width) {
//            NSLog(@"pjh---%f",_pjHeight);
            [self.diSwitchView switchSelectedItem:1];
            self.ssvHeight.constant = _pjHeight;// pjTableView的高度
        }
    }
}
#pragma mark - data source
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if ([tableView isEqual:self.infoTableView]) {
        return 4;
    }
    return _comments.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
//        NSLog(@"%@",indexPath);
        cell.model = self.model;
        return cell;
    }
    ECRDetailPJTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCell];
    ECRScoreUserModel *model = _comments[indexPath.row];
    cell.model = model;
    return cell;
    
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        // MARK: ssv height
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
        cell.model = self.model;
        
        if (indexPath.row == 0) {
            _rHeight1 = cell.rHeight1;
        }
        if (indexPath.row == 1) {
            _rHeight2 = cell.rHeight2;
        }
        if (indexPath.row == 2) {
            _rHeight3 = cell.rHeight3;
        }
        if (indexPath.row == 3) {// 如何获取总高度?
            _rHeight4 = cell.rHeight4;
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
        }
        return cell.rHeight;
    }
    if (indexPath.row == (_comments.count - 1)) {
        _pjHeight = pjRowHeight * (_comments.count);
        self.pjtbHeight.constant = _pjHeight;
        
    }
    return pjRowHeight;
}

- (void)textDependsLauguage{
    NSString *bookInfo = [LGPChangeLanguage localizedStringForKey:@"图书详情"];
    NSString *bookReview = [LGPChangeLanguage localizedStringForKey:@"评价"];
    self.title = bookInfo;
    _diSwitchView.buttonNames = @[bookInfo,bookReview];
    
    [self setBtnLocaText:self.addTosc titleKey:@"加入购物车"];
    [self setBtnLocaText:self.buyEbook titleKey:@"购买"];
    [self setBtnLocaText:self.exper titleKey:@"试读"];
    [self setBtnLocaText:self.setBao titleKey:@"系列包月"];
    [self setBtnLocaText:self.buyButton titleKey:@"购买纸书"];

}
- (void)setBtnLocaText:(UIButton *)button titleKey:(NSString *)titleKey{
    [button setTitle:[LGPChangeLanguage localizedStringForKey:titleKey] forState:UIControlStateNormal];
}

#pragma mark - UI
- (void)setupUI{
    [self textDependsLauguage];
    [self setNavRightCustemView];
    [self.swithcScrollView setContentSize:CGSizeMake(Screen_Width, 0)];
    self.swithcScrollView.pagingEnabled = YES;
    self.infoTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    
    _diSwitchView.delegate = self;
    
    
    self.pjTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.pjTableView registerNib:[UINib nibWithNibName:pjCell bundle:nil] forCellReuseIdentifier:pjCell];
    
    CGFloat borderW = 1;
    UIColor *borderColor = [UIColor cm_purpleColor_82056B_1];
    self.addTosc.layer.borderWidth = borderW;
    self.addTosc.layer.borderColor = borderColor.CGColor;
    self.buyEbook.layer.borderWidth = borderW;
    self.exper.layer.borderWidth = borderW;
    self.setBao.layer.borderWidth = borderW;
    self.buyEbook.layer.borderColor = borderColor.CGColor;
    self.exper.layer.borderColor = borderColor.CGColor;
    self.setBao.layer.borderColor = borderColor.CGColor;
    
    [self.buyEbook setBackgroundColor:[UIColor cm_purpleColor_82056B_1]];
    [self.buyEbook setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
}

#pragma mark - target
- (void)navLike:(UIButton *)sender{
    if (sender.selected) {
        sender.selected = NO;
    }else{
        sender.selected = YES;
    }
    // TODO: 收藏接口
    
}
- (void)navShare:(UIButton *)sender{
    // TODO: 分享(站内信)
    
}
- (void)navCar:(UIButton *)sender{
    // MARK: 跳转购物车
    ECRShoppingCarViewController *spvc = [[ECRShoppingCarViewController alloc] init];
    spvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:spvc animated:YES];
}

- (void)setNavRightCustemView{
    // 导航栏按钮s
    CGFloat bItemW = 28;
    CGFloat bItemY = -3;
    UIButton *like = [UIButton buttonWithType:UIButtonTypeCustom];
    [like setImage:[UIImage imageNamed:@"det3"] forState:UIControlStateNormal];
    [like setImage:[UIImage imageNamed:@"message3" ] forState:UIControlStateSelected];
    [like setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navLike = [[UIBarButtonItem alloc] initWithCustomView:like];
    [like addTarget:self action:@selector(navLike:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *share = [UIButton buttonWithType:UIButtonTypeCustom];
    [share setImage:[UIImage imageNamed:@"det1"] forState:UIControlStateNormal];
    [share setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navShare = [[UIBarButtonItem alloc] initWithCustomView:share];
    [share addTarget:self action:@selector(navShare:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *car = [UIButton buttonWithType:UIButtonTypeCustom];
    [car setImage:[UIImage imageNamed:@"bys_6"] forState:UIControlStateNormal];
    [car setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navCar = [[UIBarButtonItem alloc] initWithCustomView:car];
    [car addTarget:self action:@selector(navCar:) forControlEvents:UIControlEventTouchUpInside];
    
    self.navigationItem.rightBarButtonItems = @[navCar,navShare,navLike];
    
}


#pragma mark - lazy load
- (ECRRequestFailuredView *)rrfv{
    if (_rrfv == nil) {
        _rrfv = [[ECRRequestFailuredView alloc] initWithFrame:self.view.bounds];
        _rrfv.delegate = self;
    }
    return _rrfv;
}

@end
