//
//  ECRShoppingCarViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/8/31.
//  Copyright © 2017年 lee. All rights reserved.
//

/*
    购物车:
        状态:
            1.空
            2.非空
                2.1 有勾选商品
                2.2 无勾选商品
        跳转
            1.商品详情
            2.订单页面
 
 */

#import "ECRShoppingCarViewController.h"
#import "ECRShoppingCarCell.h"
#import "ECRShoppingCarModel.h"
#import "ECRSettleDoneView.h"
#import "ECRBookInfoViewController.h"// 商品详情控制器
#import "ECRSettleAccountsController.h"
#import "ECRSettleAccountsModel.h"// 结算模型
#import "ECRBookFormViewController.h"

@interface ECRShoppingCarViewController ()<
UITableViewDataSource,
UITableViewDelegate,
ECRShoppingCarCellDelegate,
ECRSettleDoneViewDelegate
>

@property (strong,nonatomic) NSMutableArray<ECRShoppingCarModel *> *array;// 商品数组(可变,方便删减物品)
@property (strong,nonatomic) NSMutableArray<ECRShoppingCarModel *> *tickedArray;// 勾选商品数组
@property (strong,nonatomic) UITableView *list;
@property (strong,nonatomic) ECRSettleDoneView *settleDoneView;// MARK: 结算view
@property (assign,nonatomic) CGFloat totalPrice;// 勾选商品总价

@end

@implementation ECRShoppingCarViewController

static NSString *reuserID = @"ECRShoppingCarCell";
static CGFloat sdvHeight = 50;// 结算view 高度

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    [self loadData];
    
}
- (void)loadData{
    // TODO: 请求服务器 购物车数据
    // MARK: 计算总价
    
    // test数据
    for (NSInteger i = 0; i < 10; ++i) {
        ECRShoppingCarModel *model = [[ECRShoppingCarModel alloc] init];
        model.isTick = arc4random_uniform(2);
        model.bName = @"Swift高级编程";
        model.bAuthor = @"克里斯拉特纳";
        model.cover = @"http://img0.imgtn.bdimg.com/it/u=3377718423,1879905595&fm=11&gp=0.jpg";
        model.money = 10;//arc4random_uniform(50);// 随机价格
        [self.array addObject:model];
        if (model.isTick) {
            [self.tickedArray addObject:model];
            _totalPrice += model.money;
        }
    }
    self.settleDoneView.price = _totalPrice;
    [self.list reloadData];
}
- (void)setupUI{
    [self.list registerNib:[UINib nibWithNibName:reuserID bundle:nil] forCellReuseIdentifier:reuserID];
    self.title = @"购物车";
    // MARK:设置 结算view
    self.settleDoneView.delegate = self;
    
    // test data
    
}
#pragma mark - settleDoneView delegate
- (void)sdView:(ECRSettleDoneView *)sdView{
    // MARK: 结算跳转
    ECRBookFormViewController *dFormDetail = [[ECRBookFormViewController alloc] init];
    dFormDetail.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:dFormDetail animated:YES];
    
//    ECRSettleAccountsController *savc = [[ECRSettleAccountsController alloc] init];
//    savc.viewControllerPushWay = ECRBaseControllerPushWayPush;
//    [self.navigationController pushViewController:savc animated:YES];
}
- (void)sdViewAllSelected:(ECRSettleDoneView *)sdView{
    // MARK: 全选
    if (self.array.count == 0) {
        // 当购物车没有任何数据时 执行
        [self.settleDoneView allSelectedCanceled];
    }else{
        // 1.将未选中的商品选中
        // 2.计算总价
        if (self.tickedArray.count > 0 && self.tickedArray.count < self.array.count) {// 部分选中时执行
            [self.tickedArray removeAllObjects];
            self.tickedArray = nil;
            self.tickedArray = [NSMutableArray arrayWithArray:self.array.copy];
            _totalPrice = 0;
            for (NSInteger i = 0; i < self.tickedArray.count; ++i) {
                ECRShoppingCarModel *model = self.tickedArray[i];
                model.isTick = YES;
                _totalPrice += model.money;
            }
            
        }else if(self.tickedArray.count == self.array.count){// 全部选中时执行
            [self.tickedArray removeAllObjects];
            self.tickedArray = nil;
            for (NSInteger i = 0; i < self.array.count; ++i) {
                ECRShoppingCarModel *model = self.array[i];
                model.isTick = NO;
                _totalPrice += model.money;
            }
            _totalPrice = 0;
        }else{// 全部未选中时执行
            self.tickedArray = [NSMutableArray arrayWithArray:self.array.copy];
            _totalPrice = 0;
            for (NSInteger i = 0; i < self.tickedArray.count; ++i) {
                ECRShoppingCarModel *model = self.tickedArray[i];
                model.isTick = YES;
                _totalPrice += model.money;
            }
        }
        NSLog(@"总价：%f",_totalPrice);
        [self.list reloadData];
    }
}
- (void)sdViewAllRemoveFormCar:(ECRSettleDoneView *)sdView{
    // 删除商品
    if (self.tickedArray.count) {
        
        // 便利 删除模型
        for (NSInteger i = 0; i < self.tickedArray.count; ++i) {
            ECRShoppingCarModel *modelSelected = self.tickedArray[i];
            for (NSInteger j = 0; j < self.array.count; ++j) {
                ECRShoppingCarModel *model = self.array[j];
                if (modelSelected == model) {
                    [self.array removeObject:model];
                }
            }
        }
        
        [self.tickedArray removeAllObjects];
        self.tickedArray = nil;
    }
    if (self.array.count == 0) {
        [self.settleDoneView allSelectedCanceled];
    }
    [self.list reloadData];
    
}

#pragma mark - cell delegate
- (void)scCell:(ECRShoppingCarCell *)cell selectProduct:(ECRShoppingCarModel *)model{
    // MARK: 选中 或者 取消选中 商品
    if (model.isTick) {
        model.isTick = NO;
        [self.tickedArray removeObject:model];
        // MARK: 修改总价(-)
        self.totalPrice -= model.money;
    }else{
        model.isTick = YES;
        [self.tickedArray addObject:model];
        // MARK: 修改总价(+)
        self.totalPrice += model.money;
    }
    
    if (self.tickedArray.count == 0) {
        _totalPrice = 0;
        self.tickedArray = nil;
        [self.settleDoneView allSelectedCanceled];
    }
//    NSLog(@"选中个数：%ld",self.tickedArray.count);
    [self.list reloadData];
}
- (void)scCell:(ECRShoppingCarCell *)cell clickProduct:(ECRShoppingCarModel *)model{
    // MARK: 点击商品, 跳转至商品详情页面
    
}

#pragma mark - UITableViewDelegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return _array.count ? _array.count : 0;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRShoppingCarCell *cell = [tableView dequeueReusableCellWithIdentifier:reuserID];
    cell.delegate = self;
    ECRShoppingCarModel *model;
    if (_array.count) {
        model = _array[indexPath.row];
    }
    cell.model = model;
    return cell;
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 152;
}
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    // 跳转至详情页面
    ECRShoppingCarModel *model;
    if (_array.count) {
        model = _array[indexPath.row];
    }
    // test: 详情链接
    UIStoryboard *board = [UIStoryboard storyboardWithName:@"BookInfo" bundle:nil];
    ECRBookInfoViewController *bivc = [board instantiateViewControllerWithIdentifier:@"ECRBookInfoViewController"];
    bivc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:bivc animated:YES];
}

- (void)setTotalPrice:(CGFloat)totalPrice{
    _totalPrice = totalPrice;
    self.settleDoneView.price = totalPrice;
}

- (UITableView *)list{
    if (_list == nil) {
        CGRect rect = CGRectMake(0, 0, Screen_Width, Screen_Height - sdvHeight -64);
        _list = [[UITableView alloc] initWithFrame:rect style:UITableViewStylePlain];
        _list.delegate = self;
        _list.dataSource = self;
        _list.separatorStyle = UITableViewCellSeparatorStyleNone;
        [self.view addSubview:_list];
    }
    return _list;
}
- (NSMutableArray *)array{
    if (_array == nil) {
        _array = [NSMutableArray arrayWithCapacity:10];
    }
    return _array;
}
- (NSMutableArray<ECRShoppingCarModel *> *)tickedArray{
    if (_tickedArray == nil) {
        _tickedArray = [NSMutableArray arrayWithCapacity:10];
    }
    return _tickedArray;
}
- (ECRSettleDoneView *)settleDoneView{
    if (_settleDoneView == nil) {
        CGFloat sdY = self.view.height - sdvHeight - 64;
        CGRect sdRect = CGRectMake(0, sdY, Screen_Width, sdvHeight);
        _settleDoneView = [[ECRSettleDoneView alloc] initWithFrame:sdRect];
        [self.view addSubview:_settleDoneView];
    }
    return _settleDoneView;
}

@end






