//
//  ECRBookFormViewController.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/9/27.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRBookFormViewController.h"
#import "ECRPaymentPreviousView.h"
#import "ECRBookFormTopView.h"
#import "ECRPpvPirceView.h"
#import "ECRPpvScoreView.h"
#import "ECRTopupFieldView.h"
#import "ECRFullMinusRollView.h"
#import "ECRFullminusTableViewCell.h"
#import "ECRFullminusModel.h"

static NSString *btBtnTitle = @"返回购物车";
static NSString *pyBtnTitle = @"支付";
static NSString *pyBtnTitleZero= @"充值并购买";//
static NSString *fullminusCell = @"ECRFullminusTableViewCell";
static CGFloat  cellH = 130;

@interface ECRBookFormViewController ()<
UITableViewDataSource,
UITableViewDelegate,
ECRFullminusTableViewCellDelegate
>
@property (weak,nonatomic) UIColor *bbBtnBorderColor;//
//@property (strong,nonatomic) UIScrollView *scrollView;//
@property (strong,nonatomic) UIButton *backTosc;//
@property (strong,nonatomic) UIButton *pay;//

@property (strong,nonatomic) ECRPaymentPreviousView *ppv;//
@property (strong,nonatomic) ECRTopupFieldView *payView;//
@property (strong,nonatomic) NSArray *coupons;//

@end

@implementation ECRBookFormViewController

#pragma mark - <##>ECRFullminusTableViewCellDelegate
- (void)fullminusCell:(ECRFullminusTableViewCell *)cell indexPath:(NSIndexPath *)indexPath{
    // MARK: 选中满减卷
    for (NSInteger i = 0; i < self.coupons.count; i++) {
        ECRFullminusModel *model = self.coupons[i];
        if (i == indexPath.row) {
            model.isSelected = YES;
        }else{
            model.isSelected = NO;
        }
    }
    [self.ppv.fullMinusView.tableView reloadData];
}

#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return _coupons.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRFullminusTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:fullminusCell];
    ECRFullminusModel *model = _coupons[indexPath.row];
    cell.delegate = self;
    cell.inx = indexPath;
    cell.model = model;
    return cell;
}
#pragma mark - UITableViewDelegate
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return cellH;
}
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
}

- (void)backClick:(UIButton *)sender{
    // 返回购物车
}
- (void)payClick:(UIButton *)sender{
    // 支付或购买
    self.payView.hidden = NO;
    self.ppv.hidden = YES;
    self.backTosc.hidden = YES;
    self.pay.hidden = YES;
    [self.payView.textField becomeFirstResponder];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    [self loadNewData];
}
- (void)loadNewData{
    // TEST DATA
    NSMutableArray *arrM = [NSMutableArray arrayWithCapacity:10];
    for (NSInteger i = 0; i < 4; i++) {
        ECRFullminusModel *model = [[ECRFullminusModel alloc] init];
        if (!i) {
            model.isSelected = YES;
        }
        [arrM addObject:model];
    }
    self.coupons = arrM.copy;
    [self.ppv.fullMinusView.tableView reloadData];
}

- (void)setupUI{
    self.title = @"订单明细";

    [self.view addSubview:self.backTosc];
    [self.view addSubview:self.pay];
    [self.view addSubview:self.payView];
    
    ECRBookFormTopView *btv = [[ECRBookFormTopView alloc] init];
    btv.priceTotal = @"90.00";
    [self.view addSubview:btv];
    
    [self.view addSubview:self.ppv];
    self.ppv.priceView.priceYu = @"0";
    self.ppv.scoreCoun.priceYu = @"100";
    // TODO: 如果用户余额为0
//    [self.pay setTitle:pyBtnTitleZero forState:UIControlStateNormal];
    
    [btv mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.view.mas_top);
        make.left.equalTo(self.view.mas_left);
        make.bottom.equalTo(self.ppv.mas_top);
        make.right.equalTo(self.view.mas_right);
        make.height.equalTo(@50);
        make.width.equalTo(@(Screen_Width));
    }];
    [self.payView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(btv.mas_bottom).offset(50);
        make.left.equalTo(self.view.mas_left);
        make.right.equalTo(self.view.mas_right);
        make.bottom.equalTo(self.view.mas_bottom);
    }];
    [self.ppv mas_makeConstraints:^(MASConstraintMaker *make) {
        make.width.equalTo(@(Screen_Width));
        make.left.equalTo(self.view.mas_left);
        make.right.equalTo(self.view.mas_right);
        make.bottom.equalTo(self.backTosc.mas_top);
    }];
    CGFloat heightBB = 50;
    [self.backTosc mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.ppv.mas_bottom);
        make.left.equalTo(self.view.mas_left);
        make.bottom.equalTo(self.view.mas_bottom);
        make.height.equalTo(@(heightBB));
        make.width.equalTo(@(Screen_Width / 2));
    }];
    [self.pay mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.equalTo(self.view.mas_right);
        make.width.equalTo(@(Screen_Width / 2 + 1));
        make.top.equalTo(self.backTosc.mas_top);
        make.bottom.equalTo(self.backTosc.mas_bottom);
    }];
    self.payView.hidden = YES;
    
    self.ppv.fullMinusView.tableView.dataSource = self;
    self.ppv.fullMinusView.tableView.delegate = self;
    [self.ppv.fullMinusView.tableView registerNib:[UINib nibWithNibName:fullminusCell bundle:nil] forCellReuseIdentifier:fullminusCell];
    
}
- (ECRTopupFieldView *)payView{
    if (_payView == nil) {
        _payView = [[ECRTopupFieldView alloc] init];
        _payView.textFontSize = 14;
        _payView.buttonTitle = @"支付";
        _payView.textField.keyboardType = UIKeyboardTypeNumberPad;
    }
    return _payView;
}
- (ECRPaymentPreviousView *)ppv{
    if (_ppv == nil) {
        _ppv = [[ECRPaymentPreviousView alloc] init];
        
    }
    return _ppv;
}
- (UIButton *)backTosc{
    if (_backTosc == nil) {
        _backTosc = [[UIButton alloc] init];
        _backTosc.layer.borderWidth = 1;
        _backTosc.layer.borderColor = self.bbBtnBorderColor.CGColor;
        [_backTosc setTitle:btBtnTitle forState:UIControlStateNormal];
        [_backTosc setTitleColor:[UIColor cm_purpleColor_82056B_1] forState:UIControlStateNormal];
        [_backTosc.titleLabel setFont:[UIFont systemFontOfSize:14]];
        [_backTosc setBackgroundColor:[UIColor whiteColor]];
        [_backTosc addTarget:self action:@selector(backClick:) forControlEvents:UIControlEventTouchUpInside];
    }
    return _backTosc;
}
- (UIButton *)pay{
    if (_pay == nil) {
        _pay = [[UIButton alloc] init];
        _pay.layer.borderWidth = 1;
        _pay.layer.borderColor = self.bbBtnBorderColor.CGColor;
        [_pay setTitle:pyBtnTitle forState:UIControlStateNormal];
        [_pay setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        [_pay.titleLabel setFont:[UIFont systemFontOfSize:14]];
        [_pay setBackgroundColor:[UIColor cm_purpleColor_82056B_1]];
        [_pay addTarget:self action:@selector(payClick:) forControlEvents:UIControlEventTouchUpInside];
    }
    return _pay;
}
- (UIColor *)bbBtnBorderColor{
    if (_bbBtnBorderColor == nil) {
        _bbBtnBorderColor = [UIColor cm_lineColor_E3E3E3_1];
    }
    return _bbBtnBorderColor;
}

@end
