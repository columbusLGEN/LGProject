//
//  ECRSubjectController.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/10/23.
//  Copyright © 2017年 retech. All rights reserved.
//

static NSString *reuserID = @"ECRSubjectCell";
static NSString *headerID = @"ECRSubjectHeaderView";

#import "ECRSubjectController.h"
#import "ECRSubjectView.h"
#import "ECRSubjectRowModel.h"
#import "ECRSubjectModel.h"
#import "ECRSubjectCell.h"
#import "ECRBookInfoViewController.h"
#import "ECRThematicModel.h"
#import "ECRSubjectHeaderView.h"

@interface ECRSubjectController ()<
UITableViewDelegate,
UITableViewDataSource
>
@property (strong,nonatomic) NSMutableArray<ECRSubjectRowModel *> *rowModels;//
@property (strong,nonatomic) ECRSubjectView *sbv;//

@property (assign,nonatomic) CGFloat headerHeight;//
@property (assign,nonatomic) NSInteger reqLength;//
@property (assign,nonatomic) NSInteger reqPage;//

@end

@implementation ECRSubjectController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];

    
}

- (void)setupUI{
    [self.view addSubview:self.sbv];
    [[NSNotificationCenter defaultCenter]
     addObserver:self
     selector:@selector(subjectBookClickNotification:)
     name:ECRSubjectBookClickNotification object:nil];

    MJRefreshNormalHeader *rfHeader = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(loadNewData)];
    self.sbv.tableView.mj_header = rfHeader;
    
    MJRefreshAutoFooter *rfFooter = [MJRefreshAutoFooter footerWithRefreshingTarget:self refreshingAction:@selector(loadMoreData)];
    self.sbv.tableView.mj_footer = rfFooter;
    
}
// MARK: 请求数据
- (void)setModel:(ECRThematicModel *)model{
    _model = model;
    self.title = model.thematicName;
    [self loadNewData];
}
- (void)loadNewData{
    self.reqPage = 0;
//    [self.sbv.tableView.mj_header beginRefreshing];
    [[ECRDataHandler sharedDataHandler] subjectDataWithSpecial:[NSString stringWithFormat:@"%ld",self.model.seqid] series:nil classify:nil length:self.reqLength page:self.reqPage sort:0 success:^(id object) {
        [self.sbv.tableView.mj_header endRefreshing];
        self.rowModels = [NSMutableArray arrayWithArray:object];
        self.reqPage = self.rowModels.count;
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            [self.sbv.tableView reloadData];
        }];
    } failure:^(NSString *msg) {
        [self.sbv.tableView.mj_header endRefreshing];
        self.reqPage = 0;
    } commenFailure:^(NSError *error) {
        [self.sbv.tableView.mj_header endRefreshing];
        self.reqPage = 0;
    }];
}

- (void)loadMoreData{
    [self.sbv.tableView.mj_footer endRefreshing];
//    NSLog(@"page -- %ld",self.reqPage);
//    [[ECRDataHandler sharedDataHandler] subjectDataWithSpecial:[NSString stringWithFormat:@"%ld",self.model.seqid] series:nil classify:nil length:self.reqLength page:self.reqPage sort:0 success:^(id object) {
//        NSArray *array = object;
//        [self.sbv.tableView.mj_footer endRefreshing];
//        [self.rowModels addObjectsFromArray:object];
//        self.reqPage += array.count;
//        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
//            [self.sbv.tableView reloadData];
//        }];
//    } failure:^(NSString *msg) {
//        [self.sbv.tableView.mj_footer endRefreshing];
//        self.reqPage = 0;
//    } commenFailure:^(NSError *error) {
//        [self.sbv.tableView.mj_footer endRefreshing];
//        self.reqPage = 0;
//    }];
}

// MARK: 点击书籍的通知
- (void)subjectBookClickNotification:(NSNotification *)notification{
    NSDictionary *userInfo = notification.userInfo;
    ECRSubjectModel *model = userInfo[@"model"];
    UIStoryboard *board = [UIStoryboard storyboardWithName:@"BookInfo" bundle:nil];
    ECRBookInfoViewController *bivc = [board instantiateViewControllerWithIdentifier:@"ECRBookInfoViewController"];
    bivc.bookId = model.bookId;
    bivc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:bivc animated:YES];

}
#pragma mark - table view data source & delegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.rowModels.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRSubjectCell *cell = [tableView dequeueReusableCellWithIdentifier:reuserID];
    ECRSubjectRowModel *rowModel = self.rowModels[indexPath.row];
    cell.rowModel = rowModel;
    return cell;
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRSubjectCell *cell = [tableView dequeueReusableCellWithIdentifier:reuserID];
    return cell.cellHeight;
}
- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    ECRSubjectHeaderView *header = [tableView dequeueReusableHeaderFooterViewWithIdentifier:headerID];
    header.imgURL = self.model.specialPic;
    return header;
}
- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return self.headerHeight;
}
- (void)scrollViewDidScroll:(UIScrollView *)scrollView {
    CGFloat sectionHeaderHeight = self.headerHeight;
    if(scrollView.contentOffset.y<=sectionHeaderHeight&&scrollView.contentOffset.y>=0) {
        scrollView.contentInset = UIEdgeInsetsMake(-scrollView.contentOffset.y, 0, 0,0);
    } else if (scrollView.contentOffset.y>=sectionHeaderHeight) {
        scrollView.contentInset = UIEdgeInsetsMake(-sectionHeaderHeight, 0, 0, 0);
    }
}

- (ECRSubjectView *)sbv{
    if (_sbv == nil) {
        _sbv = [[ECRSubjectView alloc] initWithFrame:self.view.bounds];
        _sbv.tableView.dataSource = self;
        _sbv.tableView.delegate = self;
        [_sbv.tableView registerNib:[UINib nibWithNibName:reuserID bundle:nil] forCellReuseIdentifier:reuserID];
        [_sbv.tableView registerNib:[UINib nibWithNibName:headerID bundle:nil] forHeaderFooterViewReuseIdentifier:headerID];
    }
    return _sbv;
}
- (CGFloat)headerHeight{
    if ([[ECRMultiObject sharedInstance] userInterfaceIdiom] == UIUserInterfaceIdiomPad) {
        return 240;
    }else{
        return 180;
    }
}
- (void)dealloc{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

- (NSInteger)reqLength{
    return 12;
}
- (NSMutableArray<ECRSubjectRowModel *> *)rowModels{
    if (_rowModels == nil) {
        _rowModels = [NSMutableArray new];
    }
    return _rowModels;
}


@end


/**
     ECRSubjectView --> 主view
     ECRSubjectCell --> 一个cell 有两个 或者 一个 ECRSubjectSingleView
     ECRSubjectSingleView  --> 一本书
 
 */
