//
//  UIVCRechargeVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/7.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UVirtualCurrencyRechargeVC.h"

#import <PassKit/PassKit.h>                                 //用户绑定的银行卡信息
#import <PassKit/PKPaymentAuthorizationViewController.h>    //Apple pay的展示控件
#import <AddressBook/AddressBook.h>                         //用户联系信息相关
#import <AlipaySDK/AlipaySDK.h>

#import "UIVCRTopCollectionViewCell.h"
#import "UIVCRBottomCollectionViewCell.h"
#import "UIVCRHeaderRV.h"
#import "UIVCRFooterRV.h"

static CGFloat kSpace = 10.f;

@interface UVirtualCurrencyRechargeVC ()<
UICollectionViewDelegate, UICollectionViewDataSource, UICollectionViewDelegateFlowLayout,
PKPaymentAuthorizationViewControllerDelegate,
UIVCRFooterRVDelegate>

@property (strong, nonatomic) IBOutlet UICollectionView *collectionView;
@property (strong, nonatomic) UICollectionViewFlowLayout *layout;

@property (nonatomic, strong) UIVCRFooterRV *footerView;    // 支付

@property (strong, nonatomic) NSArray *arrRechargeType; // 充值方式
@property (strong, nonatomic) NSArray *arrRechargeNumb; // 充值数额

@property (nonatomic, assign) NSInteger selectedType;   // 选择支付类别
@property (nonatomic, assign) NSInteger selectedNumb;   // 选择支付数额

@property (nonatomic, assign) CGFloat price;            // 支付的金额

@end

@implementation UVirtualCurrencyRechargeVC

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self configRechargeView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)updateSystemLanguage
{
    self.title = _arrRechargeType == ENUM_RechargeTypeRecharge ? LOCALIZATION(@"虚拟币充值") : LOCALIZATION(@"包月套餐");
    [_collectionView reloadData];
}

#pragma mark 配置 虚拟币充值界面

- (void)configRechargeView
{
    self.collectionView.collectionViewLayout = self.layout;

    [_collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UIVCRTopCollectionViewCell class]) bundle:nil] forCellWithReuseIdentifier:NSStringFromClass([UIVCRTopCollectionViewCell class])];
    [_collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UIVCRBottomCollectionViewCell class]) bundle:nil] forCellWithReuseIdentifier:NSStringFromClass([UIVCRBottomCollectionViewCell class])];

    [_collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UIVCRHeaderRV class]) bundle:nil] forSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UIVCRHeaderRV class])];
    [_collectionView registerNib:[UINib nibWithNibName:NSStringFromClass([UIVCRFooterRV class]) bundle:nil] forSupplementaryViewOfKind:UICollectionElementKindSectionFooter withReuseIdentifier:NSStringFromClass([UIVCRFooterRV class])];
}

#pragma mark -
#pragma mark UICollectionViewDataSource

- (NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView
{
    return 2;
}

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    return 0 == section ? self.arrRechargeType.count : self.arrRechargeNumb.count;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath
{
    if (0 == indexPath.section) {
        UIVCRTopCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:NSStringFromClass([UIVCRTopCollectionViewCell class]) forIndexPath:indexPath];
        cell.lblRechargeType.text = [[_arrRechargeType objectAtIndex:indexPath.row] objectForKey:@"type"];
        cell.imgIcon.image = [UIImage imageNamed:[NSString stringWithFormat:@"%@", [[_arrRechargeType objectAtIndex:indexPath.row] objectForKey:@"image"]]];
        cell.isSelected = indexPath.row == _selectedType;
        return cell;
    }
    else {
        UIVCRBottomCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:NSStringFromClass([UIVCRBottomCollectionViewCell class]) forIndexPath:indexPath];
        cell.isSelected = indexPath.row == _selectedNumb;

        if (_rechargeType == ENUM_RechargeTypeRecharge) { // 充值
            cell.lblRechargeNum.text = [NSString stringWithFormat:@"%@%@", LOCALIZATION(@"¥"),[_arrRechargeNumb[indexPath.row] objectForKey:@"price"]];
            cell.lblGiveNum.text = [NSString stringWithFormat:@"%@%@%@", LOCALIZATION(@"赠送"), [_arrRechargeNumb[indexPath.row] objectForKey:@"give"], LOCALIZATION(@"虚拟币")];
            cell.lblLeaseNum.hidden = YES;
        }
        else {  // 包月
            cell.lblLeaseNum.text = [NSString stringWithFormat:@"%@%@/%@", LOCALIZATION(@"¥"), [_arrRechargeNumb[indexPath.row] objectForKey:@"pay"], LOCALIZATION(@"天")];
            cell.lblLeaseNum.hidden = YES;
            cell.lblGiveNum.hidden = YES;
        }
        
        return cell;
    }
}

#pragma mark UICollectionViewDelegate

- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath
{

    if (kind == UICollectionElementKindSectionHeader) {
        UIVCRHeaderRV *headerView = [collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UIVCRHeaderRV class]) forIndexPath:indexPath];
        if (0 == indexPath.section) {
            headerView.lblDescribe.text = _rechargeType == ENUM_RechargeTypeRecharge ? LOCALIZATION(@"请选择充值方式") : LOCALIZATION(@"请选择支付方式");
        }
        else {
            headerView.lblDescribe.text =  _rechargeType == ENUM_RechargeTypeRecharge ?  LOCALIZATION(@"请选择充值金额") : LOCALIZATION(@"请选择租阅套餐");
        }
        return headerView;
    }
    else {
        _footerView = [collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionFooter withReuseIdentifier:@"UIVCRFooterRV" forIndexPath:indexPath];
        if (1 == indexPath.section) {
            if (_price == 0) {
                NSNumber *num = _arrRechargeNumb.firstObject[@"price"];
                _price = [num floatValue];
            }
            _footerView.payNum = _price;
            _footerView.delegate = self;
        }
        else {
            
        }
        return _footerView;
    }
}

- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout sizeForItemAtIndexPath:(NSIndexPath *)indexPath
{
    CGFloat width  = 0 == indexPath.section ? Screen_Width - kSpace * 2 : (Screen_Width - kSpace * 3) / 2;
    CGFloat height = 0 == indexPath.section ? 60 : 70;
    return CGSizeMake(width, height);
}

- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout referenceSizeForHeaderInSection:(NSInteger)section
{
    return CGSizeMake(Screen_Width, 56);
}

- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout referenceSizeForFooterInSection:(NSInteger)section
{
    CGFloat height = 0 == section ? .5f : 150;
    return CGSizeMake(Screen_Width, height);
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    if (0 == indexPath.section) {
        _selectedType = indexPath.row;
        [self.collectionView reloadData];
    }
    else {
        _selectedNumb = indexPath.row;
        NSNumber *num = [_arrRechargeNumb objectAtIndex:indexPath.row][@"price"];
        _price = [num floatValue];
        [self.collectionView reloadData];
    }
}

#pragma mark -
#pragma mark UIVCRFooterRVDelegate

- (void)payWithMoney
{
    if (_selectedType == ENUM_RechargeWayApplePay) {
        [self applePayHandle];
    }
    else {
        [self aliPayHandle];
    }
}

#pragma mark --------------- 支付选择项 ---------------
#pragma mark - applePay

- (void)applePayHandle
{
    // 是否支持ApplePay
    if ([PKPaymentAuthorizationViewController canMakePayments]) {
        if (![PKPaymentAuthorizationViewController class]) {
            //PKPaymentAuthorizationViewController需iOS8.0以上支持
            [self presentFailureTips:LOCALIZATION(@"操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持")];
            return;
        }
        //检查当前设备是否可以支付
        if (![PKPaymentAuthorizationViewController canMakePayments]) {
            //支付需iOS9.0以上支持
            [self presentFailureTips:LOCALIZATION(@"操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持")];
            return;
        }
        //检查用户是否可进行某种卡的支付，是否支持Amex、MasterCard、Visa与银联四种卡，根据自己项目的需要进行检测
        NSArray *supportedNetworks = @[PKPaymentNetworkAmex,            // 美国运通卡
                                       PKPaymentNetworkMasterCard,      // Master卡
                                       PKPaymentNetworkVisa,            // Visa卡
                                       PKPaymentNetworkChinaUnionPay];  // 中国银联卡
        // 判断 设备上用户有没有添加银行卡，如果没添加，不写这个判断，真机上会crash。
        if (![PKPaymentAuthorizationViewController canMakePaymentsUsingNetworks:supportedNetworks]) {
            [self presentFailureTips:LOCALIZATION(@"还没有绑定支付卡, 请先到 wallet 绑定支付卡")];
            return;
        }
        
        // 支付类目及额度
        PKPaymentRequest *request = [[PKPaymentRequest alloc] init];
        
        PKPaymentSummaryItem *widget1 = [PKPaymentSummaryItem
                                         summaryItemWithLabel:@"Widget 1"
                                         amount:[NSDecimalNumber decimalNumberWithString:@"0.01"]];
        
        PKPaymentSummaryItem *widget2 = [PKPaymentSummaryItem
                                         summaryItemWithLabel:@"Widget 2"
                                         amount:[NSDecimalNumber decimalNumberWithString:@"0.01"]];
        
        PKPaymentSummaryItem *total = [PKPaymentSummaryItem
                                       summaryItemWithLabel:@"Grand Total"
                                       amount:[NSDecimalNumber decimalNumberWithString:@"0.02"]];
        
        request.paymentSummaryItems = @[widget1, widget2, total];
        // 国家码
        request.countryCode = @"CN";
        // 币种 (CNY 人民币)
        request.currencyCode = @"CHW";
        
        //能支付的币种
        request.supportedNetworks = @[
                                      PKPaymentNetworkChinaUnionPay,
                                      PKPaymentNetworkMasterCard,
                                      PKPaymentNetworkVisa
                                      ];
        
        //Merchant ID
        request.merchantIdentifier = @"merchant.com.retech.EasyChineseReading.applypay";
        
        // 询问你的付款处理器 （PKMerchantCapabilityCredit
        // 信用卡，PKMerchantCapabilityDebit 借记卡）
        
        /*
         PKMerchantCapabilityCredit NS_ENUM_AVAILABLE_IOS(9_0)   = 1UL << 2,   //
         支持信用卡
         PKMerchantCapabilityDebit  NS_ENUM_AVAILABLE_IOS(9_0)   = 1UL << 3    //
         支持借记卡
         */
        request.merchantCapabilities = PKMerchantCapabilityDebit;
        // 添加联系人全部信息
        request.requiredShippingAddressFields = PKAddressFieldAll;
        
        // 调用 PKPaymentAuthorizationViewController
        PKPaymentAuthorizationViewController *paymentPane = [[PKPaymentAuthorizationViewController alloc] initWithPaymentRequest:request];
        paymentPane.delegate = self;
        [self presentViewController:paymentPane animated:TRUE completion:nil];
        
    } else {
        [self presentFailureTips:LOCALIZATION(@"你的设备目前还不支持 applepay 支付")];
        return;
    }
}

#pragma mark PKPaymentAuthorizationViewControllerDelegate

- (void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didAuthorizePayment:(PKPayment *)payment completion:(void (^)(PKPaymentAuthorizationStatus status))completion {
    NSLog(@"Payment was authorized: %@", payment);
    
//    -- PKPayment 对象
//    token 支付成功之后的回执，需要上传给服务器。
//    billingAddress 用户账单地址
//    billingContact 用户账单信息
//    shippingAddress 送货地址
//    shippingContact 送货信息
//    shippingMethod 送货方式
    
    BOOL asyncSuccessful = FALSE;
    
    if (asyncSuccessful) {
        completion(PKPaymentAuthorizationStatusSuccess);
        [self presentSuccessTips:LOCALIZATION(@"支付成功")];
    }
    else {
        completion(PKPaymentAuthorizationStatusFailure);
        [self presentFailureTips:LOCALIZATION(@"支付失败")];
    }
}

- (void)paymentAuthorizationViewControllerDidFinish:(PKPaymentAuthorizationViewController *)controller {
    // hide the payment window
    [controller dismissViewControllerAnimated:TRUE completion:nil];
}

#pragma mark - aliPay
// TODO: 临时测试用
- (void)aliPayHandle
{
    NSString *appScheme = @"EasyChineseReading";
    NSString *orderString = @"app_id=2016082000290178&biz_content=%7B%22body%22%3A%22%E6%88%91%E6%98%AF%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%22%2C%22out_trade_no%22%3A%2220171030195617401878%22%2C%22product_code%22%3A%22QUICK_MSECURITY_PAY%22%2C%22subject%22%3A%22App%E6%94%AF%E4%BB%98%E6%B5%8B%E8%AF%95Java%22%2C%22timeout_express%22%3A%2230m%22%2C%22total_amount%22%3A%220.01%22%7D&charset=UTF-8&format=json&method=alipay.trade.app.pay&notify_url=%E5%95%86%E6%88%B7%E5%A4%96%E7%BD%91%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E7%9A%84%E5%BC%82%E6%AD%A5%E5%9C%B0%E5%9D%80&sign=ME0jkItPDiMoQ5L8OnomxNwWvqxIG36iTZPD%2BSx0tc%2Bzs0WdEgIJH38sMFijRgX8B%2F%2BzWnaCmQmUM%2FZGEDsb%2BA0evZzPNpnoLO0iOJzjDKdLNQZrPHz63J9o2hx%2FS3looHjaTYxnDuh7q%2F2tbI0StGKs9i9O%2Boerkraf7ouyTmPExRlBXK1PWaA9YNRmyxbyP3RmXgbjdIxZkb7rQPgrLYS%2F7Kyj6MPGjC2ZGW0CJK15r5c7Moh3%2BP%2BRBupPlrXpR2qyjpKo6M1Zzlj6mNF6Tl13CC15pXIEgJOWwoevXW0PMnQ%2Fzv0Mj11SoGh2hPe%2BfLPJbRLkOM80foNgHeodWg%3D%3D&sign_type=RSA2&timestamp=2017-10-30+19%3A56%3A18&version=1.0";
    
    // NOTE: 调用支付结果开始支付
    [[AlipaySDK defaultService] payOrder:orderString fromScheme:appScheme callback:^(NSDictionary *resultDic) {
        NSLog(@"reslut = %@",resultDic);
    }];
}

#pragma mark - 属性

- (UICollectionViewFlowLayout *)layout
{
    if (!_layout) {
        _layout = [[UICollectionViewFlowLayout alloc] init];
        _layout.minimumLineSpacing = kSpace;
        _layout.minimumInteritemSpacing = kSpace;
        _layout.scrollDirection = UICollectionViewScrollDirectionVertical;
        _layout.sectionInset = UIEdgeInsetsMake(0, kSpace, kSpace, kSpace);
    }
    return _layout;
}

- (UICollectionView *)collectionView
{
    if (!_collectionView) {
        _collectionView = [[UICollectionView alloc] initWithFrame:self.view.frame collectionViewLayout:self.layout];
        _collectionView.delegate = self;
        _collectionView.dataSource = self;
        _collectionView.scrollEnabled = NO;
        [self.view addSubview:_collectionView];
    }
    return _collectionView;
}

- (NSArray *)arrRechargeType
{
    if (_arrRechargeType == nil) {
        _arrRechargeType = @[@{@"type": @"Apple Pay" , @"image": @"buy4"},
                             @{@"type": LOCALIZATION(@"支付宝支付"), @"image": @"pay1"}];
    }
    return _arrRechargeType;
}

- (NSArray *)arrRechargeNumb
{
    if (_arrRechargeNumb == nil) {
        if (_rechargeType == ENUM_RechargeTypeRecharge) { // 充值
            _arrRechargeNumb = @[@{@"price": @"50",  @"give": @"0"},
                                 @{@"price": @"100", @"give": @"10"},
                                 @{@"price": @"200", @"give": @"20"},
                                 @{@"price": @"500", @"give": @"100"}];
        }
        else if (_rechargeType == ENUM_RechargeTypeLeaseAll) { // 全平台包月
            _arrRechargeNumb = @[@{@"price": @"50",  @"days": @"30"},
                                 @{@"price": @"100", @"days": @"90"},
                                 @{@"price": @"300", @"days": @"365"},
                                 @{@"price": @"500", @"days": @"730"}];
        }
        else {  // 包月
            _arrRechargeNumb = @[@{@"price": @"10", @"days": @"30"},
                                 @{@"price": @"20", @"days": @"90"},
                                 @{@"price": @"30", @"days": @"180"},
                                 @{@"price": @"50", @"days": @"365"}];
        }
    }
    return _arrRechargeNumb;
}

@end
