//
//  UserMessageManagerVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 2017/10/13.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "UserMessageManagerVC.h"

#import "UMessageTableViewCell.h"

#import "UFriendInfoVC.h"
#import "UFriendChatVC.h"

@interface UserMessageManagerVC ()<
UITableViewDelegate, UITableViewDataSource,
UMessageTableViewCellDelegate>

@property (strong, nonatomic) UITableView *tableView; // 列表
@property (strong, nonatomic) NSMutableArray *arrDataSource; // 消息数据

@end

@implementation UserMessageManagerVC

- (void)viewDidLoad
{
    [super viewDidLoad];
    [self configMessageManagerView];
}

#pragma mark - 配置界面

- (void)configMessageManagerView
{
    self.title = @"消息";
    [self configTableView];
    [self getUnReadMessages];
}

- (void)configTableView
{
    _tableView = [[UITableView alloc] initWithFrame:self.view.bounds style:UITableViewStylePlain];
    
    _tableView.delegate = self;
    _tableView.dataSource = self;
    
    _tableView.estimatedRowHeight = 100;
    _tableView.rowHeight = UITableViewAutomaticDimension;
    
    [_tableView registerNib:[UINib nibWithNibName:NSStringFromClass([UMessageTableViewCell class]) bundle:nil] forCellReuseIdentifier:NSStringFromClass([UMessageTableViewCell class])];
    
    [self.view addSubview:_tableView];
}

#pragma mark - 获取数据
// 拉取未读消息
- (void)getUnReadMessages
{
    [[FriendRequest sharedInstance] getMessageAndShareBookCompletion:^(id object, ErrorModel *error) {
        if (error) {
            [self presentFailureTips:error.message];
        }
        else {
            _arrDataSource = [UserModel mj_objectArrayWithKeyValuesArray:object];
            [_tableView reloadData];
        }
    }];
}

#pragma mark - UITableViewDataSource

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return _arrDataSource.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UMessageTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:NSStringFromClass([UMessageTableViewCell class])];
    cell.delegate = self;
    cell.data = _arrDataSource[indexPath.row];
    return cell;
}

#pragma mark - UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    UserModel *user = _arrDataSource[indexPath.row];
    UFriendChatVC *chatVC = [UFriendChatVC loadFromStoryBoard:@"User"];
    chatVC.userId = user.userId;
    [self.navigationController pushViewController:chatVC animated:YES];
}

#pragma mark - UMessageTableViewCellDelegate

- (void)seeUserInfoWithUser:(UserModel *)user
{
    UFriendInfoVC *frinendInfo = [UFriendInfoVC loadFromStoryBoard:@"User"];
    FriendModel *friend = [FriendModel new];
    friend.userId  = user.userId;
    friend.name    = user.name;
    friend.iconUrl = user.iconUrl;
    frinendInfo.friendInfo = friend;
    [self.navigationController pushViewController:frinendInfo animated:YES];
}

#pragma mark - 属性

- (NSMutableArray *)arrDataSource
{
    if (_arrDataSource == nil) {
        _arrDataSource = [NSMutableArray array];
    }
    return _arrDataSource;
}

@end
