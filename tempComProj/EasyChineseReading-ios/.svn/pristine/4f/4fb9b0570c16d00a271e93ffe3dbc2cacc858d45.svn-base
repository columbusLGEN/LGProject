//
//  ECRBookrackModel.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/5.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "ECRBookrackModel.h"
#import "SDWebImageDownloader.h"
#import "LGPImageOperator.h"

@interface ECRBookrackModel ()

@end

@implementation ECRBookrackModel

- (id)copyWithZone:(NSZone *)zone{
    ECRBookrackModel *copyModel = [[ECRBookrackModel allocWithZone:zone] init];
    copyModel.iconUrl = self.iconUrl;
    copyModel.currentPlace = 2;
    copyModel.owendType = self.owendType;
    copyModel.id = self.id;
    copyModel.bookId = self.bookId;
    copyModel.eBookFormat = self.eBookFormat;
    copyModel.books = self.books.mutableCopy;
    copyModel.alreadyBuyBooks = self.alreadyBuyBooks.mutableCopy;
    copyModel.groupName = self.groupName.mutableCopy;
    copyModel.name = self.name.mutableCopy;
    copyModel.groupId = self.groupId;
    copyModel.bookName = self.bookName.mutableCopy;
    copyModel.en_bookName = self.en_bookName.mutableCopy;
    copyModel.locationUrl = self.locationUrl;
    copyModel.academicProbationUrl = self.academicProbationUrl;
    copyModel.downloadURL = self.downloadURL;
    copyModel.localURL = self.localURL;
    
    return copyModel;
}

- (void)createGroupWithFromModel:(ECRBookrackModel *)fromModel toModel:(ECRBookrackModel *)toModel currentPlace:(NSInteger)currentPlace{
    if (currentPlace == 1) {// 全部图书
        self.books = [NSMutableArray arrayWithCapacity:10];
        [self.books addObject:fromModel];// 先加"手上"的
        [self.books addObject:toModel];
    }
    if (currentPlace == 2) {// 已购买
        [self.alreadyBuyBooks addObject:fromModel];// 先加"手上"的
        [self.alreadyBuyBooks addObject:toModel];
    }
    
}

- (void)addBooksWithFromModel:(ECRBookrackModel *)fromModel currentPlace:(NSInteger)currentPlace{
    if (currentPlace == 1) {// 全部图书
        [self.books insertObject:fromModel atIndex:0];
    }
    if (currentPlace == 2) {// 已购买
        [self.alreadyBuyBooks insertObject:fromModel atIndex:0];
    }
}

/// 生成水印封面
- (void)wmImage:(void(^)(UIImage *wmi))wmiBlock{
    __block UIImage *wmi;
    [[SDWebImageDownloader sharedDownloader] downloadImageWithURL:[NSURL URLWithString:self.iconUrl] options:0 progress:nil completed:^(UIImage * _Nullable image, NSData * _Nullable data, NSError * _Nullable error, BOOL finished) {
        // 缩小size
        UIImage *img_crop = [LGPImageOperator cropImage:image scale:0.1];

        // 压缩大小
//        NSData *data_cutdown = UIImageJPEGRepresentation(image,0.1);
//        UIImage *img_cutdown = [UIImage imageWithData:data_cutdown];
        
        // &
        NSData *data_final = UIImageJPEGRepresentation(img_crop,0.1);
        UIImage *img_final = [UIImage imageWithData:data_final];
        
//        NSLog(@"原图size %@ 大小 %ld",NSStringFromCGSize(image.size),data.length);
//        NSLog(@"压缩后size %@ 大小 %ld",NSStringFromCGSize(img_cutdown.size),data_cutdown.length);
//        NSLog(@"等比例缩放后size %@ 大小 %ld",NSStringFromCGSize(img_final.size),data_final.length);
        CGRect watermarkRect = CGRectMake(0, img_final.size.height - 50, 50, 50);
        
        wmi = [LGPImageOperator addWatermarkWith:img_final watemarkImage:[UIImage imageNamed:wmiNameWithOwnedType(self.owendType)] size:img_final.size wmiRect:watermarkRect];
        self.wmImg = wmi;
        if (wmiBlock) {
            wmiBlock(wmi);
        }
        
        /// 子线程异步执行
//        dispatch_async(dispatch_get_global_queue(0, 0), ^{
//            NSLog(@"currentThread -- %@",[NSThread currentThread]);
//            wmi = [LGPImageOperator addWatermarkWith:img_final watemarkImage:[UIImage imageNamed:wmiNameWithOwnedType(self.owendType)] size:img_final.size wmiRect:watermarkRect];
//            self.wmImg = wmi;
//
//        });
        
        
    }];
    
}
NSString *wmiNameWithOwnedType(BookModelOwnedType ownedType){
    switch (ownedType) {
        case BookModelOwnedTypeNotOwned:
            return @"icon_try_read_water";
            break;
        default:
            return @"";
            break;
    }
}

- (NSMutableArray<ECRBookrackModel *> *)alreadyBuyBooks{
    if (_alreadyBuyBooks == nil) {
        _alreadyBuyBooks = [NSMutableArray array];
    }
    return _alreadyBuyBooks;
}

+ (NSDictionary *)mj_objectClassInArray{
    return @{@"books":@"ECRBookrackModel"};
}

@end








