//
//  ECRDataHandler.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/4.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "ECRDataHandler.h"
#import "ECRHTTPSessionManager.h"
#import "ECRResObjc.h"
#import "ECRHomeMainModel.h"

#import "ECRHomeClassModel.h"
#import "ECRHomeBook.h"
#import "ECRSeriesModel.h"
#import "ECRThematicModel.h"
#import "ECRAdvModel.h"
#import "ECRRankUser.h"

@interface ECRDataHandler ()


@end

@implementation ECRDataHandler

- (void)biDataWithBookId:(NSString *)bookId success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerCommenFailure)failure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
    param[@"imei"] = @"imei";
    param[@"imsi"] = @"imsi";
    param[@"md5"]  = @"md5";
    param[@"bookId"] = bookId;
    //books/bookDetails
    [self commonGetDataWithInterface:@"books/bookDetails" param:param success:^(id responseObject) {
//        NSLog(@"bookdetails -- %@",responseObject);
//        NSLog(@"recommend -- %@",[[responseObject firstObject] objectForKey:@"recommend"]);
        if (success) {
            success([[responseObject firstObject] objectForKey:@"recommend"]);
        }
    } failure:failure];
}

// MARK: 首页请求
- (void)homeDataWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerCommenFailure)failure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
    param[@"imei"] = @"imei";
    param[@"imsi"] = @"imsi";
    param[@"md5"]  = @"md5";
    [self commonGetDataWithInterface:@"books/index" param:param success:^(id responseObject) {
        ECRHomeMainModel *homeModel = [ECRHomeMainModel mj_objectWithKeyValues:[responseObject firstObject]];
//        NSLog(@"returnJson -- %@",[responseObject firstObject]);
//        NSLog(@"homeModel -- %@",homeModel);
        if (success) {
            success(homeModel);
        }
    } failure:failure];

}
// MARK: 通用请求
- (void)commonGetDataWithInterface:(NSString *)interface param:(id)param success:(void(^)(id responseObject))success failure:(void (^)(NSError *error))failure{
    [[ECRHTTPSessionManager sharedManager] POSTWithInterface:interface param:param success:^(id responseObject) {
        // 对请求的数据进行处理
        // TODO:.判断请求是否成功
        
        // msg
        // result
        NSString *msg = [responseObject objectForKey:@"msg"];
        NSNumber *result = [responseObject objectForKey:@"result"];
        NSLog(@"msg -- %@",msg);
        NSLog(@"result -- %@",result);
       
        // returnJson string
        NSString *jsonString = [responseObject objectForKey:@"returnJson"];
        NSData *jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];
        id jsonObjc = [NSJSONSerialization JSONObjectWithData:jsonData options:NSJSONReadingMutableContainers error:nil];
        
        NSLog(@"returnJson -- %@",jsonString);
        
        if (success) {
            success(jsonObjc);
        }
        

    } failure:^(NSError *error) {
        NSLog(@"error  -- %@",error);
    }];
    
}

+ (instancetype)sharedDataHandler{
    static id instance;
    static dispatch_once_t once;
    dispatch_once(&once, ^{
        instance = [self new];
    });
    return instance;
}

@end
