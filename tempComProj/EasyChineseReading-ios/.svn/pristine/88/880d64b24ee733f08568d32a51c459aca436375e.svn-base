//
//  ECRLocationManager.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/10/11.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRLocationManager.h"
#import <CoreLocation/CoreLocation.h>

@interface ECRLocationManager ()<
CLLocationManagerDelegate
>
@property (nonatomic, strong) CLLocationManager *locationManager;
@property (copy,nonatomic) void (^cnBlock)(NSString *country);// 回调 国家名字

@end

@implementation ECRLocationManager

#pragma mark - CLLocationManagerDelegate
- (void)locationManager:(CLLocationManager *)manager
     didUpdateLocations:(NSArray<CLLocation *> *)locations {
    if (locations.count != 0) {
        CLLocation *location = locations[0];
        CLGeocoder *geocoder = [[CLGeocoder alloc] init];
        // MARK: 通过经纬度 反地理编码 得到街道信息
        [geocoder reverseGeocodeLocation:location completionHandler:^(NSArray<CLPlacemark *> * _Nullable placemarks, NSError * _Nullable error) {
            CLPlacemark *placemark = placemarks[0];
            if (self.cnBlock) {
//                NSLog(@"clplacemark -- %@",placemark);
                self.cnBlock(placemark.country);
//                self.cnBlock(@"特立尼达和多巴哥");
            }
        }];
        [self.locationManager stopUpdatingLocation];
    }
}

+ (void)rg_startUpdatingLocationWithBlock:(void (^)(NSString *))cnBlock{
   ECRLocationManager *mgr = [self sharedInstance];
    mgr.cnBlock = cnBlock;
    if ([[UIDevice currentDevice].systemVersion floatValue] >= 8.0) {
        [mgr.locationManager requestAlwaysAuthorization];
    }
    [mgr.locationManager startUpdatingLocation];
}

- (instancetype)init{
    if (self = [super init]) {
        self.locationManager = [[CLLocationManager alloc] init];
        self.locationManager.delegate = self;
    }
    return self;
}

+ (instancetype)sharedInstance{
    static id instance;
    static dispatch_once_t once;
    dispatch_once(&once, ^{
        instance = [self new];
    });
    return instance;
}

@end
