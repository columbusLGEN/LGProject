//
//  UInfoVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/8/30.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserInfoVC.h"

#import "ZPickViewTool.h"
#import "ZPickDateView.h"

#import "UserInfoAddressVC.h"

@interface UserInfoVC ()<UITextFieldDelegate, ZPickDateViewDelegate, ZPickViewToolDelegate>

@property (weak, nonatomic) IBOutlet UILabel *lblDescAvatar;
@property (weak, nonatomic) IBOutlet UILabel *lblDescName;
@property (weak, nonatomic) IBOutlet UILabel *lblDescLive;
@property (weak, nonatomic) IBOutlet UILabel *lblDescSex;
@property (weak, nonatomic) IBOutlet UILabel *lblDescLanguage;
@property (weak, nonatomic) IBOutlet UILabel *lblDescCountry;
@property (weak, nonatomic) IBOutlet UILabel *lblDescLearnYears;
@property (weak, nonatomic) IBOutlet UILabel *lblDescInsterest;
@property (weak, nonatomic) IBOutlet UILabel *lblDescBirthday;
@property (weak, nonatomic) IBOutlet UILabel *lblDescSchool;

@property (weak, nonatomic) IBOutlet UIImageView *imgAvatar;

@property (weak, nonatomic) IBOutlet UITextField *txtfName;
@property (weak, nonatomic) IBOutlet UITextField *txtfAddress;
@property (weak, nonatomic) IBOutlet UITextField *txtfInterest;
@property (weak, nonatomic) IBOutlet UITextField *txtSchool;

@property (weak, nonatomic) IBOutlet UILabel *lblSex;
@property (weak, nonatomic) IBOutlet UILabel *lblLanguage;
@property (weak, nonatomic) IBOutlet UILabel *lblCountry;
@property (weak, nonatomic) IBOutlet UILabel *lblLearnYears;
@property (weak, nonatomic) IBOutlet UILabel *lblBirthday;

@property (weak, nonatomic) IBOutlet UIButton *btnSave;

/** 性别 */
@property (strong, nonatomic) NSArray *arrSex;
/** 语言 */
@property (strong, nonatomic) NSArray *arrLanguage;
/** 学习年数 */
@property (strong, nonatomic) NSArray *arrLearnYear;

/** 性别选择 */
@property (strong, nonatomic) ZPickViewTool *pickViewSex;

/** 母语选择 */
@property (nonatomic, strong) ZPickViewTool *pickViewLanguage;

/** 学习年数选择 */
@property (nonatomic, strong) ZPickViewTool *pickViewLearnYear;

/** 用户信息 */
@property (nonatomic, strong) UserModel *user;

@end

@implementation UserInfoVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.title = @"我的信息";
    
    [self configUserInfoView];
    [self configUserInfoData];
    [self addNotification];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark -
#pragma mark 配置 用户信息界面

- (void)configUserInfoView
{
    _imgAvatar.backgroundColor = [UIColor whiteColor];
    
    _imgAvatar.layer.borderColor = [UIColor whiteColor].CGColor;
    _imgAvatar.layer.borderWidth = 3.f;
    _imgAvatar.layer.cornerRadius = _imgAvatar.height/2;
    
    _imgAvatar.layer.shadowColor = [UIColor blackColor].CGColor;
    _imgAvatar.layer.shadowOffset = CGSizeMake(0, 0);
    _imgAvatar.layer.shadowOpacity = 0.5f;
    
    _btnSave.layer.masksToBounds = YES;
    _btnSave.layer.cornerRadius = _btnSave.height/2;
    
    _btnSave.backgroundColor = [UIColor cm_purpleColor_82056B_1];
    [_btnSave setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
}

- (void)configUserInfoData
{
    _user = [[UserModel alloc] init];
    _user = [[UserRequest sharedInstance].user copy];
    
    if (_user.name.length > 0) {
        _txtfName.text = _user.name;
    }
    else if (_user.phone.length > 0) {
        _txtfName.text = _user.phone;
    }
    else if (_user.email.length > 0) {
        _txtfName.text = _user.email;
    }
    
    [_imgAvatar sd_setImageWithURL:[NSURL URLWithString:_user.iconUrl] placeholderImage:[UIImage imageNamed:@"tx"]];
    
    _txtfAddress.text = _user.address;
    _txtfInterest.text = _user.interest;
    _txtSchool.text = _user.school;
    
    _lblSex.text = [NSString stringWithFormat:@"%@", self.arrSex[_user.sex]];
    _lblLanguage.text = [NSString stringWithFormat:@"%@", self.arrLanguage[_user.motherTongue]];
    _lblCountry.text = _user.country;
    _lblLearnYears.text = [NSString stringWithFormat:@"%ld", _user.learnyears];
    _lblBirthday.text = _user.birthday.length > 0 ? [_user.birthday substringToIndex:10] : @"";
}

- (void)addNotification
{
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(textFieldDidChanged:) name:UITextFieldTextDidChangeNotification object:nil];
}

#pragma mark - UIPickerView

/**
 性别选择
 */
- (void)configPickViewSex
{
    _pickViewSex = [[ZPickViewTool alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, self.view.height) dataSource:self.arrSex selected:0];
    _pickViewSex.delegate = self;
    [_pickViewSex show];
}

/**
 母语选择
 */
- (void)configPickViewLanguage
{
    _pickViewLanguage = [[ZPickViewTool alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, self.view.height) dataSource:self.arrLanguage selected:0];
    _pickViewLanguage.delegate = self;
    [_pickViewLanguage show];
}

/**
 学习年限选择
 */
- (void)configPickViewLearnYears
{
    _pickViewLearnYear = [[ZPickViewTool alloc] initWithFrame:CGRectMake(0, 0, Screen_Width, self.view.height) dataSource:self.arrLearnYear selected:0];
    _pickViewLearnYear.delegate = self;
    [_pickViewLearnYear show];
}

#pragma mark -
#pragma mark UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    switch (indexPath.row) {
        case 0:
            [self camera];
            break;
        case 3:
            [self configPickViewSex];
            break;
        case 4:
            [self configPickViewLanguage];
            break;
        case 5:
            [self toSelectCountry];
            break;
        case 6:
            [self configPickViewLearnYears];
            break;
        case 8:
            [self seletcedBirthday];
            break;
        default:
            break;
    }
}

- (void)tableView:(UITableView *)tableView willDisplayCell:(UITableViewCell *)cell forRowAtIndexPath:(NSIndexPath *)indexPath
{
    [cell setCellSeparatorInset:UIEdgeInsetsZero];
}

#pragma mark -
#pragma mark UITextFieldDelegate

- (void)textFieldDidBeginEditing:(UITextField *)textField
{
    textField.textAlignment = NSTextAlignmentLeft;
}

- (void)textFieldDidChanged:(UITextField *)textField
{
    if (textField == _txtfName) {
        _user.name = textField.text;
    }
    else if (textField == _txtfAddress) {
        _user.address = textField.text;
    }
    else if (textField == _txtfInterest) {
        _user.interest = textField.text;
    }
    else if (textField == _txtSchool) {
        _user.school = textField.text;
    }
}

- (void)textFieldDidEndEditing:(UITextField *)textField
{
    textField.textAlignment = NSTextAlignmentRight;
}

#pragma mark - UIScrollViewDelegate

- (void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    [self resignAllFirstResponder];
}

- (void)resignAllFirstResponder
{
    if ([_txtfName isFirstResponder]) { [_txtfName resignFirstResponder]; }
    else if ([_txtSchool isFirstResponder]) { [_txtSchool resignFirstResponder]; }
    else if ([_txtfAddress isFirstResponder]) { [_txtfAddress resignFirstResponder]; }
    else if ([_txtfInterest isFirstResponder]) { [_txtfInterest resignFirstResponder]; }
}

#pragma mark -
#pragma mark ZPickDateViewDelegate

- (void)datePickerViewCancel:(ZPickDateView *)pikcer
{
    [[ZPickDateView sharedInstance] hidden];
}

- (void)datePickerView:(ZPickDateView *)pikcer selectedDate:(NSDate *)aValue
{
    [[ZPickDateView sharedInstance] hidden];
    NSString *strDate = [NSString stringWithFormat:@"%@", aValue];
    strDate = [strDate substringToIndex:10];
    _lblBirthday.text = strDate;
    _user.birthday = strDate;
}

#pragma mark -
#pragma mark ZPickViewToolDelegate

- (void)ZPickView:(ZPickViewTool *)pickViewTool clickCancel:(id)handle
{
    if (pickViewTool == _pickViewSex) {
        [pickViewTool hidden];
    }
    if (pickViewTool == _pickViewLanguage) {
        [pickViewTool hidden];
    }
    if (pickViewTool == _pickViewLearnYear) {
        [pickViewTool hidden];
    }
}
- (void)ZPickView:(ZPickViewTool *)pickViewTool clickSureWithIndex:(NSInteger)index
{
    if (pickViewTool == _pickViewSex) {
        _user.sex = index;
    }
    if (pickViewTool == _pickViewLanguage) {
        _user.motherTongue = index;
    }
    if (pickViewTool == _pickViewLearnYear) {
        _user.learnyears = index;
    }
    [pickViewTool hidden];
}

#pragma mark -
#pragma mark action

/**
 点击保存
 */
- (IBAction)click_btnSave:(id)sender {
    [self saveUserInfo];
}

/**
 保存用户信息
 */
- (void)saveUserInfo {
    
    [[UserRequest sharedInstance] updateUserInfoWithName:_user.name
                                                 address:_user.address
                                                     sex:[NSString stringWithFormat:@"%ld", _user.sex]
                                                language:[NSString stringWithFormat:@"%ld", _user.motherTongue]
                                                 country:_user.country
                                              learnyears:[NSString stringWithFormat:@"%ld", _user.learnyears]
                                                interest:_user.interest
                                                birthday:_user.birthday
                                                 iconUrl:_user.iconUrl
                                                  school:_user.school
                                              completion:^(id object, ErrorModel *error) {
                                                  if (error) {
                                                      [self presentFailureTips:error.message];
                                                  }
                                                  else {
                                                      NSLog(@"object %@", object);
                                                  }
                                              }];
}

/**
 选择国家
 */
- (void)toSelectCountry
{
    UserInfoAddressVC *addressVC = [[UserInfoAddressVC alloc] init];
    addressVC.selectedCountryBlock = ^(NSString * country){
        _user.country = country;
    };
    [self.navigationController pushViewController:addressVC animated:YES];
}

/**
 选择生日
 */
- (void)seletcedBirthday
{
    [ZPickDateView sharedInstance].delegete = self;
    [[ZPickDateView sharedInstance] show];
}

#pragma mark -
#pragma mark 更换头像

/**
 拍照
 */
- (void)camera
{
    [self showAlertForSystemPhotoWithTitle:nil];
}

/**
 选择照片

 @param image 照片
 */
- (void)handleImgWith:(UIImage *)image
{
    // TODO: 上传图片未完成 完成后 完善上传图片接口
    
}

#pragma mark -
#pragma mark 属性

- (NSArray *)arrSex
{
    if (_arrSex == nil) {
        _arrSex = @[@"男", @"女"];
    }
    return _arrSex;
}

- (NSArray *)arrLanguage
{
    if (_arrLanguage == nil) {
        _arrLanguage = @[@"汉语", @"English"];
    }
    return _arrLanguage;
}

- (NSArray *)arrLearnYear
{
    if (_arrLearnYear == nil) {
        NSMutableArray *array = [NSMutableArray array];
        for (NSInteger i = 0; i < 100; i ++) {
            [array addObject:@(i)];
        }
        _arrLearnYear = [NSMutableArray arrayWithArray:array];
    }
    return _arrLearnYear;
}

@end
