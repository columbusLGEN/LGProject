//
//  UserInfo.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/9/6.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserRequest.h"

@implementation UserRequest

CM_SINGLETON_IMPLEMENTION(UserRequest)

- (id)init
{
    if ( self = [super init] )
    {
        [self loadCache];
    }
    return self;
}

- (void)saveCache
{
    [[CacheDataSource sharedInstance] setCache:self.user withCacheKey:@"user"];
    [[CacheDataSource sharedInstance] setCache:self.token withCacheKey:@"userToken"];
//    [[CacheDataSource sharedInstance] setCache:self.deviceToken withCacheKey:@"deviceToken"];

//    if (self.user)
//    {
//        self.userphone = self.user.phone;
//        self.userNickName = self.user.name;
//    }
//    [[CacheDataSource sharedInstance] setCache:self.userphone withCacheKey:@"userphone"];
//    [[CacheDataSource sharedInstance] setCache:self.userNickName withCacheKey:@"userName"];
}

- (void)loadCache
{
    self.user = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"user"];
    self.token = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userToken"];
//    self.deviceToken = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"deviceToken"];
//    self.userphone = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userphone"];
//    self.userNickName = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:@"userName"];
}

- (void)clearCache	
{
    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"user"];
    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"userToken"];
//    [[CacheDataSource sharedInstance] setCache:nil withCacheKey:@"loginUserDyList"];
    self.token = @"";
    self.user = nil;
}

#pragma mark -

+ (BOOL)online
{
    return [[UserRequest sharedInstance] online];
}

- (BOOL)online
{
    if ( ![NSString isEmpty:self.token] && self.user)
    {
        return YES;
    }
    return NO;
}

/** 退出登录 */
- (void)signout
{
    if ( self.online )
    {
        [self clearCache];
//        [self fk_postNotification:kNotificationUserLogout];
    }
}

/** 在其他机器登录，被踢下线 */
- (void)kickout
{
    if ( self.online )
    {
        static UIAlertView *alertView;
        if (alertView == nil) {
            NSDate * date = [NSDate dateWithTimeIntervalSinceNow:-120];
            NSDateFormatter * dateFormatter = [[NSDateFormatter alloc] init];
            [dateFormatter setDateFormat:@"HH:ss"];
            
            NSString * resultStr = [dateFormatter stringFromDate:date];
            NSString * str = [NSString stringWithFormat:@"当前帐号于%@在iPhone设备上登录。若非本人的操作，你的密码可能已经泄漏，请及时更改你的密码。",resultStr];
            alertView = [[UIAlertView alloc] initWithTitle:str message:nil delegate:self cancelButtonTitle:@"确定" otherButtonTitles:nil,nil];
//            WeakSelf(weakSelf)
//            alertView.whenDidSelectCancelButton = ^{
//                [weakSelf signout];
//                alertView = nil;
//            };
            [alertView show];
        }
    }
}

#pragma mark -
#pragma mark ===== 数据 接口 =====

#pragma mark - 获取用户信息
/**
 获取用户信息
 
 @param userId      用户id
 @param completion  回调
 */
- (void)getUserInfoWithUserId:(NSString *)userId
                   completion:(CompleteBlock)completion
{
    NSDictionary *dic = @{@"params": @{@"userId": userId},
                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
                                    strUrl:@"user/personalInformation"
                                parameters:dic
                             completeBlock:^(id responseObject, ErrorModel *error) {
                                 if (error) {
                                     completion(nil, error);
                                 }
                                 else {
                                     UserModel *user = [UserModel mj_objectWithKeyValues:[responseObject firstObject]];
                                     [UserRequest sharedInstance].user = user;
                                     [[CacheDataSource sharedInstance] setCache:self.user withCacheKey:@"user"];
                                     completion(user, nil);
                                 }
                             }];
}



#pragma mark - 用户注册

/**
 用户注册
 
 @param type       用户类型 （1 普通 3 机构）
 @param userType   账号类型 （1 手机 2 邮箱）
 @param password   密码
 @param school     学校
 @param country    国家
 @param name       姓名
 @param email      邮箱
 @param phone      手机号
 @param completion 回调
 */
- (void)registerUserWithType:(NSString *)type
                    userType:(NSString *)userType
                    password:(NSString *)password
                      school:(NSString *)school
                     country:(NSString *)country
                        name:(NSString *)name
                       email:(NSString *)email
                       phone:(NSString *)phone
                  completion:(CompleteBlock)completion
{
    NSDictionary * dic = @{@"params": @{@"type"    : type,
                                        @"userType": userType.length > 0 ? userType : @"",
                                        @"password": password,
                                        @"school"  : [userType isEqualToString:@"2"] ? school  : @"",
                                        @"country" : [userType isEqualToString:@"2"] ? country : @"",
                                        @"name"    : name.length  > 0 ? name  : @"",
                                        @"email"   : email.length > 0 ? email : @"",
                                        @"phone"   : phone.length > 0 ? phone : @""},
                           @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
                                    strUrl:@"user/register"
                                parameters:dic
                             completeBlock:^(id responseObject, ErrorModel *error) {
                                 if (error) {
                                     completion(nil, error);
                                 }
                                 else {
                                     completion(responseObject, nil);
                                 }
                             }];
}

#pragma mark - 验证账户的唯一性

/**
 验证账户的唯一性
 
 @param userName   账号（手机 邮箱）
 @param userType   账号类型 （手机 邮箱）
 @param completion 回调
 */
- (void)verifyAccountSingleWithUserName:(NSString *)userName
                               userType:(NSString *)userType
                             completion:(CompleteBlock)completion
{
    NSDictionary * dic = @{@"params": @{@"userName": userName,
                                        @"userType": userType},
                           @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
                                    strUrl:@"user/checkUser"
                                parameters:dic
                             completeBlock:^(id responseObject, ErrorModel *error) {
                                 if (error) {
                                     completion(nil, error);
                                 }
                                 else {
                                     completion(responseObject, nil);
                                 }
                             }];
}

#pragma mark - 用户登录

/**
 用户登录
 
 @param type       登录类型（1.token登录--没有退出账号，关闭app后再次打开需要验证token，使用此接口token登录 2.密码登录）
 @param userType   账号类型（1.手机号 2.邮箱）
 @param user       账号
 @param password   密码
 @param userId     用户id(与token配对使用)
 @param token      token
 @param completion 回调
 */
- (void)loginWithType:(NSString *)type
             userType:(NSString *)userType
                 user:(NSString *)user
             password:(NSString *)password
               userId:(NSString *)userId
                token:(NSString *)token
           completion:(CompleteBlock)completion
{
    NSDictionary *dic = @{@"params": @{@"type"      : type,
                                       @"userType"  : userType,
                                       @"user"      : user.length > 0     ? user     : @"",
                                       @"password"  : password.length > 0 ? password : @"",
                                       @"userId"    : userId.length > 0   ? userId   : @"",
                                       @"token"     : token.length  > 0   ? token    : @""},
                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
                                    strUrl:@"user/login"
                                parameters:dic
                             completeBlock:^(id responseObject, ErrorModel *error) {
                                 if (error) {
                                     completion(nil, error);
                                 }
                                 else {
                                     
                                     responseObject = [responseObject mj_JSONObject];
                                     responseObject = [responseObject firstObject];
                                     completion(responseObject, nil);
                                 }
                             }];
}

#pragma mark - 发送手机验证码

/**
 发送手机验证码
 
 @param phone      手机号
 @param completion 回调
 */
- (void)sendPhoneCodeWithPhone:(NSString *)phone
                    completion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": userId},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}


#pragma mark - 发送邮箱验证码

/**
 发送邮箱验证码
 
 @param email      邮箱
 @param completion 回调
 */
- (void)sendEmailCodeWithEmail:(NSString *)email
                    completion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": userId},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}

#pragma mark - 验证验证码

/**
 验证验证码
 
 @param type        验证码类型
 @param userId      用户id
 @param verifi      验证码
 @param completion  回调
 */
- (void)verityCodeWithType:(NSString *)type
                    userId:(NSString *)userId
                    verifi:(NSString *)verifi
                completion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": userId},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}

#pragma mark - 修改用户信息

/**
 修改用户信息
 
 @param name        名字
 @param address     地址
 @param sex         性别
 @param language    母语
 @param country     国籍
 @param learnyears  学习汉语年数
 @param interest   兴趣爱好
 @param birthday    生日
 @param iconUrl     头像
 @param school      学校
 @param completion  回调
 */
- (void)updateUserInfoWithName:(NSString *)name
                       address:(NSString *)address
                           sex:(NSString *)sex
                      language:(NSString *)language
                       country:(NSString *)country
                    learnyears:(NSString *)learnyears
                      interest:(NSString *)interest
                      birthday:(NSString *)birthday
                       iconUrl:(NSString *)iconUrl
                        school:(NSString *)school
                    completion:(CompleteBlock)completion
{
    NSDictionary *dic = @{@"params": @{@"userId": [NSString stringWithFormat:@"%ld", self.user.userId],
                                       @"name"      : name.length  > 0      ? name       : @"",
                                       @"address"   : address.length > 0    ? address    : @"",
                                       @"sex"       : sex.length > 0        ? sex        : @"",
                                       @"language"  : language.length > 0   ? language   : @"",
                                       @"country"   : country.length > 0    ? country    : @"",
                                       @"learnyears": learnyears.length > 0 ? learnyears : @"",
                                       @"interest"  : interest.length > 0   ? interest   : @"",
                                       @"birthday"  : birthday.length > 0   ? birthday   : @"",
                                       @"iconUrl"   : iconUrl.length > 0    ? iconUrl    : @"",
                                       @"school"    : school.length > 0     ? school     : @"",},
                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
    
//    NSMutableDictionary *mDic = [[NSMutableDictionary alloc] initWithDictionary:dic];
//    // 拼参数
//    NSMutableDictionary *params = [[NSMutableDictionary alloc] initWithDictionary:mDic[@"params"]];

//    if (name.length 	  > 0) params[@"name"] 	     = name;
//    if (address.length 	  > 0) params[@"address"]    = address;
//    if (sex.length 		  > 0) params[@"sex"] 		 = sex;
//    if (language.length   > 0) params[@"language"]   = language;
//    if (country.length 	  > 0) params[@"country"]    = country;
//    if (learnyears.length > 0) params[@"learnyears"] = learnyears;
//    if (intrerest.length  > 0) params[@"intrerest"]  = intrerest;
//    if (birthday.length   > 0) params[@"birthday"]   = birthday;
//    if (school.length     > 0) params[@"school"]     = school;

//    mDic[@"params"] = params;
//    NSDictionary *newDic = [NSDictionary dictionaryWithDictionary:mDic];
    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
                                    strUrl:@"user/updatelInformation"
                                parameters:dic
                             completeBlock:^(id responseObject, ErrorModel *error) {
                                 if (error) {
                                     completion(nil, error);
                                 }
                                 else {
                                     [UserRequest sharedInstance].user = [UserModel mj_objectWithKeyValues:responseObject];
                                     [[UserRequest sharedInstance] saveCache];
                                     completion(responseObject, nil);
                                 }
                             }];
}

#pragma mark - 上传图片

/**
 上传图片
 
 @param icon        图片
 @param completion  回调
 */
- (void)postImageWithImage:(NSString *)icon
                completion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": [NSString stringWithFormat:@"%ld", self.user.userId]},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}

#pragma mark - 用户阅历分享

/**
 用户阅历分享
 
 @param completion 回调
 */
- (void)shareReadHistoryWithCompletion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": userId},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}

#pragma mark - 卡密兑换

/**
 卡密兑换
 
 @param exchangeId 卡密
 @param completion 回调
 */
- (void)exchangeWithExchangeId:(NSString *)exchangeId
                    completion:(CompleteBlock)completion
{
//    NSDictionary *dic = @{@"params": @{@"userId": userId},
//                          @"md5"   : @"654c01acaf40e0ce6d841a552fd3b96c"};
//    [ZNetworkRequest requestWithHttpMethod:ENUM_ZHttpRequestMethodPost
//                                    strUrl:@"user/personalInformation"
//                                parameters:dic
//                             completeBlock:^(id responseObject, ErrorModel *error) {
//                                 if (error) {
//                                     completion(nil, error);
//                                 }
//                                 else {
//                                     
//                                     completion(responseObject, nil);
//                                 }
//                             }];
}

#pragma mark - 获取虚拟币



#pragma mark - 获取积分

@end
