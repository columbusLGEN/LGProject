//
//  ECRBookFormViewController.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/9/27.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRBookFormViewController.h"
#import "ECRPaymentPreviousView.h"
#import "ECRBookFormTopView.h"
#import "ECRPpvPirceView.h"
#import "ECRPpvScoreView.h"
#import "ECRTopupFieldView.h"
#import "ECRFullMinusRollView.h"
#import "ECRFullminusTableViewCell.h"
#import "ECRFullminusModel.h"
#import "ECRShoppingCarModel.h"
//#import "ECRFullminusRowModel.h"
#import "ECRRowObject.h"
#import "ECRPayDoneController.h"

static NSString *btBtnTitle = @"返回购物车";
static NSString *pyBtnTitle = @"支付";
static NSString *pyBtnTitleZero= @"充值并购买";//
static NSString *fullminusCell = @"ECRFullminusTableViewCell";
//static CGFloat  cellH = 130;

@interface ECRBookFormViewController ()<
UITableViewDataSource,
UITableViewDelegate
//ECRFullminusTableViewCellDelegate
>
@property (weak,nonatomic) UIColor *bbBtnBorderColor;//
//@property (strong,nonatomic) UIScrollView *scrollView;//
@property (strong,nonatomic) UIButton *backTosc;//
@property (strong,nonatomic) UIButton *pay;//

@property (strong,nonatomic) ECRBookFormTopView *btv;//
@property (strong,nonatomic) ECRPaymentPreviousView *ppv;//

@property (strong,nonatomic) NSArray *coupons;//
@property (assign,nonatomic) CGFloat oriPrice;// 总价原价

@end

@implementation ECRBookFormViewController

- (void)setAllJuan:(NSMutableArray<ECRFullminusModel *> *)allJuan{
    _allJuan = allJuan;
    // MARK: 全部 满减juan
    // 设置allJuan 中 juan 的isAva
    [self.allJuan enumerateObjectsUsingBlock:^(ECRFullminusModel * _Nonnull juan, NSUInteger idx_juan, BOOL * _Nonnull stop_juan) {
//        NSLog(@"订单明细juan.type -- %ld",juan.fullminusType.integerValue);
        juan.isAva = NO;// 默认为 NO，只有当 avaJuan中有该类型的juan时，才将isAva设置为YES
        [self.avaJuan.allKeys enumerateObjectsUsingBlock:^(id  _Nonnull key, NSUInteger idx_key, BOOL * _Nonnull stop_key) {
            ECRFullminusModel *avaJuan = _avaJuan[key];
            if (avaJuan.fullminusType == juan.fullminusType) {
                juan.isAva = YES;
            }
//            NSLog(@"排序前juan.ava -- %ld",juan.isAva);
        }];
    }];
    
    // MARK: 将可用的优惠券排到最前面
    NSInteger n = self.allJuan.count;
    NSInteger i, j;
    ECRFullminusModel *tempModel;
    for (j = 0; j < n - 1; j++)
        for (i = 0; i < n - 1 - j; i++){
            ECRFullminusModel *model_i = self.allJuan[i];
            ECRFullminusModel *model_i_next = self.allJuan[i+1];
            if(model_i.isAva < model_i_next.isAva){// 如果
                tempModel = model_i;
                [self.allJuan replaceObjectAtIndex:i withObject:model_i_next];
                [self.allJuan replaceObjectAtIndex:(i + 1) withObject:tempModel];
            }
        }
    [self.allJuan enumerateObjectsUsingBlock:^(ECRFullminusModel * _Nonnull juan, NSUInteger idx_juan, BOOL * _Nonnull stop_juan) {
//        NSLog(@"排序后juan.ava -- %ld",juan.isAva);
    }];
    
    NSArray *arr = [[ECRMultiObject sharedInstance] singleLineDoubleModelWithOriginArr:self.allJuan];
    [arr enumerateObjectsUsingBlock:^(ECRRowObject *  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    }];
    self.coupons = arr;
    [self.ppv.fullMinusView.tableView reloadData];
}
- (void)setTickedArray:(NSArray<ECRShoppingCarModel *> *)tickedArray{
    _tickedArray = tickedArray;
    // MARK: 全部商品
    
}
- (void)setTickedPrice:(CGFloat)tickedPrice{
    _tickedPrice = tickedPrice;
    // MARK: 商品总价
    self.btv.priceTotal = [NSString stringWithFormat:@"%.2f",tickedPrice];
}
- (void)setAvaJuan:(NSDictionary *)avaJuan{
    _avaJuan = avaJuan;
    // MARK: 可用juan 字典
}

- (void)backClick:(UIButton *)sender{
    // 返回购物车
    [self baseViewControllerDismiss];
}
- (void)payClick:(UIButton *)sender{
    // 支付或购买
    ECRPayDoneController *payvc = [ECRPayDoneController new];
    [self.navigationController pushViewController:payvc animated:YES];
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
}


#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.coupons.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRFullminusTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:fullminusCell];
    ECRRowObject *model = self.coupons[indexPath.row];
//    cell.delegate = self;
    cell.inx = indexPath;
    cell.rowModel = model;
    return cell;
}
#pragma mark - UITableViewDelegate
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRFullminusTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:fullminusCell];
//    NSLog(@"height -- %f",cell.cellHeight);
    return cell.cellHeight;
}
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
}
- (void)textDependsLauguage{
    self.title = [LGPChangeLanguage localizedStringForKey:@"订单明细"];
    btBtnTitle = [LGPChangeLanguage localizedStringForKey:@"返回购物车"];
    pyBtnTitle = [LGPChangeLanguage localizedStringForKey:@"支付"];
    pyBtnTitleZero = [LGPChangeLanguage localizedStringForKey:@"充值并购买"];
}

- (void)setupUI{
    [self textDependsLauguage];
    _oriPrice = 0;
    [self.view addSubview:self.backTosc];
    [self.view addSubview:self.pay];
    
    
//    btv.priceTotal = @"90.00";
    [self.view addSubview:self.btv];
    
    [self.view addSubview:self.ppv];
    self.ppv.priceView.priceYu = @"0";
    self.ppv.scoreCoun.priceYu = @"100";
    // TODO: 如果用户余额为0
//    [self.pay setTitle:pyBtnTitleZero forState:UIControlStateNormal];
    
    [self.btv mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.view.mas_top);
        make.left.equalTo(self.view.mas_left);
        make.bottom.equalTo(self.ppv.mas_top);
        make.right.equalTo(self.view.mas_right);
        make.height.equalTo(@50);
        make.width.equalTo(@(Screen_Width));
    }];

    [self.ppv mas_makeConstraints:^(MASConstraintMaker *make) {
        make.width.equalTo(@(Screen_Width));
        make.left.equalTo(self.view.mas_left);
        make.right.equalTo(self.view.mas_right);
        make.bottom.equalTo(self.backTosc.mas_top);
    }];
    CGFloat heightBB = 50;
    [self.backTosc mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.ppv.mas_bottom);
        make.left.equalTo(self.view.mas_left);
        make.bottom.equalTo(self.view.mas_bottom);
        make.height.equalTo(@(heightBB));
        make.width.equalTo(@(Screen_Width / 2));
    }];
    [self.pay mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.equalTo(self.view.mas_right);
        make.width.equalTo(@(Screen_Width / 2 + 1));
        make.top.equalTo(self.backTosc.mas_top);
        make.bottom.equalTo(self.backTosc.mas_bottom);
    }];
    
    self.ppv.fullMinusView.tableView.dataSource = self;
    self.ppv.fullMinusView.tableView.delegate = self;
    [self.ppv.fullMinusView.tableView registerNib:[UINib nibWithNibName:fullminusCell bundle:nil] forCellReuseIdentifier:fullminusCell];
    
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(juanClickNotification:) name:ECRFullminusJuanViewClickNotification object:nil];
}
- (void)juanClickNotification:(NSNotification *)notification{
    NSDictionary *userInfo = notification.userInfo;
    ECRFullminusModel *model = userInfo[@"model"];
        for (NSInteger i = 0; i < self.allJuan.count; i++) {
            ECRFullminusModel *modelInArray = self.allJuan[i];
            if (modelInArray == model) {
                modelInArray.isSelected = YES;
            }else{
                modelInArray.isSelected = NO;
            }
        }
    self.tickedPrice = self.oriPrice - model.minusMoney.floatValue;
    [self.ppv.fullMinusView.tableView reloadData];
}

- (ECRBookFormTopView *)btv{
    if (_btv == nil) {
        _btv = [[ECRBookFormTopView alloc] init];
    }
    return _btv;
}
- (ECRPaymentPreviousView *)ppv{
    if (_ppv == nil) {
        _ppv = [[ECRPaymentPreviousView alloc] init];
        
    }
    return _ppv;
}
- (UIButton *)backTosc{
    if (_backTosc == nil) {
        _backTosc = [[UIButton alloc] init];
        _backTosc.layer.borderWidth = 1;
        _backTosc.layer.borderColor = self.bbBtnBorderColor.CGColor;
        [_backTosc setTitle:btBtnTitle forState:UIControlStateNormal];
        [_backTosc setTitleColor:[UIColor cm_mainColor] forState:UIControlStateNormal];
        [_backTosc.titleLabel setFont:[UIFont systemFontOfSize:14]];
        [_backTosc setBackgroundColor:[UIColor whiteColor]];
        [_backTosc addTarget:self action:@selector(backClick:) forControlEvents:UIControlEventTouchUpInside];
    }
    return _backTosc;
}
- (UIButton *)pay{
    if (_pay == nil) {
        _pay = [[UIButton alloc] init];
        _pay.layer.borderWidth = 1;
        _pay.layer.borderColor = self.bbBtnBorderColor.CGColor;
        [_pay setTitle:pyBtnTitle forState:UIControlStateNormal];
        [_pay setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        [_pay.titleLabel setFont:[UIFont systemFontOfSize:14]];
        [_pay setBackgroundColor:[UIColor cm_mainColor]];
        [_pay addTarget:self action:@selector(payClick:) forControlEvents:UIControlEventTouchUpInside];
    }
    return _pay;
}
- (UIColor *)bbBtnBorderColor{
    if (_bbBtnBorderColor == nil) {
        _bbBtnBorderColor = [UIColor cm_lineColor_D9D7D7_1];
    }
    return _bbBtnBorderColor;
}
- (CGFloat)oriPrice{
    if (_oriPrice == 0) {
        _oriPrice = 0;
        for (NSInteger i = 0; i < self.tickedArray.count; ++i) {
            ECRShoppingCarModel *model = self.tickedArray[i];
            model.isTick = YES;
            _oriPrice += model.price;
        }
    }
    return _oriPrice;
}
- (void)dealloc{
    for (NSInteger i = 0; i < self.allJuan.count; i++) {
        ECRFullminusModel *modelInArray = self.allJuan[i];
        if (modelInArray.isAva) {
            modelInArray.isSelected = NO;
        }
    }
}

@end




