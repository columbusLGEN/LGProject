//
//  ECRDataHandler.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/4.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "ECRDataHandler.h"
#import "ECRHTTPSessionManager.h"
#import "ECRResObjc.h"
#import "ECRHomeMainModel.h"
#import "ECRBookInfoModel.h"
#import "BookModel.h"
#import "ECRSubjectRowModel.h"

#import "ECRFullminusModel.h"

@interface ECRDataHandler ()

@end

@implementation ECRDataHandler

// TODO: 对 return json 进行统一处理

// MARK: 管理书架
- (void)bookShelfManagementWithType:(NSInteger)type bookIds:(id)bookIds groupIds:(id)groupIds groupName:(NSString *)groupName success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
    param[@"bookId"] = bookIds;
    param[@"groupId"] = groupIds;
    param[@"groupName"] = groupName;
    param[@"userId"] = [self bookshelfTestId];// 书架用1测试
    [self commonGetDataWithInterface:@"bookshelf/bookShelfManagement" param:param success:^(id responseObject) {
        if (success) {
            NSLog(@"responseobject -- %@",responseObject);
            success(responseObject);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 修改分组名
- (void)bookShelfWithGroupId:(NSInteger)groupId groupName:(NSString *)groupName success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
    param[@"groupId"] = [NSString stringWithFormat:@"%ld",groupId];
    param[@"groupName"] = groupName;
    param[@"userId"] = [self bookshelfTestId];// 书架用1测试
    [self commonGetDataWithInterface:@"bookshelf/updatebookShelfGroupName" param:param success:^(id responseObject) {
        if (success) {
//            NSLog(@"responseobject -- %@",responseObject);
            success(responseObject);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 书架全部图书
- (void)bookShelfWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    param[@"userId"] = [self bookshelfTestId];// 书架用1测试
    [self commonGetDataWithInterface:@"bookshelf/bookShelf" param:param success:^(id responseObject) {
        if (success) {
            success(responseObject);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 查询用户所有满减卷
- (void)fullminusListWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    param[@"userId"] = [self userId];
    // shoppingcart/shoppingCart
    [self commonGetDataWithInterface:@"cardCouponsInfo/getUserFullminusCard" param:param success:^(id responseObject) {
        NSArray *arr = responseObject;
        NSMutableArray *arrm = [NSMutableArray arrayWithCapacity:10];
        [arr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            ECRFullminusModel *model = [ECRFullminusModel mj_objectWithKeyValues:obj];
            [arrm addObject:model];
        }];
        if (success) {
            success(arrm.copy);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 专题
// 该方法仅用于 iPad 显示两列时请求，如果正常显示1列，使用下面的方法
- (void)subjectDataWithSpecial:(id)special series:(id)series classify:(id)classify length:(NSInteger)length page:(NSUInteger)page sort:(NSInteger)sort success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    //    param[@"userId"] = [self userId];
    param[@"special"] = [self parameterWithParameter:special];
    param[@"series"] = [self parameterWithParameter:series];
    param[@"classify"] = [self parameterWithParameter:classify];
    
    param[@"length"] = [NSString stringWithFormat:@"%ld",length];
    param[@"page"] = [NSString stringWithFormat:@"%ld",page];
    param[@"sort"] = [NSString stringWithFormat:@"%ld",sort];
    //    NSLog(@"rgparam -- %@",param);
    [self commonGetDataWithInterface:@"books/books" param:param success:^(id responseObject) {
        NSArray *arr = responseObject;
        NSArray *deArr = [[ECRMultiObject sharedInstance] doubleArrayWithOriginArray:arr rowKey:@"subjectArray"];
//        NSLog(@"dearr -- %@",deArr);
        NSMutableArray *arrm = [NSMutableArray arrayWithCapacity:10];
        [deArr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            ECRSubjectRowModel *rowModel = [ECRSubjectRowModel mj_objectWithKeyValues:obj];
            [arrm addObject:rowModel];
        }];
        
        if (success) {
            success(arrm.copy);
        }
    } failure:failure commenFailure:commenFailure];
}
// MARK: 管理购物车
- (void)manageShopCarDataWithDict:(NSDictionary *)dict success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithDictionary:dict];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    param[@"userId"] = [self userId];
    NSLog(@"param -- %@",param);
    [self commonGetDataWithInterface:@"shoppingcart/shoppingCartManagement" param:param success:^(id responseObject) {
        
        if (success) {
            success(responseObject);
        }
    } failure:failure commenFailure:commenFailure];
}
// MARK: 购物车列表
- (void)shopCarDataWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    param[@"userId"] = [self userId];
    // shoppingcart/shoppingCart
    [self commonGetDataWithInterface:@"shoppingcart/shoppingCart" param:param success:^(id responseObject) {
        
        if (success) {
            success(responseObject);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 满减卷

// MARK: 图书分类list
- (void)bmListDataWithSpecial:(id)special series:(id)series classify:(id)classify length:(NSInteger)length page:(NSUInteger)page sort:(NSInteger)sort success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
//    param[@"userId"] = [self userId];
    param[@"special"] = [self parameterWithParameter:special];
    param[@"series"] = [self parameterWithParameter:series];
    param[@"classify"] = [self parameterWithParameter:classify];
    
    param[@"length"] = [NSString stringWithFormat:@"%ld",length];
    param[@"page"] = [NSString stringWithFormat:@"%ld",page];
    param[@"sort"] = [NSString stringWithFormat:@"%ld",sort];
//    NSLog(@"rgparam -- %@",param);
    [self commonGetDataWithInterface:@"books/books" param:param success:^(id responseObject) {
        NSArray *arr = responseObject;
        NSMutableArray *arrm = [NSMutableArray arrayWithCapacity:10];
        [arr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
//            NSLog(@"keyvalues -- %@",obj);
            BookModel *book = [BookModel mj_objectWithKeyValues:obj];
//            NSLog(@"model -- %@ -- %@ -- %@",book,[book class],book.bookName);
            [arrm addObject:book];
        }];
        if (success) {
            success(arrm.copy);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 图书分类
- (void)bmDataWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    [self commonGetDataWithInterface:@"books/classifyBook" param:param success:^(id responseObject) {
        
        if (success) {
            success([responseObject firstObject]);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 书籍详情请求
- (void)biDataWithBookId:(NSInteger)bookId success:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    param[@"bookId"] = [NSString stringWithFormat:@"%ld",bookId];
    param[@"userId"] = [self userId];
    //books/bookDetails
    [self commonGetDataWithInterface:@"books/bookDetails" param:param success:^(id responseObject) {
        ECRBookInfoModel *model = [ECRBookInfoModel mj_objectWithKeyValues:[responseObject firstObject]];
        if (success) {
            success(model);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 首页请求
- (void)homeDataWithSuccess:(ECRDataHandlerSuccess)success failure:(ECRDataHandlerFailure)failure commenFailure:(ECRDataHandlerCommenFailure)commenFailure{
    NSMutableDictionary *param = [NSMutableDictionary dictionaryWithCapacity:10];
//    param[@"imei"] = @"imei";
//    param[@"imsi"] = @"imsi";
    [self commonGetDataWithInterface:@"books/index" param:param success:^(id responseObject) {
        ECRHomeMainModel *homeModel = [ECRHomeMainModel mj_objectWithKeyValues:[responseObject firstObject]];
        if (success) {
            success(homeModel);
        }
    } failure:failure commenFailure:commenFailure];
}

// MARK: 通用请求
- (void)commonGetDataWithInterface:(NSString *)interface param:(id)param success:(void(^)(id responseObject))success failure:(ECRDataHandlerFailure)failure commenFailure:(void (^)(NSError *error))commenFailure{
    param[@"imei"] = @"imei";
    param[@"imsi"] = @"imsi";
    NSMutableDictionary *parameters = [NSMutableDictionary dictionaryWithCapacity:10];
    parameters[@"params"] = param;
    parameters[@"md5"] = @"md5";// TODO: 参数加密 & md5
    
    [[ECRHTTPSessionManager sharedManager] POSTWithInterface:interface param:parameters success:^(id responseObject) {
        // 对请求的数据进行处理
        // TODO: 数据加解密
        NSString *msg = [responseObject objectForKey:@"msg"];
        NSNumber *result = [responseObject objectForKey:@"result"];
        NSLog(@"%@_msg -- %@",interface,msg);
        NSLog(@"%@_result -- %@",interface,result);
        if (result.integerValue == 0) {
            // returnJson string
            NSString *jsonString = [responseObject objectForKey:@"returnJson"];
            NSData *jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];
            id jsonObjc = [NSJSONSerialization JSONObjectWithData:jsonData options:NSJSONReadingMutableContainers error:nil];
            NSLog(@"%@_returnjson -- %@",interface,jsonString);
            if (success) {
                success(jsonObjc);
            }
        }else{
            // TODO: 显示 msg
//            if (failure) {
//                failure(msg);
//            }
        }
    } failure:^(NSError *error) {
        if (commenFailure) {
            commenFailure(error);
        }
    }];
    
}

- (NSString *)userId{
    // TODO: 获取 用户id
    return @"111";
}
// 书架 测试id
- (NSString *)bookshelfTestId{
    return @"1";
}

+ (instancetype)sharedDataHandler{
    static id instance;
    static dispatch_once_t once;
    dispatch_once(&once, ^{
        instance = [self new];
    });
    return instance;
}

- (id)parameterWithParameter:(id)parameter{
    return parameter ? parameter:@"";
}

@end
