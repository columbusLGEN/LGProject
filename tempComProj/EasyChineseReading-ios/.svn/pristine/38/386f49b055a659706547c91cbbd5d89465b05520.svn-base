//
//  ECRBookrackView.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/5.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "ECRBookrackView.h"
#import "ECRSwichView.h"
#import "ECRBookrackFlowLayout.h"
//#import "ECRBaseCollectionFlowLayout.h"

@interface ECRBookrackView ()<
ECRSwichViewDelegate,
UICollectionViewDelegate
>

@property (strong,nonatomic) ECRSwichView *swichView;//
@property (strong,nonatomic) UIScrollView *firstFloor;// 容器

@property (strong,nonatomic) UILongPressGestureRecognizer *longPress;
//@property (strong,nonatomic) ECRBaseCollectionFlowLayout *;// 全部图书layout
@property (strong,nonatomic) ECRBookrackFlowLayout *abLayout;// 全部图书layout
@property (strong,nonatomic) ECRBookrackFlowLayout *brLayout;// 已购买layout

@end

@implementation ECRBookrackView

#pragma mark - 全局变量
static NSString *reuserID = @"ECRBookrackCollectionViewCell";
static CGFloat svH = 58;// swich view height
static CGFloat margin = 10;
//static CGFloat bookSpace = 40;
//static CGFloat navH = 0;// 64 -> 0

#pragma mark - ECRSwichViewDelegate
- (void)ecrSwichView:(ECRSwichView *)view didClick:(NSInteger)click{
    switch (click) {
        case 0:{// 左
            [self.firstFloor setContentOffset:CGPointZero animated:YES];
        }
            break;
            
        case 1:{
            [self.firstFloor setContentOffset:CGPointMake(Screen_Width, 0) animated:YES];
        }
            break;
    }
}

#pragma mark - collection view delegate
- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath{
    if ([self.delegate respondsToSelector:@selector(brView:didSelectBookrack:indexPath:)]) {
        [self.delegate brView:self didSelectBookrack:collectionView indexPath:indexPath];
    }
}

#pragma mark - 业务逻辑
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if ([scrollView isEqual:_bookrack] || [scrollView isEqual:_allOfBooks]) {
        // Y的偏移量
        CGFloat offsetY = scrollView.contentOffset.y + 10;
        // 平移差值
        CGFloat dValue  = svH - offsetY;
        
        if (dValue < 0) {
            dValue = 0;
        }
//        NSLog(@"%f",offsetY);
//        NSLog(@"%f",dValue);
        
        if (offsetY > 0) {
            if (dValue >= 0) {
                // 平移
                self.swichView.transform = CGAffineTransformMakeTranslation(0, -offsetY);
                [self.firstFloor mas_remakeConstraints:^(MASConstraintMaker *make) {
                    make.top    .equalTo(self.mas_top).offset(dValue);
                    make.left   .equalTo(self.mas_left);
                    make.bottom .equalTo(self.mas_bottom).offset(-49);
                    make.right  .equalTo(self.mas_right);

                }];
            }
        }else{
            // 恢复
            self.swichView.transform = CGAffineTransformIdentity;
            [self.firstFloor mas_remakeConstraints:^(MASConstraintMaker *make) {
                make.top    .equalTo(self.swichView.mas_bottom);
                make.left   .equalTo(self       .mas_left);
                make.bottom .equalTo(self       .mas_bottom).offset(-49);
                make.right  .equalTo(self       .mas_right);
            }];
        }
    }else if([scrollView isEqual:_firstFloor]){// 左右滑动
        if (scrollView.contentOffset.x == 0) {
            [self.swichView switchSelectedItem:0];
            // 通知代理（控制器）/ 切换到了全部图书
            if ([self.delegate respondsToSelector:@selector(brViewDidSwitch:)]) {
                [self.delegate brViewDidSwitch:self];
            }
        }
        if (scrollView.contentOffset.x >= Screen_Width) {
            [self.swichView switchSelectedItem:1];
        }

    }else{
        
    }
}

#pragma mark - 初始化
- (instancetype)initWithFrame:(CGRect)frame flowLayout:(ECRBookrackFlowLayout *)flowLayout abLayout:(ECRBookrackFlowLayout *)abLayout{
    self.brLayout = flowLayout;// 该布局参数从控制器传入是为了设置其代理为控制器
    self.abLayout = abLayout;
    return [self initWithFrame:frame];
}

- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        self.backgroundColor = [UIColor whiteColor];
//        CGSize itemSize;
//        if (Screen_Width < 375) {
//            itemSize = CGSizeMake((Screen_Width - 2 * margin - bookSpace) / 3, 150);
//        }else if(Screen_Width == 375){
//            itemSize = CGSizeMake((Screen_Width - 2 * margin - 2 * bookSpace) / 3, 150);
//        }else{
//            itemSize = CGSizeMake((Screen_Width - 2 * margin - 2 * bookSpace) / 3, 180);
//        }
        
        // 全部图书列表布局参数

        _abLayout.itemSize;// 必须执行
        _abLayout.scrollDirection = UICollectionViewScrollDirectionVertical;
        _abLayout.minimumInteritemSpacing = 0;
        
        // 已购买布局参数
        _brLayout.itemSize;// 必须执行
        _brLayout.scrollDirection = UICollectionViewScrollDirectionVertical;
        _brLayout.minimumInteritemSpacing = 0;
        
        CGFloat swvHeight = 58;
        if (Screen_Width > 414) {
            swvHeight = 72;
        }
        _swichView  = [[ECRSwichView alloc] initWithFrame:CGRectZero height:swvHeight];
        _swichView.delegate = self;
        
        _firstFloor = [[UIScrollView alloc] init];
        _firstFloor.delegate = self;
        _firstFloor.pagingEnabled = YES;
        // MARK: 已购买(已经下载到本地的图书列表)
        _bookrack   = [[UICollectionView alloc] initWithFrame:CGRectZero collectionViewLayout:_brLayout];
        _bookrack.showsVerticalScrollIndicator = NO;
        //        _brLayout.flssDelegate =  self;
        //        _bookrack.dataSource      = self;
        _bookrack.delegate        = self;
        
        // MARK:全部图书, 从服务器获取数据,仅做显示,没有编辑功能
        _allOfBooks = [[UICollectionView alloc] initWithFrame:CGRectZero collectionViewLayout:_abLayout];
        _allOfBooks.showsVerticalScrollIndicator = NO;
        _allOfBooks.delegate = self;
        
        [self        addSubview:_swichView];
        [self        addSubview:_firstFloor];
        [_firstFloor addSubview:_allOfBooks];// 全部图书
        [_firstFloor addSubview:_bookrack];// 已购买
        
        // MAKR: 约束
        [_swichView  mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top    .equalTo(self       .mas_top).offset(v_u_offset_top);
            make.left   .equalTo(self       .mas_left);
            make.width  .equalTo(@(Screen_Width));
            make.height .equalTo(@(swvHeight));
        }];
        _swichView.buttonNames = @[@"全部图书",@"已购买"];
        [_firstFloor mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top    .equalTo(_swichView .mas_bottom);
            make.left   .equalTo(self       .mas_left);
            make.bottom .equalTo(self       .mas_bottom).offset(-49);
            make.right  .equalTo(self       .mas_right);
        }];
        CGFloat covW = Screen_Width;
        [_allOfBooks mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top    .equalTo(_firstFloor.mas_top);
            make.left   .equalTo(_firstFloor.mas_left);
            make.bottom .equalTo(_firstFloor.mas_bottom);
            make.right  .equalTo(_bookrack.mas_left);
            make.width  .equalTo(@(covW));
            make.height .equalTo(_firstFloor.mas_height);
        }];
        [_bookrack mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top    .equalTo(_firstFloor.mas_top);
//            make.left   .equalTo(_allOfBooks.mas_right);
            make.bottom .equalTo(_firstFloor.mas_bottom);
            make.right  .equalTo(_firstFloor.mas_right);
            make.width  .equalTo(@(covW));
            make.height .equalTo(_firstFloor.mas_height);
        }];
        UIEdgeInsets insets = UIEdgeInsetsMake(margin, margin, 0, margin);
        _allOfBooks.contentInset = insets;
        _bookrack.contentInset = insets;
        
        //        _firstFloor.backgroundColor = [UIColor redColor];
        _allOfBooks.backgroundColor = [UIColor whiteColor];
        _bookrack.backgroundColor = [UIColor whiteColor];
        
        // 注册 cell
        [_allOfBooks registerNib:[UINib nibWithNibName:reuserID bundle:nil] forCellWithReuseIdentifier:reuserID];
        [_bookrack registerNib:[UINib nibWithNibName:reuserID bundle:nil] forCellWithReuseIdentifier:reuserID];
    }
    return self;
}

@end
