//
//  ECRBookInfoViewController.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/9/11.
//  Copyright © 2017年 lee. All rights reserved.
//

//static CGFloat pjRowHeight = 70;
static NSString *pjCell = @"ECRDetailPJTableViewCell";
static NSString *pjCellPad = @"ECRDetailPJTableViewPadCell";

#import "ECRBookInfoViewController.h"
#import "ECRSwichView.h"
#import "ECRBookInfoModel.h"
#import "ECRBookInfoTableViewCell.h"
#import "ECRBiCommentModel.h"
#import "ECRDetailPJTableViewCell.h"
#import "ZStarView.h"
#import "ECRSettleAccountsController.h"
#import "ECRRentSeriousViewController.h"
#import "ECRShoppingCarViewController.h"
#import "ECRShoppingCarManager.h"
#import "ECRShoppingCarModel.h"
#import "ECRDataHandler.h"
#import "ECRScoreUserModel.h"
#import "ECRRowObject.h"
#import "ECRRequestFailuredView.h"
#import "ECRDetailPJTableViewPadCell.h"
#import "ECRRecoBook.h"
#import "ECREpubReader.h"
#import "ECRDownloadManager.h"
#import <YMEpubReaderKit/YMEpubReaderKit.h>
#import "ShareVC.h"

@interface ECRBookInfoViewController ()<
UITableViewDelegate,
UITableViewDataSource,
ECRSwichViewDelegate,
ECRRequestFailuredViewDelegate,
ECRBookInfoTableViewCellDelegate
>{
    CGFloat ssvH;// switchscrollview 的 height
}

@property (strong, nonatomic) IBOutlet UIScrollView *baseScrollView;
@property (strong, nonatomic) IBOutlet UIView *topInfoView;
@property (strong, nonatomic) IBOutlet UIScrollView *swithcScrollView;
@property (strong, nonatomic) IBOutlet UIView *buttonView;

@property (strong, nonatomic) IBOutlet ECRSwichView *diSwitchView;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *ssvHeight;// switchscrollview 高度约束
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *bitbHeight;// infotableview 高度约束
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *pjtbHeight;// pjtableview 高度约束

@property (weak, nonatomic) IBOutlet UIImageView *biCover;
@property (weak, nonatomic) IBOutlet UILabel *biName;
@property (weak, nonatomic) IBOutlet UILabel *biAuthor;
@property (weak, nonatomic) IBOutlet ZStarView *biStar;
@property (weak, nonatomic) IBOutlet UILabel *biPrice;
@property (weak, nonatomic) IBOutlet UILabel *biPriceSymbles;

@property (weak, nonatomic) IBOutlet UIView *biRectView;
@property (weak, nonatomic) IBOutlet UIView *biLine;
@property (weak, nonatomic) IBOutlet UIView *biLine2;
@property (weak, nonatomic) IBOutlet UIButton *buyButton;// 购买纸质书

@property (weak, nonatomic) IBOutlet UITableView *infoTableView;
@property (weak, nonatomic) IBOutlet UITableView *pjTableView;

@property (strong,nonatomic) ECRBookInfoModel *model;

@property (assign,nonatomic) CGFloat rHeight1;
@property (assign,nonatomic) CGFloat rHeight2;
@property (assign,nonatomic) CGFloat rHeight3;
@property (assign,nonatomic) CGFloat rHeight4;

@property (assign,nonatomic) CGFloat pjHeight;

@property (weak, nonatomic) IBOutlet UIButton *addTosc;// 加入购物车
@property (weak, nonatomic) IBOutlet UIButton *buyEbook;// 购买
@property (weak, nonatomic) IBOutlet UIButton *exper;// 试读
@property (weak, nonatomic) IBOutlet UIButton *setBao;// 系列包月
@property (strong,nonatomic) NSArray *comments;// 品论数据源

@property (strong,nonatomic) ECRRequestFailuredView *rrfv;// 请求失败 view

@property (strong,nonatomic) UIButton *like;//
@property (strong,nonatomic) MBProgressHUD *dlProgressHUD;/// download

@end

@implementation ECRBookInfoViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setupUI];
    
}
- (void)setBookId:(NSInteger)bookId{
    _bookId = bookId;
    [self loadNewDataWithBookId:bookId];
}
- (void)loadNewDataWithBookId:(NSInteger)bookId{
    [[ECRDataHandler sharedDataHandler] biDataWithBookId:bookId success:^(id object) {
        ECRBookInfoModel *model = (ECRBookInfoModel *)object;
        self.like.selected = model.collectionType;
        self.model = model;
        self.comments = model.scores;
        
//        // ipad 显示两列评价
//        if (model.scores.count != 0) {
//            if ([ECRMultiObject userInterfaceIdiomIsPad]) {
//                self.comments = [[ECRMultiObject sharedInstance] singleLineDoubleModelWithOriginArr:model.scores];
//            }else{
//            }
//        }
        
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            if (_rrfv != nil) {
                [_rrfv removeFromSuperview];
                _rrfv = nil;
            }
            // 基本信息
            [self.biCover sd_setImageWithURL:[NSURL URLWithString:model.iconUrl] placeholderImage:LGPlaceHolderImg];
            if ([LGPChangeLanguage currentLanguageIsEnglish]) {
                self.biName.text = model.en_bookName;
                self.biAuthor.text = model.en_author;
            }else{
                self.biName.text = model.bookName;
                self.biAuthor.text = model.author;
            }
            
            [self.biStar setScore:model.score withAnimation:YES completion:nil];
            self.biPrice.text = [NSString stringWithFormat:@"%.2f",model.price];
            [self.infoTableView reloadData];
            [self.pjTableView reloadData];
            
        }];
        
    } failure:^(NSString *msg) {
//        NSLog(@"msg -- %@",msg);
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    } commenFailure:^(NSError *error) {
        if (_rrfv == nil) {
            [self.view addSubview:self.rrfv];
        }
    }];
}

- (IBAction)buyEbookClick:(UIButton *)sender {
    // MARK: 购买电子书
    ECRSettleAccountsController *savc = [[ECRSettleAccountsController alloc] init];
    savc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:savc animated:YES];
    
}
// MARK: 试读
- (IBAction)experClick:(UIButton *)sender {
    
    if (self.model.academicProbationUrl == nil || [self.model.academicProbationUrl isEqualToString:@""]) {
        // 提示用户没有试读资源
        [self presentSuccessTips:LOCALIZATION(@"没有试读资源")];
    }else{
        // 1 获取下载链接
//        NSString *URLString = @"http://192.168.10.68:8080/BLCUPManageSystem/book/epub/9787561944882.epub";
        NSString *URLString = self.model.academicProbationUrl;
        // 2 创建本地存储链接 -- 将拼接链接的操作封装到 ECRDownloadManager 内部
        NSString *localFilePath = [ECRDownloadManager localURLWithBookId:self.model.bookId try:YES format:self.model.eBookFormat];
        
        // 3 判断本地存储链接是否存在,若存在直接打开,否则进行下载
            BOOL filePathIsExist = [ECRDownloadManager fileIsExist:localFilePath];
            if (filePathIsExist) {
                // 3.1 直接打开本地路径
                [[ECREpubReader sharedEpubReader] readBookWithPath:localFilePath fromController:self];
            }else{
                // 3.2.1 添加下载进度条
                self.dlProgressHUD = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
                [self.view addSubview:self.dlProgressHUD];
                self.dlProgressHUD.mode = MBProgressHUDModeAnnularDeterminate;
                self.dlProgressHUD.progress = 0.0;
        
                // 3.2.2 开始下载
                [ECRDownloadManager downloadWithURLString:URLString fileName:localFilePath progress:^(CGFloat progress, CGFloat total, CGFloat current) {
        //        NSLog(@"下载中 grogress -- %f",progress / 100);
                    [[NSOperationQueue mainQueue] addOperationWithBlock:^{
                        // 3.2.2.1 更新下载进度
                        self.dlProgressHUD.progress = progress / 100;
                    }];
                } success:^(NSString *localURL) {
                    // 3.2.2.2.1 隐藏下载进度条
                    [self.dlProgressHUD hideAnimated:YES];
        
                    // 3.2.2.2.2 打开本地路径
                    [[ECREpubReader sharedEpubReader] readBookWithPath:localURL fromController:self];
                } failure:^(NSError *error) {
                    // 3.2.2.3 下载失败回调
                    [self presentSuccessTips:LOCALIZATION(@"下载失败,请稍后重试")];
        //            NSLog(@"下载失败 -- %@",error);
                }];
            }
    }
    
    // TODO: 调用接口, 将该书加入书架,
    
    // 封装该方法需要的参数
    // bookid
    // 试读或者正式字符串
    // 格式 -- epub,PDF,超媒体
    
}
// MARK: 系列包月
- (IBAction)setBaoClick:(UIButton *)sender {
    ECRRentSeriousViewController *rsvc = [[ECRRentSeriousViewController alloc] init];
    rsvc.model = self.model;
    rsvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:rsvc animated:YES];
    
}
- (IBAction)bookBuy:(UIButton *)sender {
    // MARK: 购买纸质书
    
}
#pragma mark - ECRRequestFailuredViewDelegate 错误请求代理
- (void)rfViewReloadData:(ECRRequestFailuredView *)view{
    [self loadNewDataWithBookId:self.bookId];
}

#pragma mark - ECRBookInfoTableViewCellDelegate
// MARK: 跳转至推荐书籍
- (void)bitbrecoBookClick:(ECRBookInfoTableViewCell *)cell model:(ECRRecoBook *)model{
    UIStoryboard *board = [UIStoryboard storyboardWithName:@"BookInfo" bundle:nil];
    ECRBookInfoViewController *bivc = [board instantiateViewControllerWithIdentifier:@"ECRBookInfoViewController"];
    bivc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    bivc.bookId = model.bookId;
    [self.navigationController pushViewController:bivc animated:YES];
}
- (void)bitbnrcaFold:(ECRBookInfoTableViewCell *)cell{
    [self.infoTableView reloadData];
}

#pragma mark - delegate
- (void)ecrSwichView:(ECRSwichView *)view didClick:(NSInteger)click{
    switch (click) {
        case 0:
            [self.swithcScrollView setContentOffset:CGPointZero animated:YES];
            break;
        case 1:
            [self.swithcScrollView setContentOffset:CGPointMake(Screen_Width, 0) animated:YES];
            break;
    }
}
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if ([scrollView isEqual:self.swithcScrollView]) {
        if (scrollView.contentOffset.x == 0) {
            // MARK: ssv height
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
//            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            [self.diSwitchView switchSelectedItem:0];
            
        }
        if (scrollView.contentOffset.x >= Screen_Width) {
//            NSLog(@"pjh---%f",_pjHeight);
            self.ssvHeight.constant = _pjHeight;// pjTableView的高度
            [self.diSwitchView switchSelectedItem:1];

        }
    }
}
#pragma mark - data source
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if ([tableView isEqual:self.infoTableView]) {
        return 4;
    }
    return _comments.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
//        NSLog(@"%@",indexPath);
        cell.model = self.model;
        cell.delegate = self;
        return cell;
    }
    ECRDetailPJTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCell];
    ECRScoreUserModel *model = _comments[indexPath.row];
    cell.model = model;
    return cell;
//    if (![ECRMultiObject userInterfaceIdiomIsPad]) {
//    }else{
//        ECRDetailPJTableViewPadCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCellPad];
//        ECRRowObject *rowModel = _comments[indexPath.row];
//        cell.rowModel = rowModel;
//        return cell;
//
//    }
    
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if ([tableView isEqual:self.infoTableView]) {
        // MARK: ssv height
        ECRBookInfoTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[ECRBookInfoTableViewCell gainReuseID:indexPath]];
        cell.indx = indexPath;
        cell.model = self.model;
        
        if (indexPath.row == 0) {
            _rHeight1 = cell.rHeight1;
        }
        if (indexPath.row == 1) {
            _rHeight2 = cell.rHeight2;
        }
        if (indexPath.row == 2) {
            _rHeight3 = cell.rHeight3;
        }
        if (indexPath.row == 3) {// 如何获取总高度?
            _rHeight4 = cell.rHeight4;
            self.ssvHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
            self.bitbHeight.constant = _rHeight1 + _rHeight2 +_rHeight3 +_rHeight4;
        }
        return cell.rHeight;
    }
    CGFloat pjRowHeight;
    ECRDetailPJTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCell];
    pjRowHeight = cell.cellHeight;
//    if ([ECRMultiObject userInterfaceIdiomIsPad]) {
//        ECRDetailPJTableViewPadCell *cell = [tableView dequeueReusableCellWithIdentifier:pjCellPad];
//        pjRowHeight = cell.cellHeight;
//    }else{
//    }
    if (indexPath.row == (_comments.count - 1)) {
        _pjHeight = pjRowHeight * (_comments.count);
        self.pjtbHeight.constant = _pjHeight;
        NSLog(@"pjtbHeight -- %f",self.pjtbHeight.constant);
    }
//    NSLog(@"swithcScrollView.contentSize -- heightForrow %@",NSStringFromCGSize(self.swithcScrollView.contentSize));
    return pjRowHeight;
}

- (void)textDependsLauguage{
    NSString *bookInfo = [LGPChangeLanguage localizedStringForKey:@"图书详情"];
    NSString *bookReview = [LGPChangeLanguage localizedStringForKey:@"评价"];
    self.title = bookInfo;
    _diSwitchView.buttonNames = @[bookInfo,bookReview];
    
    [self setBtnLocaText:self.addTosc titleKey:@"加入购物车"];
    [self setBtnLocaText:self.buyEbook titleKey:@"购买"];
    [self setBtnLocaText:self.exper titleKey:@"试读"];
    [self setBtnLocaText:self.setBao titleKey:@"系列包月"];
    [self setBtnLocaText:self.buyButton titleKey:@"购买纸书"];

}
- (void)setBtnLocaText:(UIButton *)button titleKey:(NSString *)titleKey{
    [button setTitle:[LGPChangeLanguage localizedStringForKey:titleKey] forState:UIControlStateNormal];
}

#pragma mark - UI
- (void)setupUI{
    [self textDependsLauguage];
    [self setNavRightCustemView];
    [self.swithcScrollView setContentSize:CGSizeMake(Screen_Width, 0)];
    self.swithcScrollView.pagingEnabled = YES;
    self.infoTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.swithcScrollView.directionalLockEnabled = NO;
    _diSwitchView.delegate = self;
    
    self.pjTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.pjTableView registerNib:[UINib nibWithNibName:pjCell bundle:nil] forCellReuseIdentifier:pjCell];
//    if ([ECRMultiObject userInterfaceIdiomIsPad]) {
////        ECRDetailPJTableViewPadCell
//        [self.pjTableView registerNib:[UINib nibWithNibName:pjCellPad bundle:nil] forCellReuseIdentifier:pjCellPad];
//    }else{
//    }
    
    CGFloat borderW = 1;
    UIColor *borderColor = [UIColor cm_mainColor];
    self.addTosc.layer.borderWidth = borderW;
    self.addTosc.layer.borderColor = borderColor.CGColor;
    self.buyEbook.layer.borderWidth = borderW;
    self.exper.layer.borderWidth = borderW;
    self.setBao.layer.borderWidth = borderW;
    self.buyEbook.layer.borderColor = borderColor.CGColor;
    self.exper.layer.borderColor = borderColor.CGColor;
    self.setBao.layer.borderColor = borderColor.CGColor;
    
    [self.buyEbook setBackgroundColor:[UIColor cm_mainColor]];
    [self.buyEbook setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
    
}

// MARK: 加入购物车
- (IBAction)addToscClick:(UIButton *)sender {
    //    self.model.bookId;
    //    self.model.price;
    NSDictionary *dict = [NSDictionary dictionaryWithObjectsAndKeys:
                          [NSString stringWithFormat:@"%ld",self.model.bookId],@"bookId",
                          [NSString stringWithFormat:@"%f",self.model.price],@"price",
                          @"1",@"type",
                          nil];
    [[ECRShoppingCarManager sharedInstance] manageShopCarWithDict:dict success:^(NSMutableArray *totalArray, NSMutableArray *tickedArray, CGFloat priceT) {// TODO:
        // 加入购物车成功
        // 已经加入购物车
        [self presentSuccessTips:LOCALIZATION(@"加入购物车")];
    } failure:^(NSString *msg) {
        [self presentSuccessTips:LOCALIZATION(msg)];
    } commenFailure:^(NSError *error) {
        [self presentSuccessTips:LOCALIZATION(@"失败")];
    }];
}

#pragma mark - target
- (void)navLike:(UIButton *)sender{
    
    NSInteger typeCollect;
    NSString *showString;
    if (sender.selected) {
        // 取消收藏成功
        showString = LOCALIZATION(@"取消");
        typeCollect = 2;
    }else{
        // 收藏成功
        showString = LOCALIZATION(@"收藏成功");
        typeCollect = 1;
    }
    /// type 1.添加收藏,2.移除收藏
    [[ECRDataHandler sharedDataHandler] bookCollectWithBookId:self.model.bookId type:1 success:^(id object) {
//        NSLog(@"collection接口成功回调 -- %@",object);
        if (typeCollect == 1) {
            sender.selected = YES;
        }else{
            sender.selected = NO;
        }
        [self presentSuccessTips:showString];
    } failure:^(NSString *msg) {
        [self presentFailureTips:msg];
    } commenFailure:^(NSError *error) {
        [self presentFailureTips:@"网络连接错误"];
    }];
    
}
- (void)navShare:(UIButton *)sender{
    // MARK: 分享(站内信)
    ShareVC *share = [ShareVC loadFromNib];
    share.book = self.model;
    share.modalTransitionStyle = UIModalTransitionStyleCrossDissolve;
    share.modalPresentationStyle = UIModalPresentationOverCurrentContext;
    [self presentViewController:share animated:YES completion:nil];
    
}
- (void)navCar:(UIButton *)sender{
    // MARK: 跳转购物车
    ECRShoppingCarViewController *spvc = [[ECRShoppingCarViewController alloc] init];
    spvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:spvc animated:YES];
}

- (void)setNavRightCustemView{
    // 导航栏按钮s
    CGFloat bItemW = 28;
    CGFloat bItemY = -3;
    UIButton *like = [UIButton buttonWithType:UIButtonTypeCustom];
    [like setImage:[UIImage imageNamed:@"icon_unFavourite"] forState:UIControlStateNormal];
    [like setImage:[UIImage imageNamed:@"icon_favourited" ] forState:UIControlStateSelected];
    [like setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    self.like = like;
    UIBarButtonItem *navLike = [[UIBarButtonItem alloc] initWithCustomView:like];
    [like addTarget:self action:@selector(navLike:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *share = [UIButton buttonWithType:UIButtonTypeCustom];
    [share setImage:[UIImage imageNamed:@"icon_share"] forState:UIControlStateNormal];
    [share setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navShare = [[UIBarButtonItem alloc] initWithCustomView:share];
    [share addTarget:self action:@selector(navShare:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *car = [UIButton buttonWithType:UIButtonTypeCustom];
    [car setImage:[UIImage imageNamed:@"icon_shop_car_gray"] forState:UIControlStateNormal];
    [car setFrame:CGRectMake(0, bItemY, bItemW, bItemW)];
    UIBarButtonItem *navCar = [[UIBarButtonItem alloc] initWithCustomView:car];
    [car addTarget:self action:@selector(navCar:) forControlEvents:UIControlEventTouchUpInside];
    
    self.navigationItem.rightBarButtonItems = @[navCar,navShare,navLike];
    
}


#pragma mark - lazy load
- (ECRRequestFailuredView *)rrfv{
    if (_rrfv == nil) {
        _rrfv = [[ECRRequestFailuredView alloc] initWithFrame:self.view.bounds];
        _rrfv.delegate = self;
    }
    return _rrfv;
}

- (void)dealloc{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

@end
