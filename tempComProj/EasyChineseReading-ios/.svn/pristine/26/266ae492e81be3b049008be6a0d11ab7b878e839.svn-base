//
//  ECRRentSeriousViewController.m
//  EasyChineseReading-ios
//
//  Created by Peanut Lee on 2017/10/9.
//  Copyright © 2017年 retech. All rights reserved.
//

#import "ECRRentSeriousViewController.h"
#import "ECRRentReadController.h"
#import "ECRMoreBooksCell.h"
#import "ECRBookListModel.h"
#import "ECRBookInfoModel.h"

static CGFloat  listCellH = 150;// 图示列表cell高度
static NSString *cellID = @"ECRMoreBooksCell";

@interface ECRRentSeriousViewController ()<
UITableViewDelegate,
UITableViewDataSource
>
@property (weak, nonatomic) IBOutlet UITableView *tableView;
@property (weak, nonatomic) IBOutlet UIButton *doneButton;
@property (strong,nonatomic) NSArray *array;//
@property (assign,nonatomic) NSInteger requestLength;//
@property (assign,nonatomic) NSInteger requestPage;//

@end

@implementation ECRRentSeriousViewController

- (void)setModel:(ECRBookInfoModel *)model{
    _model = model;
    [self loadNewData];
    
}

- (void)textDependsLauguage{
    self.title = [LGPChangeLanguage localizedStringForKey:@"系列包月"];
    [self.doneButton setTitle:[LGPChangeLanguage localizedStringForKey:@"确定"] forState:UIControlStateNormal];
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self  setupUI];
}

- (void)loadNewData{
    self.requestPage = 0;
    [[ECRDataHandler sharedDataHandler] bmListDataWithSpecial:nil series:[NSString stringWithFormat:@"%ld",self.model.serialId] classify:nil length:self.requestLength page:self.requestPage sort:0 success:^(id object) {
        //        NSLog(@"bookarray -- %@",object);
        self.array = [NSMutableArray arrayWithArray:object];
        self.requestPage = self.array.count;
        NSLog(@"page_more -- %ld",self.requestPage);
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            [self.tableView.mj_header endRefreshing];
            [self.tableView reloadData];
        }];
        
    } failure:^(NSString *msg) {
        [self.tableView.mj_header endRefreshing];
    } commenFailure:^(NSError *error) {
        [self.tableView.mj_header endRefreshing];
    }];
}
- (void)loadMoreData{
    [[ECRDataHandler sharedDataHandler] bmListDataWithSpecial:nil series:[NSString stringWithFormat:@"%ld",self.model.serialId] classify:nil length:self.requestLength page:self.requestPage sort:0 success:^(id object) {
        [self.tableView.mj_footer endRefreshing];
        NSArray *arr = object;
        [self.array arrayByAddingObjectsFromArray:arr];
        self.requestPage += arr.count;
        NSLog(@"page_more -- %ld",self.requestPage);
        [[NSOperationQueue mainQueue] addOperationWithBlock:^{
            [self.tableView reloadData];
        }];
        
    } failure:^(NSString *msg) {
        [self.tableView.mj_footer endRefreshing];
    } commenFailure:^(NSError *error) {
        [self.tableView.mj_footer endRefreshing];
    }];
}

- (void)setupUI{
    [self textDependsLauguage];
    [self.tableView registerNib:[UINib nibWithNibName:cellID bundle:nil] forCellReuseIdentifier:cellID];
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    
    MJRefreshNormalHeader *header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(loadNewData)];
    self.tableView.mj_header = header;
    
    MJRefreshAutoNormalFooter *footer = [MJRefreshAutoNormalFooter footerWithRefreshingTarget:self refreshingAction:@selector(loadMoreData)];
    self.tableView.mj_footer = footer;
    
    self.tableView.estimatedRowHeight = 0;
    self.tableView.estimatedSectionHeaderHeight = 0;
    self.tableView.estimatedSectionFooterHeight = 0;
    
}


- (IBAction)doneButtonClick:(UIButton *)sender{
    ECRRentReadController *rrvc = [[ECRRentReadController alloc] init];
    rrvc.viewControllerPushWay = ECRBaseControllerPushWayPush;
    [self.navigationController pushViewController:rrvc animated:YES];
}

#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return _array.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ECRBookListModel *model = _array[indexPath.row];
    ECRMoreBooksCell *cell = [tableView dequeueReusableCellWithIdentifier:cellID];
    
    cell.model = model;
    return cell;
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return listCellH;
}
#pragma mark - UITableViewDelegate
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
}
- (NSInteger)requestLength{
    return 12;
}

@end
