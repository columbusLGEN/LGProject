//
//  UInfoVC.m
//  EasyChineseReading-ios
//
//  Created by 赵春阳 on 17/8/30.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "UserInfoVC.h"

#import "ZPickView.h"
#import "ZPickDateView.h"

#import "UserInfoAddressVC.h"

@interface UserInfoVC ()<UITextFieldDelegate, ZPickDateViewDelegate, ZPickViewDelegate>

@property (weak, nonatomic) IBOutlet UILabel *lblDescAvatar;
@property (weak, nonatomic) IBOutlet UILabel *lblDescName;
@property (weak, nonatomic) IBOutlet UILabel *lblDescLive;
@property (weak, nonatomic) IBOutlet UILabel *lblDescSex;
@property (weak, nonatomic) IBOutlet UILabel *lblDescLanguage;
@property (weak, nonatomic) IBOutlet UILabel *lblDescCountry;
@property (weak, nonatomic) IBOutlet UILabel *lblDesclearnyear;
@property (weak, nonatomic) IBOutlet UILabel *lblDescInsterest;
@property (weak, nonatomic) IBOutlet UILabel *lblDescBirthday;
@property (weak, nonatomic) IBOutlet UILabel *lblDescSchool;

@property (weak, nonatomic) IBOutlet UIImageView *imgAvatar;

@property (weak, nonatomic) IBOutlet UITextField *txtfName;
@property (weak, nonatomic) IBOutlet UITextField *txtfAddress;
@property (weak, nonatomic) IBOutlet UITextField *txtfInterest;
@property (weak, nonatomic) IBOutlet UITextField *txtSchool;

@property (weak, nonatomic) IBOutlet UILabel *lblSex;
@property (weak, nonatomic) IBOutlet UILabel *lblLanguage;
@property (weak, nonatomic) IBOutlet UILabel *lblCountry;
@property (weak, nonatomic) IBOutlet UILabel *lbllearnyear;
@property (weak, nonatomic) IBOutlet UILabel *lblBirthday;

@property (weak, nonatomic) IBOutlet UIButton *btnSave;

/** 性别 */
@property (strong, nonatomic) NSArray *arrSex;
/** 语言 */
@property (strong, nonatomic) NSArray *arrLanguage;
/** 学习年数 */
@property (strong, nonatomic) NSArray *arrLearnYear;

/** 性别选择 */
@property (strong, nonatomic) ZPickView *pickViewSex;

/** 母语选择 */
@property (nonatomic, strong) ZPickView *pickViewLanguage;

/** 学习年数选择 */
@property (nonatomic, strong) ZPickView *pickViewLearnYear;

/** 时间选择器 */
@property (strong, nonatomic) ZPickDateView *dateView;

/** 用户信息 */
@property (nonatomic, strong) UserModel *user;

/** table 偏移 */
@property (nonatomic, assign) CGFloat oldOffset;

@end

@implementation UserInfoVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self configUserInfoView];
    [self configUserInfoData];
    [self addNotification];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - 配置 用户信息界面

- (void)updateSystemLanguage
{
    self.title = LOCALIZATION(@"我的信息");
    
    _lblDescAvatar.text     = LOCALIZATION(@"头像");
    _lblDescName.text       = LOCALIZATION(@"昵称");
    _lblDescLive.text       = LOCALIZATION(@"居住地");
    _lblDescSex.text        = LOCALIZATION(@"性别");
    _lblDescLanguage.text   = LOCALIZATION(@"母语");
    _lblDescCountry.text    = LOCALIZATION(@"所在国家或地区");
    _lblDesclearnyear.text  = LOCALIZATION(@"学习汉语年数");
    _lblDescInsterest.text  = LOCALIZATION(@"兴趣爱好");
    _lblDescBirthday.text   = LOCALIZATION(@"生日");
    _lblDescSchool.text     = LOCALIZATION(@"学校名称");
    
    [_btnSave setTitle:LOCALIZATION(@"保存") forState:UIControlStateNormal];
}

- (void)configUserInfoView
{
    _imgAvatar.backgroundColor = [UIColor whiteColor];
    
    _imgAvatar.layer.borderColor = [UIColor whiteColor].CGColor;
    _imgAvatar.layer.borderWidth = 3.f;
    _imgAvatar.layer.cornerRadius = _imgAvatar.height/2;
    _imgAvatar.layer.masksToBounds = YES;
    
    _imgAvatar.layer.shadowColor = [UIColor blackColor].CGColor;
    _imgAvatar.layer.shadowOffset = CGSizeMake(0, 0);
    _imgAvatar.layer.shadowOpacity = 0.5f;
    
    _btnSave.layer.masksToBounds = YES;
    _btnSave.layer.cornerRadius = _btnSave.height/2;
    
    _txtfName.font      = [UIFont systemFontOfSize:16.f];
    _txtSchool.font     = [UIFont systemFontOfSize:16.f];
    _txtfAddress.font   = [UIFont systemFontOfSize:16.f];
    _txtfInterest.font  = [UIFont systemFontOfSize:16.f];
    
    _txtfName.textColor     = [UIColor cm_blackColor_666666_1];
    _txtSchool.textColor    = [UIColor cm_blackColor_666666_1];
    _txtfAddress.textColor  = [UIColor cm_blackColor_666666_1];
    _txtfInterest.textColor = [UIColor cm_blackColor_666666_1];
    
    _btnSave.backgroundColor = [UIColor cm_mainColor];
    [_btnSave setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
}

- (void)configUserInfoData
{
    _user = [[UserRequest sharedInstance].user copy];
    
    if (_user.name.length > 0) {
        _txtfName.text = _user.name;
    }
    else if (_user.phone.length > 0) {
        _txtfName.text = _user.phone;
    }
    else if (_user.email.length > 0) {
        _txtfName.text = _user.email;
    }
    
    [_imgAvatar sd_setImageWithURL:[NSURL URLWithString:_user.iconUrl] placeholderImage:[UIImage imageNamed:@"img_avatar_placeholder"]];
    
    _txtfAddress.text  = _user.address;
    _txtfInterest.text = _user.interest;
    _txtSchool.text    = _user.school;
    
    _lblSex.text        = [NSString stringWithFormat:@"%@", self.arrSex[_user.sex]];
    _lblLanguage.text   = [NSString stringWithFormat:@"%@", self.arrLanguage[_user.motherTongue]];
    _lblCountry.text    = [self getCountryWithCode:_user.country];
    _lbllearnyear.text  = [NSString stringWithFormat:@"%ld", _user.learnyear];
    _lblBirthday.text   = _user.birthday.length > 0 ? [_user.birthday substringToIndex:10] : @"";
}

- (void)addNotification
{
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(textFieldDidChanged:) name:UITextFieldTextDidChangeNotification object:nil];
}

#pragma mark - UIPickerView

/** 性别选择 */
- (void)configPickViewSex
{
    if (_pickViewSex == nil) {
        _pickViewSex = [[ZPickView alloc] initWithFrame:self.view.bounds dataSource:self.arrSex selected:0];
        _pickViewSex.delegates = self;
        [self.view addSubview:_pickViewSex];
    }
    [_pickViewSex show];
}

/** 母语选择 */
- (void)configPickViewLanguage
{
    if (_pickViewLanguage == nil) {
        _pickViewLanguage = [[ZPickView alloc] initWithFrame:self.view.bounds dataSource:self.arrLanguage selected:0];
        _pickViewLanguage.delegates = self;
        [self.view addSubview:_pickViewLanguage];
    }
    [_pickViewLanguage show];
}

/** 学习年限选择 */
- (void)configPickViewlearnyear
{
    if (_pickViewLearnYear == nil) {
        _pickViewLearnYear = [[ZPickView alloc] initWithFrame:self.view.bounds dataSource:self.arrLearnYear selected:0];
        _pickViewLearnYear.delegates = self;
        [self.view addSubview:_pickViewLearnYear];
    }
    [_pickViewLearnYear show];
}
/** 生日 */
- (void)configDateView
{
    if (_dateView == nil) {
        _dateView = [[ZPickDateView alloc] initWithFrame:self.view.bounds getAfterDate:NO selected:nil];
        _dateView.delegete = self;
        [self.view addSubview:_dateView];
    }
    [_dateView show];
}

#pragma mark -
#pragma mark UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [self resignAllFirstResponder];
    switch (indexPath.row) {
        case 0: [self camera];                  break;
        case 3: [self configPickViewSex];       break;
        case 4: [self configPickViewLanguage];  break;
        case 5: [self toSelectCountry];         break;
        case 6: [self configPickViewlearnyear]; break;
        case 9: [self seletcedBirthday];        break;
        default:                                break;
    }
}

- (void)tableView:(UITableView *)tableView willDisplayCell:(UITableViewCell *)cell forRowAtIndexPath:(NSIndexPath *)indexPath
{
    [cell setCellSeparatorInset:UIEdgeInsetsZero];
}

#pragma mark -
#pragma mark UITextFieldDelegate

- (void)textFieldDidChanged:(NSNotification *)notification
{
    UITextField *textField = notification.object;
    if ([textField isEqual: _txtfName]) {
        _user.name = textField.text;
    }
    else if ([textField isEqual: _txtfAddress]) {
        _user.address = textField.text;
    }
    else if ([textField isEqual:_txtfInterest]) {
        _user.interest = textField.text;
    }
    else if ([textField isEqual: _txtSchool]) {
        _user.school = textField.text;
    }
}

- (BOOL)textFieldShouldReturn:(UITextField *)textField
{
    [self resignAllFirstResponder];
    return YES;
}

#pragma mark - UIScrollViewDelegate

- (void)scrollViewDidScroll:(UIScrollView *)scrollView {
    
    if (scrollView.contentOffset.y < _oldOffset) {//如果当前位移大于缓存位移，说明scrollView向下滑动
        [self resignAllFirstResponder];
    }
    _oldOffset = scrollView.contentOffset.y;      //将当前位移变成缓存位移
}

- (void)resignAllFirstResponder
{
    if ([_txtfName isFirstResponder]) { [_txtfName resignFirstResponder]; }
    else if ([_txtSchool isFirstResponder]) { [_txtSchool resignFirstResponder]; }
    else if ([_txtfAddress isFirstResponder]) { [_txtfAddress resignFirstResponder]; }
    else if ([_txtfInterest isFirstResponder]) { [_txtfInterest resignFirstResponder]; }
}

#pragma mark -
#pragma mark ZPickDateViewDelegate

- (void)datePickerViewCancel:(ZPickDateView *)picker
{
    [picker hidden];
}

- (void)datePickerView:(ZPickDateView *)picker selectedDate:(NSDate *)aValue
{
    [picker hidden];
    NSString *strDate = [NSString stringWithFormat:@"%@", aValue];
    strDate = [strDate substringToIndex:10];
    _lblBirthday.text = strDate;
    _user.birthday = strDate;
}

#pragma mark -
#pragma mark ZPickViewDelegate

- (void)ZPickerViewCancel:(ZPickView *)picker;
{
    [picker hidden];
}
- (void)ZPickerView:(ZPickView *)picker makeSureIndex:(NSInteger)index
{
    if (picker == _pickViewSex) {
        _user.sex = index;
        _lblSex.text = _arrSex[index];
    }
    if (picker == _pickViewLanguage) {
        _user.motherTongue = index;
        _lblLanguage.text = _arrLanguage[index];
    }
    if (picker == _pickViewLearnYear) {
        _user.learnyear = index;
        NSNumber *num = _arrLearnYear[index];
        _lbllearnyear.text = [NSString stringWithFormat:@"%@", num];
    }
    [picker hidden];
}

#pragma mark -
#pragma mark action

/**
 点击保存
 */
- (IBAction)click_btnSave:(id)sender {
    [self saveUserInfo];
}

/**
 保存用户信息
 */
- (void)saveUserInfo {
    [[UserRequest sharedInstance] updateUserInfoWithName:_user.name
                                                 address:_user.address
                                                     sex:[NSString stringWithFormat:@"%ld", _user.sex]
                                                language:[NSString stringWithFormat:@"%ld", _user.motherTongue]
                                                 country:[NSString stringWithFormat:@"%ld", _user.country]
                                               learnyear:[NSString stringWithFormat:@"%ld", _user.learnyear]
                                                interest:_user.interest
                                                birthday:_user.birthday
                                                 iconUrl:_user.iconUrl
                                                  school:_user.school
                                              completion:^(id object, ErrorModel *error) {
                                                  if (error) {
                                                      [self presentFailureTips:error.message];
                                                  }
                                                  else {
                                                      [UserRequest sharedInstance].user = _user;
                                                      [[UserRequest sharedInstance] saveCache];
                                                      [self presentSuccessTips:LOCALIZATION(@"保存成功")];
                                                      [self.navigationController popViewControllerAnimated:YES];
                                                  }
                                              }];
}

/**
 选择国家
 */
- (void)toSelectCountry
{
    UserInfoAddressVC *addressVC = [[UserInfoAddressVC alloc] init];
    addressVC.language = [UserRequest sharedInstance].language;
    addressVC.selectedCountryBlock = ^(CountryModel * country){
        _user.country = country.id;
        _lblCountry.text = [self getCountryWithCode:_user.country];
    };
    [self.navigationController pushViewController:addressVC animated:YES];
}

/**
 选择生日
 */
- (void)seletcedBirthday
{
    [self configDateView];
}

#pragma mark -
#pragma mark 更换头像

/**
 拍照
 */
- (void)camera
{
    [self showAlertForSystemPhotoWithTitle:nil];
}

/**
 选择照片

 @param image 照片
 */
- (void)handleImgWith:(UIImage *)image
{
    // TODO: 上传图片未完成 完成后 完善上传图片接口
    
}

#pragma mark - 获取国家

- (NSString *)getCountryWithCode:(NSInteger)code
{
    NSArray *arrCountry = [[CacheDataSource sharedInstance] loadCacheWithCacheKey:CacheKey_CountryList];
    __block NSString *strCountry = @"";
    [arrCountry enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        CountryModel *country = [CountryModel mj_objectWithKeyValues:obj];
        if (country.id == code) {
            strCountry = [UserRequest sharedInstance].language == ENUM_LanguageTypeChinese ? country.zh_name : country.en_name;
            *stop = YES;
        }
    }];
    return strCountry;
}

#pragma mark -
#pragma mark 属性

- (NSArray *)arrSex
{
    if (_arrSex == nil) {
        _arrSex = @[LOCALIZATION(@"男"), LOCALIZATION(@"女")];
    }
    return _arrSex;
}

- (NSArray *)arrLanguage
{
    if (_arrLanguage == nil) {
        _arrLanguage = @[LOCALIZATION(@"中文"), LOCALIZATION(@"英文")];
    }
    return _arrLanguage;
}

- (NSArray *)arrLearnYear
{
    if (_arrLearnYear == nil) {
        NSMutableArray *array = [NSMutableArray array];
        for (NSInteger i = 0; i < 50; i ++) {
            [array addObject:@(i)];
        }
        _arrLearnYear = [NSMutableArray arrayWithArray:array];
    }
    return _arrLearnYear;
}

@end
