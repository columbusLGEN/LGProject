//
//  ECRHTTPSessionManager.m
//  EasyChineseReading-ios
//
//  Created by lee on 2017/8/31.
//  Copyright © 2017年 lee. All rights reserved.
//

#import "ECRHTTPSessionManager.h"

//#import "DES3Util.h"// des加密类
#import "NSString+TOPExtension.h"
#import "ErrorModel.h"

static CGFloat timeOutLimit = 3.0;//7.0;


@interface ECRHTTPSessionManager ()
@property (strong,nonatomic) AFHTTPSessionManager *afnSessionManager;//

/** URLSessionManager */
//@property (strong,nonatomic) AFURLSessionManager *URLSessionManager;
///** URLSessionManager configuration */
//@property (strong,nonatomic) NSURLSessionConfiguration *configuration;

@end

@implementation ECRHTTPSessionManager

// 1016
- (void)POSTWithInterface:(NSString *)interface param:(id)param success:(ECRLEHTTPSuccess)success failure:(ECRLEHTTPFailure)failure{
    
    NSString *urlString = [NSString stringWithFormat:@"%@/%@",AppServerBaseURL,interface];
    //    0：汉语
    //    1：英语
    BOOL isEn = [LGPChangeLanguage currentLanguageIsEnglish];

    NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration];
    config.timeoutIntervalForRequest = timeOutLimit;
    // 设置请求头x
    NSString *token = @"";//[UserRequest sharedInstance].token ? [UserRequest sharedInstance].token : @"";
    config.HTTPAdditionalHeaders = @{@"languageType":[NSString stringWithFormat:@"%d",isEn],
                                     @"token":token
                                     };
    AFURLSessionManager *sessionMgr = [[AFURLSessionManager alloc] initWithSessionConfiguration:config];

    NSMutableURLRequest *request = [[AFJSONRequestSerializer serializer] requestWithMethod:@"POST" URLString:urlString parameters:param error:nil];

    NSURLSessionDataTask *dataTask = [sessionMgr dataTaskWithRequest:request completionHandler:^(NSURLResponse *response, id responseObject, NSError *error) {
        if (error) {
            if (failure) {
                failure(error);
            }
        } else {
            if (success) {
                success(responseObject);
            }
        }
    }];
    [dataTask resume];

}

- (AFHTTPSessionManager *)afnSessionManager{
    if (_afnSessionManager == nil) {
        _afnSessionManager = [AFHTTPSessionManager manager];
        _afnSessionManager.securityPolicy.allowInvalidCertificates = YES; // not recommended for production
        // MARK: 设置反序列化格式
        _afnSessionManager.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@"application/json", @"text/json", @"text/javascript", @"text/html",@"text/plain",@"charset=utf-8", nil];
        _afnSessionManager.requestSerializer.timeoutInterval = timeOutLimit;
        
        // 设置请求头
        //        [_afnSessionManager.requestSerializer setValue:@"" forHTTPHeaderField:@""];
    }
    return _afnSessionManager;
}

NSString *methodName(ECRHTTPRequestMethod method){
    NSString *mName;
    switch (method) {
        case 0:
            mName = @"GET";
            break;
        case 1:
            mName = @"POST";
            break;
            
    }
    return mName;
}

+ (instancetype)sharedManager{
    static ECRHTTPSessionManager *instance;
    static dispatch_once_t once;
    dispatch_once(&once, ^{
        instance = [[ECRHTTPSessionManager alloc] init];
    });
    return instance;
}

@end
